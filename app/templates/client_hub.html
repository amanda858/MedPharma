<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>MedPharma Internal Hub</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --primary: #1e88e5;
      --primary-dark: #1565c0;
      --primary-darker: #0d47a1;
      --primary-light: #e3f2fd;
      --primary-mid: #90caf9;
      --success: #10b981;
      --success-light: #d1fae5;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --danger: #ef4444;
      --danger-light: #fee2e2;
      --info: #3b82f6;
      --info-light: #dbeafe;
      --purple: #8b5cf6;
      --purple-light: #ede9fe;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow: 0 1px 3px rgba(0, 0, 0, .08), 0 1px 2px rgba(0, 0, 0, .05);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, .08);
      --shadow-lg: 0 20px 50px rgba(0, 0, 0, .12);
      --accent: #1EDE8F;
      --accent-glow: rgba(30, 222, 143, .35);
      --dark: #050d1a;
      --dark-card: rgba(255, 255, 255, .06);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    body {
      font-family: 'DM Sans', system-ui, sans-serif;
      background: #f5f6fa;
      color: var(--gray-800);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       LOGIN ‚Äî Premium Split-Screen Medical Design (medpharmasc.com)
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    .login-wrap {
      min-height: 100vh;
      display: flex;
      position: relative;
      overflow: hidden;
      font-family: 'Inter', 'DM Sans', sans-serif;
      background: #051b2e;
    }

    /* Left panel ‚Äî hero showcase */
    .login-hero-panel {
      flex: 1.1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      background: linear-gradient(145deg, #051b2e 0%, #0a2a47 40%, #1D374F 100%);
      padding: 60px 48px;
      overflow: hidden;
    }

    .login-hero-panel::before {
      content: '';
      position: absolute;
      inset: 0;
      background:
        url('https://medpharmasc.com/wp-content/uploads/2024/11/blur-hospital-scaled.jpg') center/cover;
      opacity: 0.12;
    }

    .login-hero-panel::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(5, 27, 46, .6) 0%, rgba(5, 27, 46, .3) 50%, rgba(5, 27, 46, .7) 100%);
    }

    .login-hero-content {
      position: relative;
      z-index: 2;
      text-align: center;
      max-width: 480px;
    }

    .login-hero-logo {
      width: 340px;
      max-width: 85%;
      margin-bottom: 40px;
      filter: drop-shadow(0 8px 30px rgba(0, 0, 0, .4));
      border-radius: 8px;
    }

    .login-hero-tagline {
      font-size: 26px;
      font-weight: 800;
      color: #ffffff;
      line-height: 1.3;
      margin-bottom: 16px;
      letter-spacing: -0.5px;
    }

    .login-hero-tagline .gold {
      color: #FFCC53;
    }

    .login-hero-sub {
      font-size: 14px;
      color: rgba(255, 255, 255, .65);
      line-height: 1.7;
      margin-bottom: 36px;
    }



    .login-hero-site {
      margin-top: 40px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: rgba(255, 255, 255, .4);
      font-size: 12px;
    }

    .login-hero-site a {
      color: #FFCC53;
      text-decoration: none;
      font-weight: 600;
    }



    /* Right panel ‚Äî login form */
    .login-form-panel {
      flex: 0.9;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(170deg, #f8fafc 0%, #f0f4f8 100%);
      padding: 40px;
      position: relative;
    }

    .login-form-panel::before {
      content: '';
      position: absolute;
      top: -100px;
      right: -100px;
      width: 300px;
      height: 300px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255, 204, 83, .08), transparent 70%);
    }

    /* Subtle medical cross pattern */
    .login-bg {
      display: none;
    }

    .login-bg-overlay {
      display: none;
    }

    .login-grid-pattern {
      display: none;
    }

    .login-container {
      position: relative;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 420px;
      padding: 0;
      gap: 0;
    }

    /* Login card */
    .login-card-col {
      width: 100%;
      display: flex;
      align-items: center;
    }

    .login-card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      padding: 44px 40px;
      width: 100%;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 24px rgba(5, 27, 46, .08), 0 1px 3px rgba(0, 0, 0, .04);
    }

    .login-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #051b2e, #1D374F, #FFCC53);
    }

    .login-card-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-card-brand {
      font-size: 28px;
      font-weight: 800;
      color: #051b2e;
      letter-spacing: -1px;
      margin-bottom: 6px;
    }

    .login-card-brand .accent {
      color: #1D374F;
    }

    .login-card-title {
      font-size: 14px;
      color: #68747A;
      font-weight: 500;
      letter-spacing: .3px;
    }

    .login-card-secure {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #EEF6FA;
      border: 1px solid #c8dfe8;
      color: #1D374F;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 100px;
      margin-top: 12px;
    }

    .login-divider {
      height: 1px;
      background: #e2e8f0;
      margin: 0 0 28px;
    }

    .login-field {
      margin-bottom: 20px;
    }

    .login-field label {
      display: block;
      font-size: 11px;
      font-weight: 700;
      color: #68747A;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .login-field input {
      width: 100%;
      padding: 14px 16px;
      border: 1.5px solid #cbd5e1;
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
      outline: none;
      transition: border .2s, box-shadow .2s, background .2s;
      background: #f8fafc;
      color: #051b2e;
    }

    .login-field input::placeholder {
      color: #94a3b8;
    }

    .login-field input:focus {
      border-color: #1D374F;
      box-shadow: 0 0 0 3px rgba(29, 55, 79, .12);
      background: #fff;
    }

    .btn-login {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #051b2e, #1D374F);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: all .25s;
      letter-spacing: .3px;
      margin-top: 8px;
      position: relative;
      overflow: hidden;
    }

    .btn-login::after {
      display: none;
    }

    .btn-login:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(5, 27, 46, .3);
      background: linear-gradient(135deg, #1D374F, #051b2e);
    }

    .btn-login:active {
      transform: translateY(0);
    }

    .login-error {
      color: #dc2626;
      font-size: 13px;
      text-align: center;
      margin-top: 14px;
      padding: 10px;
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 10px;
      display: none;
    }

    .login-footer {
      text-align: center;
      margin-top: 28px;
      font-size: 12px;
      color: #94a3b8;
    }

    /* Hide feature cards, hero, trust bar on login */
    .login-hero {
      display: none;
    }

    .login-features-col {
      display: none;
    }

    .login-bottom {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      gap: 0;
    }

    .login-trust-bar {
      display: none;
    }

    /* Responsive login */
    @media (max-width: 900px) {
      .login-wrap {
        flex-direction: column;
      }

      .login-hero-panel {
        padding: 40px 24px 32px;
        flex: none;
      }



      .login-hero-tagline {
        font-size: 20px;
      }

      .login-hero-sub {
        margin-bottom: 0;
      }

      .login-form-panel {
        flex: 1;
        padding: 24px;
      }
    }

    @media (max-width: 540px) {
      .login-container {
        padding: 24px 16px;
      }

      .login-card {
        padding: 32px 24px;
        border-radius: 16px;
      }
    }

    /* ‚îÄ‚îÄ Account Selector ‚îÄ‚îÄ */
    .account-select-wrap {
      min-height: 100vh;
      background: #f5f6fa
    }

    .account-header {
      background: linear-gradient(135deg, #060b18, #0d47a1);
      padding: 28px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    .account-header .brand {
      display: flex;
      align-items: center;
      gap: 12px
    }

    .account-header .brand h1 {
      color: #fff;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -.5px
    }

    .account-header .brand span {
      background: rgba(255, 255, 255, .2);
      color: #fff;
      font-size: 11px;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 20px;
      letter-spacing: .5px
    }

    .account-body {
      max-width: 1100px;
      margin: 0 auto;
      padding: 48px 24px
    }

    .account-body h2 {
      font-size: 26px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 8px
    }

    .account-body p {
      color: var(--gray-500);
      font-size: 15px;
      margin-bottom: 36px
    }

    .account-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px
    }

    .account-card {
      background: #fff;
      border-radius: 16px;
      padding: 28px;
      cursor: pointer;
      box-shadow: var(--shadow);
      border: 2px solid transparent;
      transition: all .2s;
      display: flex;
      flex-direction: column;
      gap: 12px
    }

    .account-card:hover {
      border-color: var(--primary);
      box-shadow: 0 8px 30px rgba(99, 102, 241, .15);
      transform: translateY(-2px)
    }

    .account-card .ac-icon {
      width: 52px;
      height: 52px;
      background: linear-gradient(135deg, var(--primary-light), var(--primary-mid));
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px
    }

    .account-card .ac-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900)
    }

    .account-card .ac-contact {
      font-size: 13px;
      color: var(--gray-500)
    }

    .account-card .ac-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      font-weight: 600;
      color: var(--success);
      background: var(--success-light);
      padding: 3px 10px;
      border-radius: 20px;
      width: fit-content
    }

    /* ‚îÄ‚îÄ App Shell ‚îÄ‚îÄ */
    .app {
      display: none
    }

    .topbar {
      background: linear-gradient(135deg, #060b18 0%, #0d47a1 100%);
      color: #fff;
      height: 62px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 12px rgba(13, 71, 161, .5)
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 14px
    }

    .topbar-left .brand {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -.5px
    }

    .topbar-left .account-chip {
      background: rgba(255, 255, 255, .18);
      padding: 4px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background .2s;
      border: 1px solid rgba(255, 255, 255, .25)
    }

    .topbar-left .account-chip:hover {
      background: rgba(255, 255, 255, .28)
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px
    }

    .topbar-right .role-pill {
      background: rgba(255, 255, 255, .2);
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .5px
    }

    .btn-logout {
      background: rgba(255, 255, 255, .15);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, .3);
      padding: 6px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      font-weight: 500;
      transition: background .2s
    }

    .btn-logout:hover {
      background: rgba(255, 255, 255, .25)
    }

    /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
    .app-body {
      display: flex;
      min-height: calc(100vh - 62px)
    }

    .sidebar {
      width: 230px;
      background: #0a0f1e;
      border-right: none;
      padding: 20px 0;
      flex-shrink: 0;
      overflow-y: auto
    }

    .nav-section {
      font-size: 10px;
      font-weight: 700;
      color: rgba(255, 255, 255, .3);
      text-transform: uppercase;
      letter-spacing: 1.2px;
      padding: 18px 20px 8px;
      margin-top: 4px
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 18px 10px 16px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: rgba(255, 255, 255, .6);
      transition: all .15s;
      border-left: 3px solid transparent;
      border-radius: 0 8px 8px 0;
      margin: 1px 8px 1px 0
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, .07);
      color: #fff
    }

    .nav-item.active {
      color: #fff;
      background: rgba(30, 136, 229, .25);
      border-left-color: #1e88e5;
      font-weight: 600
    }

    .nav-item .ni {
      width: 20px;
      font-size: 15px;
      text-align: center;
      flex-shrink: 0
    }

    .main-content {
      flex: 1;
      padding: 28px;
      min-width: 0;
      overflow-x: hidden
    }

    /* ‚îÄ‚îÄ Panels ‚îÄ‚îÄ */
    .hub-panel {
      display: none
    }

    .hub-panel.active {
      display: block
    }

    /* ‚îÄ‚îÄ Page header ‚îÄ‚îÄ */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 12px
    }

    .page-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--gray-900);
      letter-spacing: -.3px
    }

    .page-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap
    }

    /* ‚îÄ‚îÄ KPI Cards ‚îÄ‚îÄ */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: 16px;
      margin-bottom: 24px
    }

    .kpi-card {
      background: #fff;
      border-radius: var(--radius);
      padding: 22px 20px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      border-top: 4px solid var(--primary)
    }

    .kpi-card.indigo {
      border-top-color: var(--primary)
    }

    .kpi-card.green {
      border-top-color: var(--success)
    }

    .kpi-card.amber {
      border-top-color: var(--warning)
    }

    .kpi-card.red {
      border-top-color: var(--danger)
    }

    .kpi-card.purple {
      border-top-color: var(--purple)
    }

    .kpi-card.blue {
      border-top-color: var(--info)
    }

    .kpi-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--gray-900);
      letter-spacing: -.5px;
      line-height: 1
    }

    .kpi-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--gray-400);
      text-transform: uppercase;
      letter-spacing: .6px;
      margin-top: 6px
    }

    .kpi-sub {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 4px
    }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card {
      background: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px;
      margin-bottom: 18px
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px
    }

    .card-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--gray-800)
    }

    /* ‚îÄ‚îÄ Tables ‚îÄ‚îÄ */
    .table-wrap {
      overflow-x: auto
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px
    }

    thead {
      background: var(--gray-50)
    }

    th {
      padding: 11px 14px;
      font-weight: 600;
      color: var(--gray-500);
      border-bottom: 2px solid var(--gray-200);
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: .5px;
      white-space: nowrap;
      text-align: left
    }

    td {
      padding: 12px 14px;
      border-bottom: 1px solid var(--gray-100);
      vertical-align: middle
    }

    tr:hover td {
      background: #fafbff
    }

    tr:last-child td {
      border-bottom: none
    }

    /* ‚îÄ‚îÄ Badges ‚îÄ‚îÄ */
    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .3px;
      white-space: nowrap
    }

    .badge-green,
    .badge-paid,
    .badge-active,
    .badge-approved,
    .badge-completed,
    .badge-live {
      background: var(--success-light);
      color: #065f46
    }

    .badge-amber,
    .badge-pending,
    .badge-in-review,
    .badge-draft,
    .badge-in-progress,
    .badge-not-started {
      background: var(--warning-light);
      color: #92400e
    }

    .badge-red,
    .badge-denied,
    .badge-rejected,
    .badge-overdue,
    .badge-failed,
    .badge-sla-breach {
      background: var(--danger-light);
      color: #991b1b
    }

    .badge-blue,
    .badge-submitted,
    .badge-billed,
    .badge-sent,
    .badge-in-process {
      background: var(--info-light);
      color: #1e40af
    }

    .badge-purple,
    .badge-appeal,
    .badge-credentialing {
      background: var(--purple-light);
      color: #5b21b6
    }

    .badge-indigo,
    .badge-ar-follow-up,
    .badge-intake,
    .badge-coding,
    .badge-verification {
      background: var(--primary-light);
      color: var(--primary-dark)
    }

    .badge-gray,
    .badge-inactive {
      background: var(--gray-100);
      color: var(--gray-600)
    }

    /* ‚îÄ‚îÄ Section Status Chart Strip ‚îÄ‚îÄ */
    .section-chart-strip {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 14px;
      padding: 0;
    }

    .section-chart-strip:empty {
      display: none
    }

    .status-pill {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      transition: all .2s ease;
      border: 2px solid transparent;
      min-width: 120px;
      flex: 1 1 0;
      position: relative;
      overflow: hidden;
    }

    .status-pill:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, .1)
    }

    .status-pill.active-filter {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light)
    }

    .status-pill .sp-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      border-radius: 0 0 8px 8px;
      transition: width .6s ease;
    }

    .sp-count {
      font-size: 22px;
      font-weight: 800;
      line-height: 1
    }

    .sp-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .4px;
      opacity: .85
    }

    .sp-pct {
      font-size: 10px;
      font-weight: 700;
      opacity: .7
    }

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .btn {
      padding: 9px 18px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all .15s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      letter-spacing: .1px
    }

    .btn-primary {
      background: var(--primary);
      color: #fff
    }

    .btn-primary:hover {
      background: var(--primary-dark)
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
      border: 1px solid var(--gray-200)
    }

    .btn-secondary:hover {
      background: var(--gray-200)
    }

    .btn-success {
      background: var(--success);
      color: #fff
    }

    .btn-danger-outline {
      background: #fff;
      color: var(--danger);
      border: 1px solid var(--gray-200)
    }

    .btn-danger-outline:hover {
      background: var(--danger-light);
      border-color: var(--danger)
    }

    .btn-sm {
      padding: 5px 12px;
      font-size: 12px
    }

    .btn:disabled {
      opacity: .45;
      cursor: not-allowed
    }

    .btn-icon {
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      font-size: 16px;
      color: var(--gray-400);
      border-radius: 6px;
      transition: all .15s
    }

    .btn-icon:hover {
      color: var(--gray-700);
      background: var(--gray-100)
    }

    /* ‚îÄ‚îÄ Form ‚îÄ‚îÄ */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 14px;
      margin-bottom: 16px
    }

    .form-full {
      grid-column: 1/-1
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px
    }

    .form-group label {
      font-size: 11px;
      font-weight: 600;
      color: var(--gray-600);
      text-transform: uppercase;
      letter-spacing: .5px
    }

    .form-control {
      padding: 9px 13px;
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-family: inherit;
      outline: none;
      transition: border .2s;
      background: #fff
    }

    .form-control:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light)
    }

    textarea.form-control {
      min-height: 72px;
      resize: vertical
    }

    select.form-control {
      cursor: pointer
    }

    /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(17, 24, 39, .55);
      z-index: 200;
      justify-content: center;
      align-items: flex-start;
      padding: 40px 16px;
      backdrop-filter: blur(3px)
    }

    .modal-overlay.open {
      display: flex
    }

    .modal {
      background: #fff;
      border-radius: 18px;
      padding: 32px;
      width: 720px;
      max-width: 96vw;
      max-height: 88vh;
      overflow-y: auto;
      box-shadow: 0 30px 80px rgba(0, 0, 0, .2)
    }

    .modal-sm {
      width: 480px
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px
    }

    .modal-header h2 {
      font-size: 20px;
      font-weight: 700;
      color: var(--gray-900)
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: var(--gray-400);
      line-height: 1;
      border-radius: 6px;
      padding: 0 4px
    }

    .modal-close:hover {
      color: var(--gray-700)
    }

    .modal-section {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--gray-100)
    }

    .modal-section-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: .6px;
      margin-bottom: 14px
    }

    /* ‚îÄ‚îÄ Claims Queue tabs ‚îÄ‚îÄ */
    .queue-tabs {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      background: #fff;
      padding: 8px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-100)
    }

    .qtab {
      padding: 7px 14px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all .15s;
      color: var(--gray-600);
      background: transparent;
      white-space: nowrap
    }

    .qtab:hover {
      background: var(--gray-100);
      color: var(--gray-800)
    }

    .qtab.active {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 2px 8px rgba(99, 102, 241, .35)
    }

    .qtab .cnt {
      background: rgba(255, 255, 255, .35);
      padding: 1px 7px;
      border-radius: 10px;
      margin-left: 5px;
      font-size: 11px
    }

    .qtab:not(.active) .cnt {
      background: var(--gray-200);
      color: var(--gray-600)
    }

    /* ‚îÄ‚îÄ Notes log ‚îÄ‚îÄ */
    .note-item {
      padding: 12px 14px;
      background: var(--gray-50);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      border-left: 3px solid var(--primary-mid)
    }

    .note-meta {
      font-size: 11px;
      color: var(--gray-400);
      margin-bottom: 4px;
      font-weight: 500
    }

    .note-text {
      font-size: 13px;
      color: var(--gray-700);
      line-height: 1.5
    }

    /* ‚îÄ‚îÄ Payments log ‚îÄ‚îÄ */
    .pay-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      background: var(--gray-50);
      border-radius: var(--radius-sm);
      margin-bottom: 6px
    }

    .pay-item .pay-left {
      display: flex;
      flex-direction: column;
      gap: 2px
    }

    .pay-item .pay-amount {
      font-size: 16px;
      font-weight: 700;
      color: var(--success)
    }

    .pay-item .pay-meta {
      font-size: 11px;
      color: var(--gray-400)
    }

    /* ‚îÄ‚îÄ Charts ‚îÄ‚îÄ */
    .bar-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 12px
    }

    .bar-row {
      display: flex;
      align-items: center;
      gap: 12px
    }

    .bar-lbl {
      width: 120px;
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-600);
      text-align: right;
      flex-shrink: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .bar-track {
      flex: 1;
      background: var(--gray-100);
      border-radius: 8px;
      height: 26px;
      position: relative;
      overflow: hidden
    }

    .bar-fill {
      height: 100%;
      border-radius: 8px;
      display: flex;
      align-items: center;
      padding: 0 10px;
      font-size: 11px;
      font-weight: 600;
      color: #fff;
      min-width: 40px;
      transition: width .6s ease
    }

    .bf-indigo {
      background: linear-gradient(90deg, var(--primary), #818cf8)
    }

    .bf-green {
      background: linear-gradient(90deg, var(--success), #34d399)
    }

    .bf-amber {
      background: linear-gradient(90deg, var(--warning), #fcd34d)
    }

    .bf-red {
      background: linear-gradient(90deg, var(--danger), #f87171)
    }

    .bf-purple {
      background: linear-gradient(90deg, var(--purple), #a78bfa)
    }

    .bf-blue {
      background: linear-gradient(90deg, var(--info), #60a5fa)
    }

    /* ‚îÄ‚îÄ Aging buckets ‚îÄ‚îÄ */
    .aging-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 12px
    }

    .aging-bucket {
      background: var(--gray-50);
      border-radius: var(--radius-sm);
      padding: 16px;
      text-align: center;
      border: 2px solid var(--gray-200)
    }

    .aging-bucket .ab-val {
      font-size: 20px;
      font-weight: 700;
      color: var(--gray-900)
    }

    .aging-bucket .ab-lbl {
      font-size: 11px;
      font-weight: 600;
      color: var(--gray-400);
      margin-top: 3px;
      text-transform: uppercase
    }

    .aging-bucket.danger {
      border-color: var(--danger);
      background: var(--danger-light)
    }

    .aging-bucket.danger .ab-val {
      color: var(--danger)
    }

    .aging-bucket.warning {
      border-color: var(--warning);
      background: var(--warning-light)
    }

    .aging-bucket.warning .ab-val {
      color: var(--warning)
    }

    /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 13px 20px;
      background: var(--gray-900);
      color: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
      z-index: 500;
      font-size: 14px;
      font-weight: 500;
      animation: toastIn .3s ease;
      max-width: 360px
    }

    .toast.success {
      background: var(--success)
    }

    .toast.error {
      background: var(--danger)
    }

    .toast.info {
      background: #1e88e5
    }

    .toast.warning {
      background: #f59e0b;
      color: #1a1a2e
    }

    @keyframes toastIn {
      from {
        transform: translateY(20px);
        opacity: 0
      }

      to {
        transform: translateY(0);
        opacity: 1
      }
    }

    /* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
    .empty-state {
      text-align: center;
      padding: 56px 24px;
      color: var(--gray-400)
    }

    .empty-state .es-icon {
      font-size: 40px;
      margin-bottom: 12px;
      opacity: .6
    }

    .empty-state p {
      font-size: 14px
    }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    /* ‚îÄ‚îÄ Hamburger button ‚îÄ‚îÄ */
    .hamburger {
      display: none;
      flex-direction: column;
      justify-content: center;
      gap: 5px;
      width: 44px;
      height: 44px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      background: rgba(255, 255, 255, .1);
      border: none;
      flex-shrink: 0
    }

    .hamburger span {
      display: block;
      height: 2px;
      background: #fff;
      border-radius: 2px;
      transition: all .25s
    }

    .hamburger.open span:nth-child(1) {
      transform: translateY(7px) rotate(45deg)
    }

    .hamburger.open span:nth-child(2) {
      opacity: 0
    }

    .hamburger.open span:nth-child(3) {
      transform: translateY(-7px) rotate(-45deg)
    }

    /* ‚îÄ‚îÄ Mobile sidebar overlay ‚îÄ‚îÄ */
    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .55);
      z-index: 149;
      backdrop-filter: blur(2px)
    }

    .sidebar-overlay.show {
      display: block
    }

    @media(max-width:768px) {

      /* Hamburger visible */
      .hamburger {
        display: flex
      }

      /* Sidebar becomes a drawer */
      .sidebar {
        position: fixed;
        top: 62px;
        left: 0;
        bottom: 0;
        z-index: 150;
        transform: translateX(-100%);
        transition: transform .28s cubic-bezier(.4, 0, .2, 1);
        width: 260px;
        box-shadow: 4px 0 24px rgba(0, 0, 0, .4)
      }

      .sidebar.mobile-open {
        transform: translateX(0)
      }

      /* Content takes full width */
      .app-body {
        flex-direction: column
      }

      .main-content {
        padding: 14px;
        width: 100%
      }

      /* Topbar adjustments */
      .topbar {
        padding: 0 14px
      }

      .topbar-left .brand {
        font-size: 17px
      }

      #topUser {
        display: none
      }

      /* Grids go single column on small phones */
      .kpi-grid {
        grid-template-columns: 1fr 1fr
      }

      .aging-grid {
        grid-template-columns: 1fr 1fr
      }

      .account-grid {
        grid-template-columns: 1fr
      }

      .form-grid {
        grid-template-columns: 1fr !important
      }

      /* Cards full width */
      .card {
        border-radius: 12px
      }

      /* Touch-friendly nav items */
      .nav-item {
        min-height: 48px;
        font-size: 14px
      }

      /* Page header stack */
      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px
      }

      .page-actions {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        gap: 8px
      }

      .page-actions .btn,
      .page-actions .form-control {
        width: 100%
      }

      /* Account header */
      .account-header {
        padding: 20px 16px
      }
    }

    @media(max-width:420px) {
      .kpi-grid {
        grid-template-columns: 1fr
      }

      .aging-grid {
        grid-template-columns: 1fr 1fr
      }

      .topbar-left .account-chip {
        display: none
      }
    }

    /* Search Dropdown */
    .search-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      z-index: 200;
      max-height: 420px;
      overflow-y: auto;
      margin-top: 4px;
    }

    .search-result-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--gray-100);
      transition: background .15s;
    }

    .search-result-item:hover {
      background: var(--primary-light);
    }

    .search-result-item .sr-type {
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .5px;
      padding: 2px 8px;
      border-radius: 4px;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .search-result-item .sr-type.claim {
      background: #dbeafe;
      color: #1e40af;
    }

    .search-result-item .sr-type.provider {
      background: #d1fae5;
      color: #065f46;
    }

    .search-result-item .sr-type.credentialing {
      background: #ede9fe;
      color: #5b21b6;
    }

    .search-result-item .sr-type.edi {
      background: #fee2e2;
      color: #991b1b;
    }

    .search-result-item .sr-title {
      font-weight: 600;
      font-size: 13px;
      color: var(--gray-800);
    }

    .search-result-item .sr-subtitle {
      font-size: 11px;
      color: var(--gray-500);
      margin-top: 1px;
    }

    /* Alert Cards */
    .alert-card {
      display: flex;
      gap: 16px;
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 10px;
      align-items: flex-start;
      border-left: 4px solid;
    }

    .alert-card.danger {
      background: #fef2f2;
      border-color: var(--danger);
    }

    .alert-card.warning {
      background: #fffbeb;
      border-color: var(--warning);
    }

    .alert-card.info {
      background: #eff6ff;
      border-color: var(--info);
    }

    .alert-card .alert-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .alert-card .alert-body {
      flex: 1;
    }

    .alert-card .alert-title {
      font-weight: 700;
      font-size: 14px;
      color: var(--gray-800);
    }

    .alert-card .alert-detail {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 2px;
    }
  </style>
</head>

<body>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="loginScreen">
    <div class="login-wrap">

      <!-- LEFT ‚Äî Hero / Brand Panel -->
      <div class="login-hero-panel">
        <div class="login-hero-content">
          <img src="https://medpharmasc.com/wp-content/uploads/2024/11/IMG_2392.png" alt="MedPharma"
            class="login-hero-logo">

          <div class="login-hero-tagline">
            Empowering Healthcare with <span class="gold">Strategic Solutions</span>
          </div>
          <div class="login-hero-sub">
            Your trusted partner in revenue cycle management, payor contracting, credentialing, and compliance auditing.
          </div>



          <div class="login-hero-site">
            üåê <a href="https://medpharmasc.com" target="blank">medpharmasc.com</a>
          </div>
        </div>
      </div>

      <!-- RIGHT ‚Äî Login Form -->
      <div class="login-form-panel">
        <div class="login-container">
          <div class="login-bottom">
            <div class="login-card-col">
              <div class="login-card">
                <div class="login-card-header">
                  <div class="login-card-brand">Med<span class="accent">Pharma</span></div>
                  <div class="login-card-title">Internal Client Hub</div>
                  <div class="login-card-secure">üîê Secure Sign In</div>
                </div>
                <div class="login-divider"></div>
                <div class="login-field">
                  <label>Username</label>
                  <input type="text" id="loginUser" placeholder="Enter username" autofocus autocomplete="username"
                    autocorrect="off" autocapitalize="none" spellcheck="false">
                </div>
                <div class="login-field">
                  <label>Password</label>
                  <div style="position:relative">
                    <input type="password" id="loginPass" placeholder="Enter password" autocomplete="current-password"
                      style="width:100%;padding-right:60px">
                    <button type="button" onclick="togglePw()" id="btnShowPw"
                      style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:linear-gradient(135deg,#EEF6FA,#dbeafe);border:1px solid #c8dfe8;border-radius:6px;cursor:pointer;color:#1D374F;font-size:11px;font-weight:700;padding:5px 10px;letter-spacing:.3px;transition:all .2s">SHOW</button>
                  </div>
                </div>
                <button class="btn-login" id="btnLogin" onclick="doLogin()">Sign In ‚Üí</button>
                <div class="login-error" id="loginError"></div>
                <div id="loginStatus"
                  style="text-align:center;font-size:13px;color:#94a3b8;margin-top:8px;display:none">
                  Connecting to server‚Ä¶</div>
                <div class="login-footer">MedPharma ¬© 2026 ¬∑ medpharmasc.com ¬∑ <span
                    style="color:#FFCC53;font-weight:700">v2.3</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ACCOUNT SELECTOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="accountSelect" style="display:none">
    <div class="account-header">
      <div class="brand">
        <h1>MedPharma</h1>
        <span>Internal Hub</span>
      </div>
      <button class="btn-logout" onclick="doLogout()">Sign Out</button>
    </div>
    <div class="account-body">
      <h2>Select an Account</h2>
      <p>Choose a client account to open the dashboard</p>
      <div style="margin-bottom:16px;text-align:right">
        <button class="btn btn-primary btn-sm" onclick="showNewClientFromSelector()"
          style="font-size:13px;padding:8px 18px">+ New Client</button>
      </div>
      <div class="account-grid" id="accountGrid"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP SHELL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="app" id="appShell">
    <div class="topbar">
      <div class="topbar-left">
        <button class="hamburger" id="hamburgerBtn" onclick="toggleMobileSidebar()" aria-label="Menu">
          <span></span><span></span><span></span>
        </button>
        <span class="brand">MedPharma</span>
        <span id="topInstanceBadge"
          style="display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:700;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;">
          Instance: --
        </span>
        <span class="account-chip" id="topAccount" onclick="switchAccount()">&#8629; Switch Account</span>
      </div>
      <!-- Global Search Bar -->
      <div class="topbar-search" style="flex:1;max-width:420px;margin:0 16px;position:relative">
        <input type="text" id="globalSearchInput" class="form-control"
          placeholder="üîç Search claims, providers, credentialing‚Ä¶"
          style="width:100%;padding:8px 14px;border-radius:20px;font-size:13px;border:1px solid var(--gray-200);background:var(--gray-50)"
          oninput="debounceGlobalSearch()" onkeydown="if(event.key==='Enter')runGlobalSearch()">
        <div id="searchDropdown" class="search-dropdown" style="display:none"></div>
      </div>
      <div class="topbar-right">
        <!-- Alerts Bell -->
        <button id="alertsBell" onclick="navTo('alerts')" title="Alerts & Notifications"
          style="position:relative;background:none;border:none;font-size:20px;cursor:pointer;padding:4px 8px">
          üîî<span id="alertsBadge"
            style="display:none;position:absolute;top:-2px;right:0;background:var(--danger);color:#fff;
            font-size:10px;font-weight:700;border-radius:50%;min-width:18px;height:18px;line-height:18px;text-align:center;padding:0 4px">0</span>
        </button>
        <span id="topUser" style="font-weight:500"></span>
        <span class="role-pill" id="topRole"></span>
        <button class="btn-logout" onclick="doLogout()">Sign Out</button>
      </div>
    </div>
    <!-- Sub-Profile Filter Bar (MHP/OMT) ‚Äî visible only for Luminary-type clients -->
    <div id="subProfileBar" style="display:none;background:linear-gradient(135deg,#eef2ff,#e0e7ff);border-bottom:1px solid #c7d2fe;padding:6px 24px;
      display:none;align-items:center;gap:12px;font-size:13px;">
      <span style="font-weight:700;color:#4338ca;letter-spacing:.3px">üìä Reporting View:</span>
      <div id="subProfileTabs" style="display:flex;gap:6px"></div>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileSidebar()"></div>

    <div class="app-body">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="nav-section">Overview</div>
        <div class="nav-item active" data-panel="dashboard" onclick="navTo('dashboard')">
          <span class="ni">üìä</span> Dashboard
        </div>
        <div class="nav-section">Operations</div>
        <div class="nav-item" data-panel="claims" onclick="navTo('claims')">
          <span class="ni">üìã</span> Claims Queue
        </div>
        <div class="nav-item" data-panel="credentialing" onclick="navTo('credentialing')">
          <span class="ni">üéì</span> <span id="navCredLabel">Credentialing</span>
        </div>
        <div class="nav-item" data-panel="edi" onclick="navTo('edi')">
          <span class="ni">üîó</span> EDI Setup
        </div>
        <div class="nav-item" data-panel="providers" onclick="navTo('providers')">
          <span class="ni">üë§</span> Providers
        </div>
        <div class="nav-item" data-panel="profile" onclick="navTo('profile')">
          <span class="ni">üè∑Ô∏è</span> Profile
        </div>
        <div class="nav-section">Reports</div>
        <div class="nav-item" data-panel="reporting" onclick="navTo('reporting')">
          <span class="ni">üìÑ</span> Reporting
        </div>
        <div class="nav-section">Documents</div>
        <div class="nav-item" data-panel="files" onclick="navTo('files')">
          <span class="ni">üìÇ</span> Documents
        </div>
        <div class="nav-section">Team</div>
        <div class="nav-item" data-panel="production" onclick="navTo('production')">
          <span class="ni">‚è±Ô∏è</span> Team Production
        </div>
        <div id="adminNav" style="display:none">
          <div class="nav-section">Admin</div>
          <div class="nav-item" data-panel="clients" onclick="navTo('clients')">
            <span class="ni">üè¢</span> Manage Clients
          </div>
          <div class="nav-item" data-panel="audit" onclick="navTo('audit')">
            <span class="ni">üìú</span> Audit Log
          </div>
        </div>
        <div class="nav-section">Alerts</div>
        <div class="nav-item" data-panel="alerts" onclick="navTo('alerts')">
          <span class="ni">üîî</span> Alerts <span id="navAlertsBadge" class="badge badge-red"
            style="display:none;margin-left:auto;font-size:10px">0</span>
        </div>
      </div>

      <!-- Content -->
      <div class="main-content">

        <!-- ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê -->
        <div class="hub-panel active" id="panel-dashboard">
          <!-- Hero Welcome Banner -->
          <div
            style="background:linear-gradient(135deg,#0d47a1 0%,#1565c0 40%,#1e88e5 100%);border-radius:16px;padding:28px 32px;margin-bottom:20px;position:relative;overflow:hidden">
            <div
              style="position:absolute;top:-40px;right:-20px;width:200px;height:200px;background:rgba(255,255,255,.06);border-radius:50%">
            </div>
            <div
              style="position:absolute;bottom:-60px;right:80px;width:160px;height:160px;background:rgba(255,255,255,.04);border-radius:50%">
            </div>
            <div
              style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;position:relative;z-index:1">
              <div>
                <div style="font-size:22px;font-weight:800;color:#fff;letter-spacing:-.3px" id="dashTitle">Dashboard
                </div>
                <div style="font-size:13px;color:rgba(255,255,255,.7);margin-top:4px">MedPharma SC ‚Äî Revenue Cycle
                  Management & Credentialing Solutions</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <select id="dashPeriod" class="form-control btn-sm" onchange="loadDashboard()"
                  style="width:auto;background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.25);backdrop-filter:blur(8px)">
                  <option value="mtd" style="color:#333">Month to Date</option>
                  <option value="wtd" style="color:#333">Week to Date</option>
                  <option value="ytd" style="color:#333">Year to Date</option>
                  <option value="all" style="color:#333">All Time</option>
                </select>
              </div>
            </div>
          </div>
          <!-- Profile Card -->
          <div class="card" id="profileCard" style="margin-bottom:18px;display:none">
            <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
              <div class="card-title">üè• Client Profile</div>
              <button class="btn btn-secondary btn-sm" id="profileToggleBtn" onclick="toggleProfile()">‚ñ≤
                Collapse</button>
            </div>
            <div id="profileBody">
              <div
                style="display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:10px;padding:12px 0 6px">
                <div id="prof-company"></div>
                <div id="prof-specialty"></div>
                <div id="prof-taxid"></div>
                <div id="prof-gnpi"></div>
                <div id="prof-inpi"></div>
                <div id="prof-ptangrp"></div>
                <div id="prof-ptanind"></div>
                <div id="prof-contact"></div>
                <div id="prof-email"></div>
                <div id="prof-phone"></div>
                <div id="prof-address" style="grid-column:span 2"></div>
              </div>
            </div>
          </div>

          <div class="kpi-grid" id="kpiGrid"></div>
          <!-- Data Summary Card -->
          <div class="card" id="dashSummaryCard" style="margin-bottom:18px;display:none">
            <div class="card-header">
              <div class="card-title">üìä Data Summary</div>
            </div>
            <div id="dashSummaryBody"
              style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;padding:4px 0">
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:18px">
            <div class="card">
              <div class="card-header">
                <div class="card-title">AR Aging Buckets</div>
              </div>
              <div class="aging-grid" id="agingGrid"></div>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="card-title">Claims by Status</div>
              </div>
              <div class="bar-list" id="statusChart"></div>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:2fr 1fr;gap:18px;margin-bottom:18px">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Top Denial Categories</div>
              </div>
              <div class="bar-list" id="denialChart"></div>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="card-title">Payor Mix</div>
              </div>
              <div class="bar-list" id="payorChart"></div>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
            <div class="card">
              <div class="card-header">
                <div class="card-title">‚öïÔ∏è Credentialing Status</div>
              </div>
              <div class="bar-list" id="credChart"></div>
            </div>
          </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê CLAIMS QUEUE ‚ïê‚ïê‚ïê -->
        <div class="hub-panel" id="panel-claims">
          <div class="page-header">
            <div class="page-title">Claims Queue</div>
            <div class="page-actions" style="flex-wrap:wrap;gap:8px;">
              <input type="date" id="claimsDatePicker" class="form-control btn-sm" min="2026-02-20"
                style="width:auto;min-width:190px;font-weight:600" onchange="filterClaimsTable()">
              <button class="btn btn-sm btn-secondary" onclick="clearClaimsDatePicker()">All Dates</button>
              <input class="form-control btn-sm" type="text" id="claimSearch" placeholder="üîç Search claims‚Ä¶"
                oninput="filterClaimsTable()" style="width:200px">
              <button class="btn btn-secondary btn-sm" onclick="exportSection('claims')">üì§ Export CSV</button>
              <button class="btn btn-secondary btn-sm" onclick="document.getElementById('claimsExcelInput').click()">üì•
                Import Excel</button>
              <input type="file" id="claimsExcelInput" accept=".xlsx,.xls,.csv" style="display:none"
                onchange="importExcel(this,'Claims')">
              <button class="btn btn-primary btn-sm" onclick="openClaimModal()">+ New Claim</button>
            </div>
          </div>
          <!-- Bulk Action Bar -->
          <div id="bulkActionBar" style="display:none;background:linear-gradient(135deg,#eef2ff,#e0e7ff);border:1px solid #c7d2fe;
            border-radius:10px;padding:10px 16px;margin-bottom:12px;align-items:center;gap:12px;flex-wrap:wrap">
            <span style="font-weight:700;color:#4338ca;font-size:13px">üì¶ <span id="bulkCount">0</span> selected</span>
            <select id="bulkStatusSelect" class="form-control btn-sm" style="width:auto;min-width:160px">
              <option value="">Change Status‚Ä¶</option>
            </select>
            <input type="text" id="bulkOwner" class="form-control btn-sm" placeholder="Assign Owner‚Ä¶"
              style="width:150px">
            <button class="btn btn-primary btn-sm" onclick="applyBulkUpdate()">‚úÖ Apply</button>
            <button class="btn btn-secondary btn-sm" onclick="clearBulkSelection()">‚úñ Clear</button>
          </div>
          <!-- Claims Status Summary Chart -->
          <div id="claimsStatusChart" class="section-chart-strip"></div>
          <!-- Claims Visual Charts -->
          <div id="claimsChartsRow" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:14px">
            <div class="card">
              <div class="card-header">
                <div class="card-title">üìä Status Distribution</div>
              </div>
              <div id="claimsSectionDonut" style="padding:12px"></div>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="card-title">üìä Payor Mix</div>
              </div>
              <div id="claimsSectionPayor" style="padding:12px"></div>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="card-title">üí∞ Financial Summary</div>
              </div>
              <div id="claimsSectionFinancials" style="padding:12px"></div>
            </div>
          </div>
          <div class="queue-tabs" id="queueTabs"></div>
          <div class="card" style="padding:0">
            <div class="table-wrap">
              <table id="claimsTable">
                <thead>
                  <tr>
                    <th style="width:32px"><input type="checkbox" id="claimSelectAll" onchange="toggleAllClaims(this)">
                    </th>
                    <th>Claim #</th>
                    <th>Patient</th>
                    <th>Provider</th>
                    <th>Payor</th>
                    <th>DOS</th>
                    <th>Charge</th>
                    <th>Paid</th>
                    <th>Balance</th>
                    <th>Status</th>
                    <th>Owner</th>
                    <th>Next Action</th>
                    <th>Due</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="claimsTbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê CREDENTIALING ‚ïê‚ïê‚ïê -->
        <div class="hub-panel" id="panel-credentialing">
          <div class="page-header">
            <div class="page-title" id="credPanelTitle">Credentialing</div>
            <div class="page-actions">
              <select id="credFilter" class="form-control btn-sm" onchange="loadCred()" style="width:auto">
                <option value="">All Statuses</option>
                <option>Not Started</option>
                <option>In Progress</option>
                <option>Submitted</option>
                <option>Approved</option>
                <option>Denied</option>
                <option>Expired</option>
              </select>
              <button class="btn btn-secondary btn-sm" onclick="exportSection('credentialing')">üì§ Export CSV</button>
              <button class="btn btn-secondary btn-sm" onclick="document.getElementById('credExcelInput').click()">üì•
                Import Excel</button>
              <input type="file" id="credExcelInput" accept=".xlsx,.xls,.csv" style="display:none"
                onchange="importExcel(this,'Credentialing')">
              <button class="btn btn-primary btn-sm" onclick="openCredModal()">+ Add</button>
            </div>
          </div>
          <!-- Credentialing Status Summary Chart -->
          <div id="credStatusChart" class="section-chart-strip"></div>
          <!-- Credentialing Visual Charts -->
          <div id="credChartsRow" style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px">
            <div class="card">
              <div class="card-header">
                <div class="card-title">üìä Status Distribution</div>
              </div>
              <div id="credSectionDonut" style="padding:12px"></div>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="card-title">üìä Payor Breakdown</div>
              </div>
              <div id="credSectionPayor" style="padding:12px"></div>
            </div>
          </div>
          <div class="card" style="padding:0">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Provider</th>
                    <th>Payor</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Submitted</th>
                    <th>Follow-Up</th>
                    <th>Approved</th>
                    <th>Expires</th>
                    <th>Owner</th>
                    <th>Notes</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="credTbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê EDI ‚ïê‚ïê‚ïê -->
        <div class="hub-panel" id="panel-edi">
          <div class="page-header">
            <div class="page-title">EDI Setup</div>
            <div class="page-actions">
              <button class="btn btn-secondary btn-sm" onclick="exportSection('edi_setup')">üì§ Export CSV</button>
              <button class="btn btn-secondary btn-sm" onclick="document.getElementById('ediExcelInput').click()">üì•
                Import Excel</button>
              <input type="file" id="ediExcelInput" accept=".xlsx,.xls,.csv" style="display:none"
                onchange="importExcel(this,'EDI')">
              <button class="btn btn-primary btn-sm" onclick="openEdiModal()">+ Add</button>
            </div>
          </div>
          <!-- EDI Status Summary Chart -->
          <div id="ediStatusChart" class="section-chart-strip"></div>
          <div class="card" style="padding:0">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Provider</th>
                    <th>Payor</th>
                    <th>Payer ID</th>
                    <th>EDI</th>
                    <th>ERA</th>
                    <th>EFT</th>
                    <th>Submitted</th>
                    <th>Go-Live</th>
                    <th>Owner</th>
                    <th>Notes</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="ediTbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê PROVIDERS ‚ïê‚ïê‚ïê -->
        <div class="hub-panel" id="panel-providers">
          <div class="page-header">
            <div class="page-title">Providers</div>
            <div class="page-actions">
              <button class="btn btn-secondary btn-sm" onclick="exportSection('providers')">üì§ Export CSV</button>
              <button class="btn btn-primary btn-sm" onclick="openProviderModal()">+ Add Provider</button>
            </div>
          </div>
          <div class="card" style="padding:0">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>NPI</th>
                    <th>Specialty</th>
                    <th>Tax ID</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Status</th>
                    <th>Start Date</th>
                    <th>Notes</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="providerTbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê CLIENTS (admin) ‚ïê‚ïê‚ïê -->
        <div class="hub-panel" id="panel-clients">
          <div class="page-header">
            <div class="page-title">Manage Clients</div>
            <div class="page-actions">
              <button class="btn btn-primary btn-sm" onclick="openClientModal()">+ Add Client</button>
            </div>
          </div>
          <div class="card" style="padding:0">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Username</th>
                    <th>Company</th>
                    <th>Contact</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Role</th>
                    <th>Last Login</th>
                    <th>Active</th>
                  </tr>
                </thead>
                <tbody id="clientTbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê REPORTING ‚ïê‚ïê‚ïê -->
        <div class="hub-panel" id="panel-reporting">
          <div class="page-header">
            <div class="page-title">üìÑ Client Report</div>
            <div class="page-actions" style="gap:8px;display:flex;align-items:center;flex-wrap:wrap">
              <select id="reportPeriod" class="form-control btn-sm" onchange="loadReport()" style="width:auto">
                <option value="all">All Time</option>
                <option value="mtd">Month to Date</option>
                <option value="ytd">Year to Date</option>
              </select>
              <button class="btn btn-sm" id="btnAINarrative" onclick="generateGPTNarrative()"
                style="background:linear-gradient(135deg,#7c3aed,#6366f1);color:#fff;border:none;font-weight:600">
                ü§ñ Generate AI Report</button>
              <button class="btn btn-sm" onclick="downloadPDF()"
                style="background:linear-gradient(135deg,#0d47a1,#1565c0);color:#fff;border:none;font-weight:600">
                üìÑ Download PDF</button>
              <button class="btn btn-secondary btn-sm" onclick="downloadReportCSV()">üì• Download CSV</button>
              <button class="btn btn-primary btn-sm" onclick="printReport()">üñ®Ô∏è Print Report</button>
            </div>
          </div>

          <!-- Report Tabs Bar -->
          <div
            style="display:flex;align-items:center;gap:6px;margin-bottom:16px;flex-wrap:wrap;border-bottom:2px solid var(--gray-200);padding-bottom:8px">
            <div class="queue-tabs" id="reportTabBar" style="display:flex;gap:4px;flex-wrap:wrap;flex:1"></div>
            <button class="btn btn-sm" onclick="toggleAddReportTab()"
              style="background:var(--success-light);color:var(--success);border:none;font-weight:600;font-size:12px">
              ‚ûï Add Tab</button>
            <button class="btn btn-sm" onclick="toggleManageReportTabs()"
              style="background:var(--gray-50);color:var(--gray-600);border:1px solid var(--gray-200);font-size:12px">
              ‚öôÔ∏è Manage Tabs</button>
          </div>

          <!-- Add Tab Form (hidden) -->
          <div id="addReportTabForm" style="display:none;margin-bottom:16px">
            <div class="card" style="padding:12px;border:2px dashed var(--success);background:var(--success-light)">
              <div style="display:flex;gap:8px;align-items:center">
                <input class="form-control" id="newReportTabName" placeholder="New tab name (e.g., Appeals Tracking)"
                  style="flex:1;max-width:300px" onkeypress="if(event.key==='Enter')addNewReportTab()">
                <button class="btn btn-success btn-sm" onclick="addNewReportTab()">Create Tab</button>
                <button class="btn btn-secondary btn-sm" onclick="toggleAddReportTab()">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Manage Tabs Form (hidden) -->
          <div id="manageReportTabsForm" style="display:none;margin-bottom:16px">
            <div class="card" style="padding:16px;border:2px solid var(--gray-300)">
              <div style="font-weight:700;font-size:14px;margin-bottom:12px;color:var(--gray-700)">‚öôÔ∏è Manage Report Tabs
              </div>
              <div id="manageReportTabsList" style="display:flex;flex-direction:column;gap:8px"></div>
              <div style="display:flex;gap:8px;margin-top:12px">
                <button class="btn btn-primary btn-sm" onclick="saveReportTabNames()">üíæ Save Changes</button>
                <button class="btn btn-secondary btn-sm" onclick="toggleManageReportTabs()">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Tab Content: Overview (default ‚Äî all the original report content) -->
          <div id="reportTabContent-overview">

            <!-- AI Narrative Summary -->
            <div class="card" style="margin-bottom:16px;border-left:4px solid var(--info)">
              <div class="card-header" style="display:flex;align-items:center;justify-content:space-between">
                <div class="card-title">üìã Overall Account Summary</div>
                <span id="aiNarrativeSource" style="font-size:10px;color:var(--gray-400);font-style:italic"></span>
              </div>
              <div id="reportAINarrative" style="padding:16px;line-height:1.7;font-size:13.5px;color:var(--gray-700)">
                <p style="color:var(--gray-400);font-size:13px">Loading AI summary‚Ä¶</p>
              </div>
            </div>

            <!-- Overall KPI Cards -->
            <div class="card" style="margin-bottom:16px">
              <div class="card-header">
                <div class="card-title">Summary Overview</div>
              </div>
              <div id="reportSummary">
                <p style="color:var(--gray-400);font-size:13px">Loading report‚Ä¶</p>
              </div>
            </div>

            <!-- Charts Section -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
              <div class="card">
                <div class="card-header">
                  <div class="card-title">üìä Claims by Status</div>
                </div>
                <div id="chartClaimsStatus" style="padding:16px"></div>
              </div>
              <div class="card">
                <div class="card-header">
                  <div class="card-title">üìä Financials Overview</div>
                </div>
                <div id="chartFinancials" style="padding:16px"></div>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
              <div class="card">
                <div class="card-header">
                  <div class="card-title">üìä Credentialing Status</div>
                </div>
                <div id="chartCredStatus" style="padding:16px"></div>
              </div>
            </div>

            <!-- Sub-Profile Breakdowns (OMT / MHP) -->
            <div id="reportSubProfiles" style="display:none;margin-bottom:16px">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <div class="card" style="border-top:4px solid #6366f1">
                  <div class="card-header">
                    <div class="card-title">OMT ‚Äî Osteopathic Manipulative Treatment</div>
                  </div>
                  <div id="reportOMT" style="padding:12px">
                    <p style="color:var(--gray-400);font-size:13px">No OMT data</p>
                  </div>
                </div>
                <div class="card" style="border-top:4px solid #0ea5e9">
                  <div class="card-header">
                    <div class="card-title">MHP ‚Äî Michigan Health Partners (Ancillary)</div>
                  </div>
                  <div id="reportMHP" style="padding:12px">
                    <p style="color:var(--gray-400);font-size:13px">No MHP data</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Detail tables -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
              <div class="card">
                <div class="card-header">
                  <div class="card-title">Claims Summary</div>
                </div>
                <div id="reportClaims"></div>
              </div>
              <div class="card">
                <div class="card-header">
                  <div class="card-title">Payment Activity</div>
                </div>
                <div id="reportPayments"></div>
              </div>
            </div>
            <div class="card" style="margin-bottom:16px">
              <div class="card-header">
                <div class="card-title">Credentialing Status</div>
              </div>
              <div id="reportCred" style="overflow-x:auto"></div>
            </div>
            <div class="card" style="margin-bottom:16px">
              <div class="card-header">
                <div class="card-title">EDI Setup Status</div>
              </div>
              <div id="reportEdi" style="overflow-x:auto"></div>
            </div>
          </div><!-- end reportTabContent-overview -->

          <!-- Tab Content: Claims -->
          <div id="reportTabContent-claims" style="display:none">
            <div class="card" style="margin-bottom:16px;border-left:4px solid var(--info)">
              <div class="card-header">
                <div class="card-title">üìä Claims Report</div>
              </div>
              <div id="rptClaimsCharts" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px">
                <div>
                  <div style="font-weight:600;font-size:13px;margin-bottom:8px;color:var(--gray-600)">Claims by Status
                  </div>
                  <div id="rptClaimsStatusChart"></div>
                </div>
                <div>
                  <div style="font-weight:600;font-size:13px;margin-bottom:8px;color:var(--gray-600)">Financials</div>
                  <div id="rptClaimsFinChart"></div>
                </div>
              </div>
            </div>
            <div class="card" style="margin-bottom:16px">
              <div class="card-header">
                <div class="card-title">Claims Detail</div>
              </div>
              <div id="rptClaimsTable" style="overflow-x:auto"></div>
            </div>
            <div class="card" style="margin-bottom:16px;border-left:4px solid #7c3aed">
              <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
                <div class="card-title">üìù Claims Notes & Requirements</div>
                <button class="btn btn-sm btn-primary" onclick="saveReportTabNote('Claims')">üíæ Save Notes</button>
              </div>
              <div style="padding:12px">
                <textarea id="reportNote-Claims" class="form-control" rows="6"
                  placeholder="Add Claims-specific notes, unique requirements, follow-up items, appeals tracking, etc."
                  style="font-size:13px;line-height:1.6;resize:vertical"></textarea>
                <div id="reportNoteInfo-Claims" style="font-size:11px;color:var(--gray-400);margin-top:4px"></div>
              </div>
            </div>
          </div>

          <!-- Tab Content: Credentialing -->
          <div id="reportTabContent-credentialing" style="display:none">
            <div class="card" style="margin-bottom:16px;border-left:4px solid #6366f1">
              <div class="card-header">
                <div class="card-title">üìä Credentialing Report</div>
              </div>
              <div id="rptCredCharts" style="padding:16px">
                <div style="font-weight:600;font-size:13px;margin-bottom:8px;color:var(--gray-600)">Status Distribution
                </div>
                <div id="rptCredStatusChart"></div>
              </div>
            </div>
            <div class="card" style="margin-bottom:16px">
              <div class="card-header">
                <div class="card-title">Credentialing Detail</div>
              </div>
              <div id="rptCredTable" style="overflow-x:auto"></div>
            </div>
            <div class="card" style="margin-bottom:16px;border-left:4px solid #7c3aed">
              <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
                <div class="card-title">üìù Credentialing Notes & Requirements</div>
                <button class="btn btn-sm btn-primary" onclick="saveReportTabNote('Credentialing')">üíæ Save
                  Notes</button>
              </div>
              <div style="padding:12px">
                <textarea id="reportNote-Credentialing" class="form-control" rows="6"
                  placeholder="Add Credentialing-specific notes, unique payor requirements, pending follow-ups, CAQH updates, etc."
                  style="font-size:13px;line-height:1.6;resize:vertical"></textarea>
                <div id="reportNoteInfo-Credentialing" style="font-size:11px;color:var(--gray-400);margin-top:4px">
                </div>
              </div>
            </div>
          </div>

          <!-- Tab Content: EDI -->
          <div id="reportTabContent-edi" style="display:none">
            <div class="card" style="margin-bottom:16px;border-left:4px solid #0ea5e9">
              <div class="card-header">
                <div class="card-title">üìä EDI Setup Report</div>
              </div>
              <div id="rptEdiCharts" style="padding:16px">
                <div style="font-weight:600;font-size:13px;margin-bottom:8px;color:var(--gray-600)">EDI Status</div>
                <div id="rptEdiStatusChart"></div>
              </div>
            </div>
            <div class="card" style="margin-bottom:16px">
              <div class="card-header">
                <div class="card-title">EDI Detail</div>
              </div>
              <div id="rptEdiTable" style="overflow-x:auto"></div>
            </div>
            <div class="card" style="margin-bottom:16px;border-left:4px solid #7c3aed">
              <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
                <div class="card-title">üìù EDI Notes & Requirements</div>
                <button class="btn btn-sm btn-primary" onclick="saveReportTabNote('EDI')">üíæ Save Notes</button>
              </div>
              <div style="padding:12px">
                <textarea id="reportNote-EDI" class="form-control" rows="6"
                  placeholder="Add EDI-specific notes, payer ID issues, connectivity requirements, ERA/EFT setup notes, etc."
                  style="font-size:13px;line-height:1.6;resize:vertical"></textarea>
                <div id="reportNoteInfo-EDI" style="font-size:11px;color:var(--gray-400);margin-top:4px"></div>
              </div>
            </div>
          </div>

          <!-- Tab Content: Custom (dynamically rendered) -->
          <div id="reportTabContent-custom" style="display:none"></div>

        </div>

        <!-- ‚ïê‚ïê‚ïê FILES & REPORTS ‚ïê‚ïê‚ïê -->
        <!-- ‚ïê‚ïê‚ïê DOCUMENTS ‚ïê‚ïê‚ïê -->
        <div class="hub-panel" id="panel-files">
          <div class="page-header">
            <div class="page-title">üìÇ Documents</div>
            <div class="page-actions" style="gap:8px;display:flex;align-items:center;flex-wrap:wrap">
              <button class="btn btn-secondary btn-sm" onclick="toggleAddFolder()">üìÅ Add Folder</button>
              <button class="btn btn-secondary btn-sm" onclick="toggleRenameDocTabs()" id="renameDocTabsBtn">‚úèÔ∏è Manage
                Folders</button>
              <button class="btn btn-primary btn-sm" onclick="document.getElementById('filePickerInput').click()">‚¨Ü
                Upload File</button>
              <input type="file" id="filePickerInput" accept=".xlsx,.xls,.csv,.pdf,.doc,.docx" style="display:none"
                onchange="handleFileSelect(this)" multiple>
            </div>
          </div>

          <!-- Add New Folder inline -->
          <div id="addFolderForm"
            style="display:none;background:var(--info-light);border:1px solid #bfdbfe;border-radius:10px;padding:14px 16px;margin-bottom:12px">
            <div style="font-size:13px;font-weight:700;color:var(--info);margin-bottom:8px">üìÅ Create New Folder</div>
            <div style="display:flex;gap:8px;align-items:center">
              <input class="form-control" id="newFolderName" placeholder="Enter folder name‚Ä¶"
                style="flex:1;max-width:300px" onkeydown="if(event.key==='Enter')addNewFolder()">
              <button class="btn btn-primary btn-sm" onclick="addNewFolder()">Create</button>
              <button class="btn btn-secondary btn-sm" onclick="toggleAddFolder()">Cancel</button>
            </div>
          </div>

          <!-- Manage Folders editor -->
          <div id="renameDocTabsForm"
            style="display:none;background:var(--gray-50);border:1px solid var(--gray-200);border-radius:10px;padding:16px;margin-bottom:16px">
            <div style="font-size:13px;font-weight:700;color:var(--gray-600);margin-bottom:12px">‚úèÔ∏è Manage Folders ‚Äî
              Rename or Remove</div>
            <div id="manageFoldersList" style="display:flex;flex-direction:column;gap:8px"></div>
            <div style="margin-top:12px;display:flex;gap:8px">
              <button class="btn btn-primary btn-sm" onclick="saveFolderNames()">üíæ Save Changes</button>
              <button class="btn btn-secondary btn-sm" onclick="toggleRenameDocTabs()">Cancel</button>
            </div>
          </div>

          <!-- Category tabs -->
          <div id="docCategoryTabs" class="queue-tabs" style="margin-bottom:0"></div>

          <!-- Upload Drop Zone -->
          <div class="card" id="dropZone"
            style="border:2px dashed var(--gray-300);background:var(--gray-50);text-align:center;padding:28px 20px;cursor:pointer;transition:all .2s;margin-top:16px"
            ondragover="event.preventDefault();this.style.borderColor='#1e88e5';this.style.background='#e3f2fd'"
            ondragleave="this.style.borderColor='';this.style.background=''"
            ondrop="event.preventDefault();this.style.borderColor='';this.style.background='';handleFileDrop(event)">
            <div style="font-size:32px;margin-bottom:8px">üìÑ</div>
            <div style="font-size:15px;font-weight:600;color:var(--gray-700)">Drag &amp; drop files here or click Upload
            </div>
            <div style="font-size:12px;color:var(--gray-400);margin-top:4px">.xlsx &nbsp;‚Ä¢&nbsp; .xls &nbsp;‚Ä¢&nbsp; .csv
              &nbsp;‚Ä¢&nbsp; .pdf &nbsp;‚Ä¢&nbsp; .doc &nbsp;‚Ä¢&nbsp; .docx</div>
            <div style="margin-top:10px">
              <input id="fileDesc" class="form-control" placeholder="Description (optional)"
                style="width:240px;display:inline-block">
            </div>
          </div>

          <!-- Completion Tracker -->
          <div class="card" style="margin:16px 0 0">
            <div class="card-header"><span class="card-title">‚óÜ Workflow Completion Tracker</span></div>
            <div id="completionTracker"
              style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;padding:4px 0">
              <!-- populated by JS -->
            </div>
          </div>

          <!-- File list -->
          <div class="card" style="padding:0;margin-top:16px">
            <div class="card-header"
              style="padding:16px 20px;display:flex;justify-content:space-between;align-items:center">
              <span class="card-title" id="docFilesTitle">All Documents</span>
              <span id="docFilesCount" style="font-size:13px;color:var(--gray-400)"></span>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Filename</th>
                    <th>Category</th>
                    <th>Description</th>
                    <th>Size</th>
                    <th>Uploaded By</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="filesTbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê -->
        <div class="hub-panel" id="panel-profile">
          <div class="page-header">
            <div class="page-title" id="profilePanelTitle">üè∑Ô∏è Client Profile</div>
            <div class="page-actions">
              <button class="btn btn-primary btn-sm" onclick="saveProfile()">üíæ Save Changes</button>
            </div>
          </div>

          <div class="card" style="margin-bottom:18px">
            <div class="card-header">
              <div class="card-title">üè• Practice Information</div>
            </div>
            <div class="form-grid" style="margin-top:12px">
              <div class="form-group">
                <label>Practice / Company Name</label>
                <input class="form-control" id="pf-company" placeholder="e.g. ABC Medical Group">
              </div>
              <div class="form-group">
                <label>Specialty</label>
                <input class="form-control" id="pf-specialty" placeholder="e.g. Family Medicine">
              </div>
              <div class="form-group">
                <label>Tax ID (EIN)</label>
                <input class="form-control" id="pf-tax_id" placeholder="XX-XXXXXXX">
              </div>
              <div class="form-group">
                <label>Group NPI</label>
                <input class="form-control" id="pf-group_npi" placeholder="10-digit NPI">
              </div>
              <div class="form-group">
                <label>Individual NPI</label>
                <input class="form-control" id="pf-individual_npi" placeholder="10-digit NPI">
              </div>
              <div class="form-group">
                <label>Medicare PTAN (Group)</label>
                <input class="form-control" id="pf-ptan_group" placeholder="e.g. MI120440">
              </div>
              <div class="form-group">
                <label>Medicare PTAN (Individual)</label>
                <input class="form-control" id="pf-ptan_individual" placeholder="e.g. MI20440001">
              </div>
            </div>
          </div>

          <div class="card" style="margin-bottom:18px">
            <div class="card-header">
              <div class="card-title">üìû Contact Information</div>
            </div>
            <div class="form-grid" style="margin-top:12px">
              <div class="form-group">
                <label>Contact Name</label>
                <input class="form-control" id="pf-contact_name" placeholder="Full name">
              </div>
              <div class="form-group">
                <label>Email</label>
                <input class="form-control" type="email" id="pf-email" placeholder="billing@example.com">
              </div>
              <div class="form-group">
                <label>Phone</label>
                <input class="form-control" id="pf-phone" placeholder="(555) 000-0000">
              </div>
              <div class="form-group" style="grid-column:span 2">
                <label>Address</label>
                <input class="form-control" id="pf-address" placeholder="Street, City, State ZIP">
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">üìù Notes</div>
            </div>
            <div class="form-group" style="margin-top:12px">
              <textarea class="form-control" id="pf-notes" rows="4"
                placeholder="Internal notes about this client‚Ä¶"></textarea>
            </div>
          </div>

          <!-- Sub-Profiles (MHP / OMT) ‚Äî visible only for MHP+OMT practice type -->
          <div id="subProfilesSection" style="display:none;margin-top:18px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <div style="font-size:16px;font-weight:700;color:var(--gray-700)">üè∑Ô∏è Practice Sub-Profiles</div>
              <button class="btn btn-secondary btn-sm" onclick="showAddSubProfilePrompt()">+ Add Sub-Profile</button>
            </div>
            <div id="subProfilesGrid"
              style="display:grid;grid-template-columns:repeat(auto-fill,minmax(420px,1fr));gap:18px"></div>
          </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê TEAM PRODUCTION ‚ïê‚ïê‚ïê -->
        <div class="hub-panel" id="panel-production">
          <div class="page-header">
            <div class="page-title">‚è±Ô∏è Team Production</div>
            <div class="page-actions" style="display:flex;gap:8px;align-items:center">
              <button class="btn btn-secondary btn-sm" onclick="exportSection('production')">üì§ Export CSV</button>
              <button class="btn btn-secondary btn-sm" onclick="toggleProductionView('report')" id="btnProdReport">üìä
                Weekly Report</button>
              <button class="btn btn-primary btn-sm" onclick="toggleProductionView('log')" id="btnProdLog">üìù Daily
                Log</button>
            </div>
          </div>

          <!-- Daily Log Entry View -->
          <div id="prodLogView">
            <div class="card" style="margin-bottom:18px">
              <div class="card-header">
                <div class="card-title">üìù Log Today's Work</div>
              </div>
              <div style="margin-top:12px">
                <div class="form-grid">
                  <div class="form-group">
                    <label>Date</label>
                    <input class="form-control" type="date" id="prodDate">
                  </div>
                  <div class="form-group">
                    <label>Category</label>
                    <select class="form-control" id="prodCategory">
                      <option value="Claims Processing">Claims Processing</option>
                      <option value="Credentialing">Credentialing</option>
                      <option value="EDI Setup">EDI Setup</option>
                      <option value="Denial Management">Denial Management</option>
                      <option value="A/R Follow-up">A/R Follow-up</option>
                      <option value="Appeals">Appeals</option>
                      <option value="Patient Calls">Patient Calls</option>
                      <option value="Payor Calls">Payor Calls</option>
                      <option value="Data Entry">Data Entry</option>
                      <option value="Reporting">Reporting</option>
                      <option value="Admin/Meeting">Admin/Meeting</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  <div class="form-group" style="grid-column:span 2">
                    <label>Task Description</label>
                    <input class="form-control" id="prodTask" placeholder="Describe the work completed‚Ä¶">
                  </div>
                  <div class="form-group">
                    <label>Quantity (items processed)</label>
                    <input class="form-control" type="number" id="prodQty" value="0" min="0">
                  </div>
                  <div class="form-group">
                    <label>Time Spent (hours)</label>
                    <input class="form-control" type="number" id="prodHours" value="0" min="0" step="0.25">
                  </div>
                  <div class="form-group" style="grid-column:span 2">
                    <label>Notes</label>
                    <input class="form-control" id="prodNotes" placeholder="Optional notes‚Ä¶">
                  </div>
                </div>
                <div style="margin-top:12px;text-align:right">
                  <button class="btn btn-primary btn-sm" onclick="saveProductionLog()">‚ûï Add Entry</button>
                </div>
              </div>
            </div>

            <!-- Filter by date -->
            <div class="card" style="margin-bottom:18px">
              <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                <label style="font-weight:600;font-size:13px">Filter date:</label>
                <input class="form-control" type="date" id="prodFilterDate" style="width:180px"
                  onchange="loadProduction()">
                <button class="btn btn-secondary btn-sm"
                  onclick="document.getElementById('prodFilterDate').value='';loadProduction()">Show All</button>
              </div>
            </div>

            <div class="card" style="padding:0">
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>User</th>
                      <th>Category</th>
                      <th>Task</th>
                      <th>Qty</th>
                      <th>Hours</th>
                      <th>Notes</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="prodTbody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Weekly Report View -->
          <div id="prodReportView" style="display:none">
            <div class="card" style="margin-bottom:18px">
              <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                <label style="font-weight:600;font-size:13px">Report period:</label>
                <input class="form-control" type="date" id="prodRptStart" style="width:170px">
                <span style="font-size:13px;color:var(--gray-400)">to</span>
                <input class="form-control" type="date" id="prodRptEnd" style="width:170px">
                <button class="btn btn-primary btn-sm" onclick="loadProductionReport()">Generate Report</button>
              </div>
            </div>

            <div id="prodReportContent">
              <p style="color:var(--gray-400);font-size:14px;padding:20px;text-align:center">Select a date range and
                click Generate Report</p>
            </div>
          </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê ALERTS & NOTIFICATIONS ‚ïê‚ïê‚ïê -->
        <div class="hub-panel" id="panel-alerts">
          <div class="page-header">
            <div class="page-title">üîî Alerts & Notifications</div>
            <div class="page-actions">
              <button class="btn btn-primary btn-sm" id="btnTestNotice" onclick="sendTestNotice()">üì® Send Test
                Notice</button>
              <button class="btn btn-secondary btn-sm" onclick="loadAlerts()">üîÑ Refresh</button>
            </div>
          </div>
          <div id="notificationHealthBanner"
            style="display:none;margin-bottom:10px;padding:10px 12px;border-radius:8px;font-size:12px;font-weight:600;">
          </div>
          <div id="testNoticeStatus" style="font-size:12px;color:var(--gray-500);margin-bottom:10px;display:none;">
          </div>
          <div id="alertsContent">
            <div class="card" style="text-align:center;padding:40px;color:var(--gray-400)">Loading alerts...</div>
          </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê AUDIT LOG (Admin) ‚ïê‚ïê‚ïê -->
        <div class="hub-panel" id="panel-audit">
          <div class="page-header">
            <div class="page-title">üìú Audit Log</div>
            <div class="page-actions">
              <button class="btn btn-secondary btn-sm" onclick="loadAuditLog()">üîÑ Refresh</button>
            </div>
          </div>
          <div class="card" style="padding:0">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Timestamp</th>
                    <th>User</th>
                    <th>Action</th>
                    <th>Entity</th>
                    <th>Details</th>
                  </tr>
                </thead>
                <tbody id="auditTbody"></tbody>
              </table>
            </div>
          </div>
        </div>

      </div><!-- main-content -->
    </div><!-- app-body -->
  </div><!-- appShell -->

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <!-- Claim Modal (full edit with notes + payments) -->
  <div class="modal-overlay" id="claimModal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="claimModalTitle">New Claim</h2>
        <button class="modal-close" onclick="closeModal('claimModal')">&times;</button>
      </div>
      <input type="hidden" id="claimEditId">
      <div class="form-grid">
        <div class="form-group"><label>Claim Key *</label><input class="form-control" id="fClaimKey"
            placeholder="CLM-2026-001"></div>
        <div class="form-group"><label>Patient ID</label><input class="form-control" id="fPatientID"></div>
        <div class="form-group"><label>Patient Name</label><input class="form-control" id="fPatientName"></div>
        <div class="form-group"><label>Payor</label><input class="form-control" id="fPayor"></div>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Provider Name</label><input class="form-control" id="fProviderName"></div>
        <div class="form-group"><label>NPI</label><input class="form-control" id="fNPI"></div>
        <div class="form-group"><label>CPT Code</label><input class="form-control" id="fCPT"></div>
        <div class="form-group"><label>DOS</label><input class="form-control" type="date" id="fDOS"></div>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Charge $</label><input class="form-control" type="number" step="0.01"
            id="fCharge" value="0"></div>
        <div class="form-group"><label>Allowed $</label><input class="form-control" type="number" step="0.01"
            id="fAllowed" value="0"></div>
        <div class="form-group"><label>Paid $</label><input class="form-control" type="number" step="0.01" id="fPaid"
            value="0"></div>
        <div class="form-group"><label>Balance $</label><input class="form-control" type="number" step="0.01"
            id="fBalance" value="0"></div>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Status *</label>
          <select class="form-control" id="fClaimStatus">
            <option>Intake</option>
            <option>Verification</option>
            <option>Coding</option>
            <option>Billed/Submitted</option>
            <option>Rejected</option>
            <option>Denied</option>
            <option>A/R Follow-up</option>
            <option>Appeal</option>
            <option>Paid</option>
          </select>
        </div>
        <div class="form-group"><label>Owner</label><input class="form-control" id="fOwner"></div>
        <div class="form-group"><label>Bill Date</label><input class="form-control" type="date" id="fBillDate"></div>
        <div class="form-group"><label>Denied Date</label><input class="form-control" type="date" id="fDeniedDate">
        </div>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Denial Category</label>
          <select class="form-control" id="fDenialCat">
            <option value=""></option>
            <option>Authorization/Referral</option>
            <option>Eligibility</option>
            <option>Coding Error</option>
            <option>Duplicate Claim</option>
            <option>Timely Filing</option>
            <option>Medical Necessity</option>
            <option>Non-Covered Service</option>
            <option>Missing Info</option>
            <option>Other</option>
          </select>
        </div>
        <div class="form-group"><label>Denial Reason</label><input class="form-control" id="fDenialReason"></div>
        <div class="form-group"><label>Next Action</label><input class="form-control" id="fNextAction"></div>
        <div class="form-group"><label>Next Action Due</label><input class="form-control" type="date"
            id="fNextActionDue"></div>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Paid Date</label><input class="form-control" type="date" id="fPaidDate"></div>
        <div class="form-group"><label>Appeal Date</label><input class="form-control" type="date" id="fAppealDate">
        </div>
        <div class="form-group"><label>Appeal Status</label>
          <select class="form-control" id="fAppealStatus">
            <option value=""></option>
            <option>Filed</option>
            <option>Pending</option>
            <option>Won</option>
            <option>Lost</option>
          </select>
        </div>
        <div class="form-group"><label>SLA Breached</label>
          <select class="form-control" id="fSLA">
            <option value="0">No</option>
            <option value="1">Yes</option>
          </select>
        </div>
      </div>
      <div class="form-group form-full" id="claimClientGroup" style="display:none;margin-bottom:14px">
        <label>Client</label>
        <select class="form-control" id="fClaimClient"></select>
      </div>
      <button class="btn btn-primary" onclick="saveClaim()">Save Claim</button>

      <!-- Notes section (only for edit mode) -->
      <div class="modal-section" id="notesSection" style="display:none">
        <div class="modal-section-title">Notes Log</div>
        <div id="notesList" style="margin-bottom:12px"></div>
        <div style="display:flex;gap:8px">
          <input class="form-control" id="newNoteText" placeholder="Add a note‚Ä¶" style="flex:1"
            onkeydown="if(event.key==='Enter')addNote()">
          <button class="btn btn-secondary btn-sm" onclick="addNote()">Add Note</button>
        </div>
      </div>

      <!-- Payments section (only for edit mode) -->
      <div class="modal-section" id="paymentsSection" style="display:none">
        <div class="modal-section-title">Payment History</div>
        <div id="paymentsList" style="margin-bottom:12px"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;align-items:end">
          <div class="form-group"><label>Post Date</label><input class="form-control" type="date" id="payDate"></div>
          <div class="form-group"><label>Amount $</label><input class="form-control" type="number" step="0.01"
              id="payAmount" value="0"></div>
          <div class="form-group"><label>Type</label>
            <select class="form-control" id="payType">
              <option>Primary</option>
              <option>Secondary</option>
              <option>Patient</option>
            </select>
          </div>
          <button class="btn btn-success btn-sm" onclick="addPayment()">+ Add</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Credentialing Modal -->
  <div class="modal-overlay" id="credModal">
    <div class="modal modal-sm">
      <div class="modal-header">
        <h2 id="credModalTitle">New Credentialing Item</h2>
        <button class="modal-close" onclick="closeModal('credModal')">&times;</button>
      </div>
      <input type="hidden" id="credEditId">
      <div class="form-grid">
        <div class="form-group"><label>Provider Name</label><input class="form-control" id="fCredProvider"></div>
        <div class="form-group"><label>Payor</label><input class="form-control" id="fCredPayor"></div>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Type</label>
          <select class="form-control" id="fCredType">
            <option>Initial</option>
            <option>Re-credential</option>
            <option>Renewal</option>
            <option>Add Location</option>
          </select>
        </div>
        <div class="form-group"><label>Status</label>
          <select class="form-control" id="fCredStatus">
            <option>Not Started</option>
            <option>In Progress</option>
            <option>Submitted</option>
            <option>Approved</option>
            <option>Denied</option>
            <option>Expired</option>
          </select>
        </div>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Submitted</label><input class="form-control" type="date" id="fCredSubmitted">
        </div>
        <div class="form-group"><label>Follow-Up</label><input class="form-control" type="date" id="fCredFollowUp">
        </div>
        <div class="form-group"><label>Approved</label><input class="form-control" type="date" id="fCredApproved"></div>
        <div class="form-group"><label>Expiration</label><input class="form-control" type="date" id="fCredExpires">
        </div>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Owner</label><input class="form-control" id="fCredOwner"></div>
        <div class="form-group form-full" id="credClientGroup" style="display:none">
          <label>Client</label><select class="form-control" id="fCredClient"></select>
        </div>
      </div>
      <div class="form-group" style="margin-bottom:16px"><label>Notes</label><textarea class="form-control"
          id="fCredNotes"></textarea></div>
      <button class="btn btn-primary" onclick="saveCred()">Save</button>
    </div>
  </div>

  <!-- EDI Modal -->
  <div class="modal-overlay" id="ediModal">
    <div class="modal modal-sm">
      <div class="modal-header">
        <h2 id="ediModalTitle">New EDI Setup</h2>
        <button class="modal-close" onclick="closeModal('ediModal')">&times;</button>
      </div>
      <input type="hidden" id="ediEditId">
      <div class="form-grid">
        <div class="form-group"><label>Provider Name</label><input class="form-control" id="fEdiProvider"></div>
        <div class="form-group"><label>Payor</label><input class="form-control" id="fEdiPayor"></div>
        <div class="form-group"><label>Payer ID</label><input class="form-control" id="fEdiPayerID"></div>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>EDI Status</label>
          <select class="form-control" id="fEdiStatus">
            <option>Not Started</option>
            <option>In Process</option>
            <option>Live</option>
            <option>Failed</option>
          </select>
        </div>
        <div class="form-group"><label>ERA Status</label>
          <select class="form-control" id="fEraStatus">
            <option>Not Started</option>
            <option>In Process</option>
            <option>Live</option>
            <option>Failed</option>
          </select>
        </div>
        <div class="form-group"><label>EFT Status</label>
          <select class="form-control" id="fEftStatus">
            <option>Not Started</option>
            <option>In Process</option>
            <option>Live</option>
            <option>Failed</option>
          </select>
        </div>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Submitted</label><input class="form-control" type="date" id="fEdiSubmitted">
        </div>
        <div class="form-group"><label>Go-Live</label><input class="form-control" type="date" id="fEdiGoLive"></div>
        <div class="form-group"><label>Owner</label><input class="form-control" id="fEdiOwner"></div>
      </div>
      <div class="form-group form-full" id="ediClientGroup" style="display:none;margin-bottom:14px">
        <label>Client</label><select class="form-control" id="fEdiClient"></select>
      </div>
      <div class="form-group" style="margin-bottom:16px"><label>Notes</label><textarea class="form-control"
          id="fEdiNotes"></textarea></div>
      <button class="btn btn-primary" onclick="saveEdi()">Save</button>
    </div>
  </div>

  <!-- Provider Modal -->
  <div class="modal-overlay" id="providerModal">
    <div class="modal modal-sm">
      <div class="modal-header">
        <h2 id="providerModalTitle">New Provider</h2>
        <button class="modal-close" onclick="closeModal('providerModal')">&times;</button>
      </div>
      <input type="hidden" id="providerEditId">
      <div class="form-grid">
        <div class="form-group"><label>Full Name *</label><input class="form-control" id="fProvName"></div>
        <div class="form-group"><label>NPI</label><input class="form-control" id="fProvNPI"></div>
        <div class="form-group"><label>Specialty</label><input class="form-control" id="fProvSpecialty"></div>
        <div class="form-group"><label>Tax ID</label><input class="form-control" id="fProvTaxID"></div>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Email</label><input class="form-control" type="email" id="fProvEmail"></div>
        <div class="form-group"><label>Phone</label><input class="form-control" id="fProvPhone"></div>
        <div class="form-group"><label>Status</label>
          <select class="form-control" id="fProvStatus">
            <option>Active</option>
            <option>Inactive</option>
          </select>
        </div>
        <div class="form-group"><label>Start Date</label><input class="form-control" type="date" id="fProvStart"></div>
      </div>
      <div class="form-group form-full" id="provClientGroup" style="display:none;margin-bottom:14px">
        <label>Client</label><select class="form-control" id="fProvClient"></select>
      </div>
      <div class="form-group" style="margin-bottom:16px"><label>Notes</label><textarea class="form-control"
          id="fProvNotes"></textarea></div>
      <button class="btn btn-primary" onclick="saveProvider()">Save Provider</button>
    </div>
  </div>

  <!-- Client Modal -->
  <div class="modal-overlay" id="clientModal">
    <div class="modal modal-sm">
      <div class="modal-header">
        <h2>Add Client Account</h2>
        <button class="modal-close" onclick="closeModal('clientModal')">&times;</button>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Username *</label><input class="form-control" id="fCUsername"></div>
        <div class="form-group"><label>Password *</label><input class="form-control" id="fCPassword"></div>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Company *</label><input class="form-control" id="fCCompany"></div>
        <div class="form-group"><label>Contact Name</label><input class="form-control" id="fCContact"></div>
      </div>
      <div class="form-grid">
        <div class="form-group"><label>Email</label><input class="form-control" type="email" id="fCEmail"></div>
        <div class="form-group"><label>Phone</label><input class="form-control" id="fCPhone"></div>
      </div>
      <button class="btn btn-primary" style="margin-top:8px" onclick="saveClient()">Create Client</button>
    </div>
  </div>

  <script>
    'use strict';
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let currentUser = null;
    let activeClientId = null;
    let activeSubProfile = null;  // null = All, 'MHP', 'OMT'
    let activeClientPracticeType = '';
    let clientsList = [];
    let allClaims = [];
    let activeQueueStatus = 'All';
    const QUEUE_STATUSES = ['All', 'Intake', 'Verification', 'Coding', 'Billed/Submitted', 'Rejected', 'Denied', 'A/R Follow-Up', 'Appeals', 'Paid', 'Closed'];

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GLOBAL FETCH WRAPPER ‚Äî auth for ALL API calls
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const _nativeFetch = window.fetch.bind(window);
    window.fetch = async function (url, opts = {}) {
      // For all hub API calls, ensure credentials are sent and handle 401
      if (typeof url === 'string' && url.startsWith('/hub/api/')) {
        opts.credentials = opts.credentials || 'same-origin';
        const resp = await _nativeFetch(url, opts);
        // If 401 on any API call (except /me and /login), session is expired
        if (resp.status === 401 && !url.includes('/login') && !url.includes('/me')) {
          toast('Session expired ‚Äî please sign in again', 'error');
          setTimeout(() => doLogout(), 500);
          return resp;
        }
        return resp;
      }
      return _nativeFetch(url, opts);
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BOOT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.addEventListener('DOMContentLoaded', async () => {
      initInstanceBadge();

      // Enter key on login
      document.getElementById('loginPass').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
      // Escape to close modals
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open'));
      });
      document.querySelectorAll('.modal-overlay').forEach(m => {
        m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
      });

      // Ping server immediately so it wakes up before user hits Sign In
      fetch('/hub/api/me').catch(() => { });

      try {
        const r = await fetch('/hub/api/me');
        if (r.ok) { const u = await r.json(); currentUser = u; await showAccountSelector(); }
      } catch (_) { }
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // AUTH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function doLogin() {
      const username = document.getElementById('loginUser').value.trim();
      const password = document.getElementById('loginPass').value;
      const errEl = document.getElementById('loginError');
      const btn = document.getElementById('btnLogin');
      const statusEl = document.getElementById('loginStatus');
      errEl.style.display = 'none';
      if (!username || !password) { showLoginError('Please enter username and password'); return; }
      btn.disabled = true;
      btn.textContent = 'Signing in‚Ä¶';
      statusEl.style.display = 'block';

      // Retry logic for cold-start servers
      let lastErr = null;
      for (let attempt = 1; attempt <= 3; attempt++) {
        try {
          if (attempt > 1) {
            statusEl.textContent = `Server waking up‚Ä¶ retrying (attempt ${attempt}/3)`;
            await new Promise(r => setTimeout(r, 3000));
          } else {
            statusEl.textContent = 'Connecting to server‚Ä¶';
          }
          const controller = new AbortController();
          const tid = setTimeout(() => controller.abort(), 45000);
          const r = await fetch('/hub/api/login', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
            signal: controller.signal
          });
          clearTimeout(tid);
          if (!r.ok) {
            const d = await r.json().catch(() => ({}));
            throw new Error(d.detail || 'Invalid credentials');
          }
          const d = await r.json();
          currentUser = d.user;
          statusEl.style.display = 'none';
          await showAccountSelector();
          return;
        } catch (e) {
          lastErr = e;
          if (e.message === 'Invalid credentials') break; // Don't retry wrong passwords
          if (attempt === 3) break;
        }
      }
      statusEl.style.display = 'none';
      if (lastErr?.name === 'AbortError') {
        showLoginError('Server is waking up ‚Äî please wait a moment and try again');
      } else {
        showLoginError(lastErr?.message || 'Login failed. Check your username and password.');
      }
      btn.disabled = false;
      btn.textContent = 'Sign In ‚Üí';
    }

    function showLoginError(msg) {
      const el = document.getElementById('loginError');
      el.textContent = msg; el.style.display = 'block';
    }

    function initInstanceBadge() {
      const el = document.getElementById('topInstanceBadge');
      if (!el) return;

      const host = window.location.host || 'unknown-host';
      const isLocal = host.includes('localhost') || host.startsWith('127.0.0.1');
      const env = isLocal ? 'LOCAL' : 'REMOTE';
      const buildMeta = document.querySelector('meta[name="build"]');
      const build = buildMeta?.content ? ` ¬∑ b${String(buildMeta.content).slice(-6)}` : '';

      el.textContent = `${env} ¬∑ ${host}${build}`;
      if (isLocal) {
        el.style.background = '#ecfdf5';
        el.style.color = '#065f46';
        el.style.border = '1px solid #a7f3d0';
      } else {
        el.style.background = '#fef3c7';
        el.style.color = '#92400e';
        el.style.border = '1px solid #fcd34d';
      }
    }

    function togglePw() {
      const inp = document.getElementById('loginPass');
      const btn = document.getElementById('btnShowPw');
      if (inp.type === 'password') { inp.type = 'text'; btn.textContent = 'HIDE'; btn.style.background = 'linear-gradient(135deg,#dbeafe,#bfdbfe)'; }
      else { inp.type = 'password'; btn.textContent = 'SHOW'; btn.style.background = 'linear-gradient(135deg,#eff6ff,#dbeafe)'; }
    }

    async function doLogout() {
      await fetch('/hub/api/logout', { method: 'POST' }).catch(() => { });
      currentUser = null; activeClientId = null; activeSubProfile = null; activeClientPracticeType = '';
      document.getElementById('appShell').style.display = 'none';
      document.getElementById('accountSelect').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'block';
      // Reset login form state
      const btn = document.getElementById('btnLogin');
      btn.disabled = false; btn.textContent = 'Sign In ‚Üí';
      document.getElementById('loginError').style.display = 'none';
      document.getElementById('loginStatus').style.display = 'none';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ACCOUNT SELECTOR
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function showAccountSelector() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('appShell').style.display = 'none';
      document.getElementById('accountSelect').style.display = 'block';

      // All users see all client accounts ‚Äî with error handling for cold starts
      try {
        const controller = new AbortController();
        const tid = setTimeout(() => controller.abort(), 30000);
        const r = await fetch('/hub/api/accounts', { signal: controller.signal });
        clearTimeout(tid);
        if (!r.ok) throw new Error('Failed to load accounts (status ' + r.status + ')');
        const d = await r.json();
        clientsList = Array.isArray(d) ? d : (Array.isArray(d.clients) ? d.clients : []);
      } catch (e) {
        console.error('showAccountSelector error:', e);
        clientsList = [];
      }

      const grid = document.getElementById('accountGrid');
      if (clientsList.length === 0) {
        grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px 20px;">
          <div style="font-size:32px;margin-bottom:12px;">‚ö†Ô∏è</div>
          <div style="color:#64748b;margin-bottom:16px;">Could not load accounts. The server may still be waking up.</div>
          <button onclick="showAccountSelector()" style="padding:10px 24px;border-radius:8px;border:none;background:#4338ca;color:#fff;font-weight:600;cursor:pointer;">Retry</button>
          <button onclick="doLogout()" style="padding:10px 24px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;color:#475569;font-weight:600;cursor:pointer;margin-left:8px;">Back to Login</button>
        </div>`;
      } else {
        grid.innerHTML = clientsList.map(c => `
    <div class="account-card" onclick="selectAccount(${c.id}, '${esc(c.company)}')">
      <div class="ac-icon">üè•</div>
      <div class="ac-name">${esc(c.company)}</div>
      <div class="ac-contact">${esc(c.contact_name || '')}${c.email ? ` ¬∑ ${esc(c.email)}` : ''}</div>
      <div class="ac-badge"><span>‚óè</span> Active</div>
    </div>
  `).join('');
      }
    }

    function selectAccount(clientId, company) {
      activeClientId = clientId;
      activeSubProfile = null;  // reset sub-profile when switching accounts
      document.getElementById('accountSelect').style.display = 'none';
      document.getElementById('appShell').style.display = 'block';
      document.getElementById('topAccount').textContent = company;
      document.getElementById('topUser').textContent = currentUser.username;
      // Hide the role pill for regular users; only show for admin
      const rolePill = document.getElementById('topRole');
      if (currentUser.role === 'admin') {
        rolePill.textContent = 'Admin';
        rolePill.style.display = '';
      } else {
        rolePill.style.display = 'none';
      }
      document.getElementById('adminNav').style.display = 'block';
      // Determine practice_type for selected client
      const sel = clientsList.find(c => c.id === clientId);
      const pt = (sel && sel.practice_type) ? sel.practice_type : (currentUser.practice_type || '');
      activeClientPracticeType = pt;
      updateNavForPracticeType(pt);
      updateSubProfileBar();
      navTo('dashboard');
    }

    function updateSubProfileBar() {
      const bar = document.getElementById('subProfileBar');
      if (activeClientPracticeType === 'MHP+OMT') {
        bar.style.display = 'flex';
        renderSubProfileTabs();
      } else {
        bar.style.display = 'none';
      }
    }

    function renderSubProfileTabs() {
      const tabs = [
        { key: null, label: 'All (Combined)' },
        { key: 'MHP', label: 'üè• MHP (Michigan Health Partners)' },
        { key: 'OMT', label: 'ü¶¥ OMT (Manual Therapy)' },
      ];
      document.getElementById('subProfileTabs').innerHTML = tabs.map(t => {
        const active = activeSubProfile === t.key;
        return `<button onclick="setSubProfile(${t.key === null ? 'null' : "'" + t.key + "'"})"
          style="padding:5px 14px;border-radius:6px;font-size:12px;font-weight:${active ? '700' : '500'};
          cursor:pointer;border:1px solid ${active ? '#4338ca' : '#a5b4fc'};
          background:${active ? '#4338ca' : '#fff'};color:${active ? '#fff' : '#4338ca'};
          transition:all .15s">${t.label}</button>`;
      }).join('');
    }

    function setSubProfile(sp) {
      activeSubProfile = sp;
      renderSubProfileTabs();
      // Refresh the current panel
      const activePanel = document.querySelector('.hub-panel.active');
      if (activePanel) {
        const id = activePanel.id.replace('panel-', '');
        if (id === 'dashboard') loadDashboard();
        else if (id === 'claims') loadClaims();
        else if (id === 'credentialing') loadCred();
        else if (id === 'edi') loadEdi();
        else if (id === 'providers') loadProviders();
      }
    }

    // Build query string helper for sub_profile
    function subProfileParam(sep) {
      return activeSubProfile ? `${sep}sub_profile=${encodeURIComponent(activeSubProfile)}` : '';
    }

    function updateNavForPracticeType(pt) {
      const isLab = pt === 'Laboratory';
      const credLabel = document.getElementById('navCredLabel');
      const credTitle = document.getElementById('credPanelTitle');
      if (credLabel) credLabel.textContent = isLab ? 'Group Contracting' : 'Credentialing';
      if (credTitle) credTitle.textContent = isLab ? 'Group Contracting' : 'Credentialing';
    }

    function switchAccount() { showAccountSelector(); }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NAVIGATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function navTo(panel) {
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.querySelectorAll('.hub-panel').forEach(p => p.classList.remove('active'));
      const ni = document.querySelector(`[data-panel="${panel}"]`);
      if (ni) ni.classList.add('active');
      const pp = document.getElementById(`panel-${panel}`);
      if (pp) pp.classList.add('active');
      // Close sidebar on mobile after navigation
      closeMobileSidebar();

      if (panel === 'dashboard') loadDashboard();
      if (panel === 'claims') loadClaims();
      if (panel === 'credentialing') loadCred();
      if (panel === 'edi') loadEdi();
      if (panel === 'providers') loadProviders();
      if (panel === 'clients') loadClients();
      if (panel === 'files') loadDocuments();
      if (panel === 'profile') loadProfile();
      if (panel === 'reporting') loadReport();
      if (panel === 'production') loadProduction();
      if (panel === 'alerts') loadAlerts();
      if (panel === 'audit') loadAuditLog();
    }

    function toggleMobileSidebar() {
      const sb = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      const btn = document.getElementById('hamburgerBtn');
      const isOpen = sb.classList.contains('mobile-open');
      if (isOpen) {
        sb.classList.remove('mobile-open');
        overlay.classList.remove('show');
        btn.classList.remove('open');
        document.body.style.overflow = '';
      } else {
        sb.classList.add('mobile-open');
        overlay.classList.add('show');
        btn.classList.add('open');
        document.body.style.overflow = 'hidden';
      }
    }

    function closeMobileSidebar() {
      const sb = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      const btn = document.getElementById('hamburgerBtn');
      if (sb) sb.classList.remove('mobile-open');
      if (overlay) overlay.classList.remove('show');
      if (btn) btn.classList.remove('open');
      document.body.style.overflow = '';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DASHBOARD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadDashboard() {
      const url = activeClientId
        ? `/hub/api/dashboard/client/${activeClientId}${activeSubProfile ? '?sub_profile=' + encodeURIComponent(activeSubProfile) : ''}`
        : '/hub/api/dashboard';
      try {
        const r = await fetch(url);
        const d = await r.json();
        renderDashboard(d);
      } catch (e) { console.error(e); }
    }

    function renderDashboard(d) {
      const adminView = currentUser && currentUser.role === 'admin';
      let title = d.user ? `${d.user.company || 'Dashboard'}` : 'Dashboard';
      if (activeSubProfile) title += ` ‚Äî ${activeSubProfile}`;
      document.getElementById('dashTitle').textContent = title;

      // ‚îÄ‚îÄ Profile card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const prof = d.profile || {};
      const profileCard = document.getElementById('profileCard');
      // For MHP+OMT (e.g. Luminary): don't show profile card ‚Äî profiles live in sub-profiles only
      const isCombinedPractice = activeClientPracticeType === 'MHP+OMT';
      const hasProfile = !isCombinedPractice && (prof.company || prof.tax_id || prof.group_npi);
      profileCard.style.display = hasProfile ? '' : 'none';
      if (hasProfile) {
        const profItem = (label, val, mono) => val
          ? `<div style="background:var(--gray-50);border:1px solid var(--gray-200);border-radius:8px;padding:10px 14px">
               <div style="font-size:11px;color:var(--gray-400);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">${label}</div>
               <div style="font-size:14px;font-weight:700;color:var(--gray-800);${mono ? 'font-family:monospace' : ''};display:flex;align-items:center;gap:6px">
                 ${esc(val)}
                 <button onclick="navigator.clipboard.writeText('${val}')" title="Copy"
                   style="background:none;border:none;cursor:pointer;color:var(--gray-400);font-size:13px;padding:0;line-height:1">‚éò</button>
               </div>
             </div>`
          : '';
        document.getElementById('prof-company').innerHTML = profItem('Practice Name', prof.company);
        document.getElementById('prof-specialty').innerHTML = profItem('Specialty', prof.specialty);
        document.getElementById('prof-taxid').innerHTML = profItem('Tax ID', prof.tax_id, true);
        document.getElementById('prof-gnpi').innerHTML = profItem('Group NPI', prof.group_npi, true);
        document.getElementById('prof-inpi').innerHTML = profItem('Individual NPI', prof.individual_npi, true);
        document.getElementById('prof-ptangrp').innerHTML = profItem('Medicare PTAN (Group)', prof.ptan_group, true);
        document.getElementById('prof-ptanind').innerHTML = profItem('Medicare PTAN (Individual)', prof.ptan_individual, true);
        document.getElementById('prof-contact').innerHTML = profItem('Contact', prof.contact_name);
        document.getElementById('prof-email').innerHTML = profItem('Email', prof.email);
        document.getElementById('prof-phone').innerHTML = profItem('Phone', prof.phone);
        document.getElementById('prof-address').innerHTML = profItem('Address', prof.address);
      }

      // KPI grid
      const kpis = [
        { label: 'Active Claims', val: d.active_claims || 0, color: 'indigo', icon: 'üìã' },
        { label: 'Total AR', val: '$' + fmt(d.total_ar), color: 'blue', icon: 'üí∞' },
        { label: 'Submitted MTD', val: d.submitted_mtd || 0, color: 'purple', icon: 'üì§' },
        { label: 'Payments MTD', val: '$' + fmt(d.payments_mtd), color: 'green', icon: '‚úÖ' },
        { label: 'Denials MTD', val: d.denied_mtd || 0, color: 'red', icon: '‚ùå' },
        { label: 'Clean Claim Rate', val: (d.clean_claim_rate || 0) + '%', color: 'green', icon: 'üéØ' },
        { label: 'Denial Rate', val: (d.denial_rate || 0) + '%', color: 'amber', icon: '‚ö†Ô∏è' },
        { label: 'Avg Days to Pay', val: (d.avg_days_to_pay || 0) + ' days', color: 'blue', icon: 'üìÖ' },
      ];
      if (adminView) kpis.push({ label: 'SLA Breaches', val: d.sla_breaches || 0, color: 'red', icon: 'üö®' });

      document.getElementById('kpiGrid').innerHTML = kpis.map(k => `
    <div class="kpi-card ${k.color}">
      <div style="font-size:22px;margin-bottom:8px">${k.icon}</div>
      <div class="kpi-value">${k.val}</div>
      <div class="kpi-label">${k.label}</div>
    </div>
  `).join('');

      // Data Summary Card (shows record counts per section)
      const summaryCard = document.getElementById('dashSummaryCard');
      const cs = d.credentialing_stats || {};
      const claimCount = d.active_claims || 0;
      const credCount = Object.values(cs).reduce((a, b) => a + (b || 0), 0);
      const hasData = claimCount || credCount;
      summaryCard.style.display = hasData ? '' : 'none';
      if (hasData) {
        const sbox = (icon, label, val, clr) => `<div style="background:${clr};border-radius:8px;padding:12px;text-align:center">
          <div style="font-size:18px">${icon}</div><div style="font-size:20px;font-weight:700;color:var(--gray-800)">${val}</div>
          <div style="font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">${label}</div></div>`;
        document.getElementById('dashSummaryBody').innerHTML =
          sbox('üìã', 'Claims', claimCount, 'var(--info-light)') +
          sbox('üéì', 'Credentialing', credCount, 'var(--purple-light)') +
          sbox('üí∞', 'Payments MTD', '$' + fmt(d.payments_mtd), 'var(--warning-light)');
      }

      // AR Aging
      const aging = d.ar_aging || { current: 0, days_31_60: 0, days_61_90: 0, days_90_plus: 0 };
      document.getElementById('agingGrid').innerHTML = `
    <div class="aging-bucket">
      <div class="ab-val">$${fmt(aging.current || 0)}</div><div class="ab-lbl">0‚Äì30 Days</div>
    </div>
    <div class="aging-bucket warning">
      <div class="ab-val">$${fmt(aging.days_31_60 || 0)}</div><div class="ab-lbl">31‚Äì60 Days</div>
    </div>
    <div class="aging-bucket warning">
      <div class="ab-val">$${fmt(aging.days_61_90 || 0)}</div><div class="ab-lbl">61‚Äì90 Days</div>
    </div>
    <div class="aging-bucket danger">
      <div class="ab-val">$${fmt(aging.days_90_plus || 0)}</div><div class="ab-lbl">90+ Days</div>
    </div>
  `;

      // Status chart  
      const sd = d.status_distribution || {};
      const sdMax = Math.max(...Object.values(sd).map(Number), 1);
      const sdColors = {
        Paid: 'bf-green', 'Billed/Submitted': 'bf-blue', Denied: 'bf-red',
        'A/R Follow-up': 'bf-indigo', Appeal: 'bf-purple', Intake: 'bf-amber', Coding: 'bf-amber'
      };
      document.getElementById('statusChart').innerHTML = Object.entries(sd).length
        ? Object.entries(sd).map(([s, c]) => `
      <div class="bar-row">
        <div class="bar-lbl">${esc(s)}</div>
        <div class="bar-track">
          <div class="bar-fill ${sdColors[s] || 'bf-indigo'}" style="width:${Math.max(6, (c / sdMax) * 100)}%">${c}</div>
        </div>
      </div>`).join('')
        : '<p style="color:var(--gray-400);font-size:13px;padding:8px 0">No claims data</p>';

      // Denial categories
      const dc = d.denial_categories || {};
      const dcMax = Math.max(...Object.values(dc).map(Number), 1);
      document.getElementById('denialChart').innerHTML = Object.entries(dc).length
        ? Object.entries(dc).map(([s, c]) => `
      <div class="bar-row">
        <div class="bar-lbl">${esc(s)}</div>
        <div class="bar-track">
          <div class="bar-fill bf-red" style="width:${Math.max(6, (c / dcMax) * 100)}%">${c}</div>
        </div>
      </div>`).join('')
        : '<p style="color:var(--gray-400);font-size:13px;padding:8px 0">No denials</p>';

      // Payor mix
      const pm = d.payor_mix || {};
      const pmMax = Math.max(...Object.values(pm).map(Number), 1);
      const pmColors = ['bf-indigo', 'bf-green', 'bf-amber', 'bf-purple', 'bf-blue'];
      document.getElementById('payorChart').innerHTML = Object.entries(pm).length
        ? Object.entries(pm).map(([s, c], i) => `
      <div class="bar-row">
        <div class="bar-lbl">${esc(s)}</div>
        <div class="bar-track">
          <div class="bar-fill ${pmColors[i % pmColors.length]}" style="width:${Math.max(6, (c / pmMax) * 100)}%">${c}</div>
        </div>
      </div>`).join('')
        : '<p style="color:var(--gray-400);font-size:13px;padding:8px 0">No payor data</p>';

      // Credentialing stats
      const credStats = d.credentialing_stats || {};
      const csMax = Math.max(...Object.values(credStats).map(Number), 1);
      const csColors = {
        Approved: 'bf-green', Submitted: 'bf-blue', 'In Progress': 'bf-amber',
        'Not Started': 'bf-indigo', Denied: 'bf-red', Expired: 'bf-red'
      };
      document.getElementById('credChart').innerHTML = Object.entries(credStats).length
        ? Object.entries(credStats).map(([s, c]) => `
      <div class="bar-row">
        <div class="bar-lbl">${esc(s)}</div>
        <div class="bar-track">
          <div class="bar-fill ${csColors[s] || 'bf-indigo'}" style="width:${Math.max(6, (c / csMax) * 100)}%">${c}</div>
        </div>
      </div>`).join('')
        : '<p style="color:var(--gray-400);font-size:13px;padding:8px 0">No credentialing data</p>';
    }

    let profileCollapsed = false;
    function toggleProfile() {
      profileCollapsed = !profileCollapsed;
      document.getElementById('profileBody').style.display = profileCollapsed ? 'none' : '';
      document.getElementById('profileToggleBtn').textContent = profileCollapsed ? '‚ñº Expand' : '‚ñ≤ Collapse';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CLAIMS QUEUE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadClaims() {
      buildQueueTabs([]);
      let url = '/hub/api/claims';
      const params = new URLSearchParams();
      if (activeClientId) params.set('client_id', activeClientId);
      if (activeSubProfile) params.set('sub_profile', activeSubProfile);
      if (params.toString()) url += '?' + params;
      const r = await fetch(url);
      const d = await r.json();
      allClaims = d.claims || [];
      buildQueueTabs(allClaims);
      renderClaimsForStatus(activeQueueStatus);
      // Render interactive status chart for claims
      const CLAIMS_CHART_STATUSES = ['Intake', 'Verification', 'Coding', 'Billed/Submitted', 'Rejected', 'Denied', 'A/R Follow-Up', 'Appeals', 'Paid', 'Closed'];
      renderSectionChart('claimsStatusChart', allClaims, 'ClaimStatus', CLAIMS_CHART_STATUSES, (status) => {
        if (status) { activeQueueStatus = status; } else { activeQueueStatus = 'All'; }
        buildQueueTabs(allClaims);
        renderClaimsForStatus(activeQueueStatus);
      });

      // Render visual charts for claims section
      renderClaimsSectionCharts(allClaims);
    }

    function renderClaimsSectionCharts(claims) {
      // Status distribution donut
      const statusCounts = {};
      claims.forEach(c => { const s = c.ClaimStatus || 'Unknown'; statusCounts[s] = (statusCounts[s] || 0) + 1; });
      const statusData = Object.entries(statusCounts).map(([label, value]) => ({ label, value })).sort((a, b) => b.value - a.value);
      renderDonutChart('claimsSectionDonut', statusData, 'value', 'label');

      // Payor mix donut
      const payorCounts = {};
      claims.forEach(c => { const p = c.Payor || 'Unknown'; payorCounts[p] = (payorCounts[p] || 0) + 1; });
      const payorData = Object.entries(payorCounts).map(([label, value]) => ({ label, value })).sort((a, b) => b.value - a.value).slice(0, 8);
      renderDonutChart('claimsSectionPayor', payorData, 'value', 'label');

      // Financial summary bar
      const totalCharged = claims.reduce((s, c) => s + (parseFloat(c.ChargeAmount) || 0), 0);
      const totalPaid = claims.reduce((s, c) => s + (parseFloat(c.PaidAmount) || 0), 0);
      const totalBalance = claims.reduce((s, c) => s + (parseFloat(c.BalanceRemaining) || 0), 0);
      const totalAdj = claims.reduce((s, c) => s + (parseFloat(c.AdjustmentAmount) || 0), 0);
      const finData = [
        { label: 'Total Charged', value: Math.round(totalCharged) },
        { label: 'Total Paid', value: Math.round(totalPaid) },
        { label: 'Adjustments', value: Math.round(totalAdj) },
        { label: 'Outstanding', value: Math.round(totalBalance) },
      ].filter(d => d.value > 0);
      if (finData.length) {
        const fMax = Math.max(...finData.map(d => d.value), 1);
        const fColors = ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444'];
        document.getElementById('claimsSectionFinancials').innerHTML = finData.map((d, i) => `
          <div style="margin-bottom:10px">
            <div style="display:flex;justify-content:space-between;font-size:12px;font-weight:600;margin-bottom:3px;color:var(--gray-700)">
              <span>${d.label}</span><span>$${d.value.toLocaleString()}</span>
            </div>
            <div style="background:var(--gray-100);border-radius:6px;height:22px;overflow:hidden">
              <div style="width:${Math.max(6, (d.value / fMax) * 100)}%;height:100%;background:${fColors[i]};border-radius:6px;transition:width .5s"></div>
            </div>
          </div>`).join('');
      } else {
        document.getElementById('claimsSectionFinancials').innerHTML = '<p style="color:var(--gray-400);font-size:12px;text-align:center">No financial data</p>';
      }
    }

    function buildQueueTabs(claims) {
      const counts = {};
      QUEUE_STATUSES.forEach(s => { counts[s] = s === 'All' ? claims.length : claims.filter(c => (c.ClaimStatus || '').toLowerCase() === s.toLowerCase()).length; });
      document.getElementById('queueTabs').innerHTML = `
        <button class="btn btn-danger btn-sm" style="margin-right:16px" onclick="bulkDeleteClaims()">üóë Bulk Delete Selected</button>
      ` + QUEUE_STATUSES.map(s => `
        <button class="qtab ${s === activeQueueStatus ? 'active' : ''}" onclick="setQueueTab('${s}')">
          ${s} <span class="cnt">${counts[s] || 0}</span>
        </button>`).join('');
    }

    function setQueueTab(status) {
      activeQueueStatus = status;
      buildQueueTabs(allClaims);
      renderClaimsForStatus(status);
    }

    function renderClaimsForStatus(status) {
      const datePick = document.getElementById('claimsDatePicker')?.value || '';
      let list = status === 'All' ? allClaims : allClaims.filter(c => (c.ClaimStatus || '').toLowerCase() === status.toLowerCase());
      if (datePick) list = list.filter(c => (c.DOS || '') === datePick || (c.StatusStartDate || '') === datePick);
      const search = document.getElementById('claimSearch')?.value?.toLowerCase() || '';
      const filtered = search ? list.filter(c =>
        (c.ClaimKey || '').toLowerCase().includes(search) ||
        (c.PatientName || '').toLowerCase().includes(search) ||
        (c.Payor || '').toLowerCase().includes(search) ||
        (c.PatientID || '').toLowerCase().includes(search)
      ) : list;

      const tbody = document.getElementById('claimsTbody');
      if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="14"><div class="empty-state"><div class="es-icon">üìã</div><p>No claims in this queue</p></div></td></tr>`;
        return;
      }

      tbody.innerHTML = filtered.map(c => {
        const slaClass = c.SLABreached ? 'style="background:#fff0f0"' : '';
        return `<tr ${slaClass}>
      <td><input type="checkbox" class="claim-cb" value="${c.id}" onchange="updateBulkBar()"></td>
      <td style="font-family:monospace;font-weight:700;font-size:12px">${esc(c.ClaimKey)}${c.SLABreached ? '<br><span class="badge badge-red" style="font-size:9px">SLA!</span>' : ''}</td>
      <td>${esc(c.PatientName || c.PatientID || '‚Äî')}</td>
      <td style="font-size:12px">${esc(c.ProviderName || '‚Äî')}</td>
      <td>${esc(c.Payor || '‚Äî')}</td>
      <td style="font-size:12px">${c.DOS || '‚Äî'}</td>
      <td style="font-weight:600">$${fmt(c.ChargeAmount)}</td>
      <td style="color:var(--success);font-weight:600">$${fmt(c.PaidAmount)}</td>
      <td style="color:${c.BalanceRemaining > 0 ? 'var(--danger)' : 'var(--gray-400)'};font-weight:600">$${fmt(c.BalanceRemaining)}</td>
      <td>${statusBadge(c.ClaimStatus)}</td>
      <td style="font-size:12px">${esc(c.Owner || '‚Äî')}</td>
      <td style="font-size:12px;max-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(c.NextAction || '‚Äî')}</td>
      <td style="font-size:12px;${c.NextActionDueDate && new Date(c.NextActionDueDate) < new Date() ? 'color:var(--danger);font-weight:600' : ''}">${c.NextActionDueDate || '‚Äî'}</td>
      <td style="white-space:nowrap"><button class="btn btn-secondary btn-sm" onclick="editClaim(${c.id})">Edit</button> <button class="btn btn-sm" style="color:var(--danger);background:var(--danger-light);border:1px solid #fca5a5" onclick="deleteClaimRow(${c.id})">üóë Delete</button></td>
    </tr>`;
      }).join('');
    }

    async function bulkDeleteClaims() {
      const checked = Array.from(document.querySelectorAll('.claim-cb:checked')).map(cb => cb.value);
      if (!checked.length) { toast('No claims selected', 'warning'); return; }
      if (!confirm(`Delete ${checked.length} selected claim(s)? This cannot be undone.`)) return;
      let deleted = 0;
      for (const id of checked) {
        try {
          const r = await fetch(`/hub/api/claims/${id}`, { method: 'DELETE' });
          if (r.ok) deleted++;
        } catch (e) { /* continue */ }
      }
      toast(`Deleted ${deleted} claim(s)`, 'success');
      loadClaims(); loadDashboard();
    }

    function filterClaimsTable() { renderClaimsForStatus(activeQueueStatus); }

    function clearClaimsDatePicker() {
      const input = document.getElementById('claimsDatePicker');
      if (input) input.value = '';
      filterClaimsTable();
    }

    function openClaimModal(claim) {
      const editId = claim?.id || '';
      document.getElementById('claimEditId').value = editId;
      document.getElementById('claimModalTitle').textContent = claim ? 'Edit Claim' : 'New Claim';
      document.getElementById('fClaimKey').value = claim?.ClaimKey || '';
      document.getElementById('fPatientID').value = claim?.PatientID || '';
      document.getElementById('fPatientName').value = claim?.PatientName || '';
      document.getElementById('fPayor').value = claim?.Payor || '';
      document.getElementById('fProviderName').value = claim?.ProviderName || '';
      document.getElementById('fNPI').value = claim?.NPI || '';
      document.getElementById('fCPT').value = claim?.CPTCode || '';
      document.getElementById('fDOS').value = claim?.DOS || '';
      document.getElementById('fCharge').value = claim?.ChargeAmount || 0;
      document.getElementById('fAllowed').value = claim?.AllowedAmount || 0;
      document.getElementById('fPaid').value = claim?.PaidAmount || 0;
      document.getElementById('fBalance').value = claim?.BalanceRemaining || 0;
      document.getElementById('fClaimStatus').value = claim?.ClaimStatus || 'Intake';
      document.getElementById('fOwner').value = claim?.Owner || '';
      document.getElementById('fBillDate').value = claim?.BillDate || '';
      document.getElementById('fDeniedDate').value = claim?.DeniedDate || '';
      document.getElementById('fDenialCat').value = claim?.DenialCategory || '';
      document.getElementById('fDenialReason').value = claim?.DenialReason || '';
      document.getElementById('fNextAction').value = claim?.NextAction || '';
      document.getElementById('fNextActionDue').value = claim?.NextActionDueDate || '';
      document.getElementById('fPaidDate').value = claim?.PaidDate || '';
      document.getElementById('fAppealDate').value = claim?.AppealDate || '';
      document.getElementById('fAppealStatus').value = claim?.AppealStatus || '';
      document.getElementById('fSLA').value = claim?.SLABreached || 0;

      if (currentUser.role === 'admin') {
        document.getElementById('claimClientGroup').style.display = '';
        populateClientDrop('fClaimClient', claim?.client_id);
      }

      // Show notes+payments only when editing
      document.getElementById('notesSection').style.display = editId ? '' : 'none';
      document.getElementById('paymentsSection').style.display = editId ? '' : 'none';
      if (editId) { loadClaimNotes(claim.ClaimKey); loadClaimPayments(claim.ClaimKey); }

      document.getElementById('claimModal').classList.add('open');
    }

    function editClaim(id) {
      const c = allClaims.find(x => x.id === id);
      if (c) openClaimModal(c);
    }

    async function saveClaim() {
      const editId = document.getElementById('claimEditId').value;
      const data = {
        ClaimKey: document.getElementById('fClaimKey').value,
        PatientID: document.getElementById('fPatientID').value,
        PatientName: document.getElementById('fPatientName').value,
        Payor: document.getElementById('fPayor').value,
        ProviderName: document.getElementById('fProviderName').value,
        NPI: document.getElementById('fNPI').value,
        CPTCode: document.getElementById('fCPT').value,
        DOS: document.getElementById('fDOS').value,
        ChargeAmount: parseFloat(document.getElementById('fCharge').value) || 0,
        AllowedAmount: parseFloat(document.getElementById('fAllowed').value) || 0,
        PaidAmount: parseFloat(document.getElementById('fPaid').value) || 0,
        BalanceRemaining: parseFloat(document.getElementById('fBalance').value) || 0,
        ClaimStatus: document.getElementById('fClaimStatus').value,
        Owner: document.getElementById('fOwner').value,
        BillDate: document.getElementById('fBillDate').value,
        DeniedDate: document.getElementById('fDeniedDate').value,
        DenialCategory: document.getElementById('fDenialCat').value,
        DenialReason: document.getElementById('fDenialReason').value,
        NextAction: document.getElementById('fNextAction').value,
        NextActionDueDate: document.getElementById('fNextActionDue').value,
        PaidDate: document.getElementById('fPaidDate').value,
        AppealDate: document.getElementById('fAppealDate').value,
        AppealStatus: document.getElementById('fAppealStatus').value,
        SLABreached: parseInt(document.getElementById('fSLA').value) || 0,
      };

      try {
        if (editId) {
          const r = await fetch(`/hub/api/claims/${editId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
          });
          if (!r.ok) throw new Error((await r.json()).detail || 'Failed');
        } else {
          data.client_id = currentUser.role === 'admin'
            ? parseInt(document.getElementById('fClaimClient').value) || activeClientId
            : activeClientId || currentUser.id;
          if (activeSubProfile) data.sub_profile = activeSubProfile;
          const r = await fetch('/hub/api/claims', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
          });
          if (!r.ok) throw new Error((await r.json()).detail || 'Failed');
        }
        closeModal('claimModal');
        loadClaims();
        toast('Claim saved', 'success');
      } catch (e) { toast(e.message, 'error'); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NOTES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadClaimNotes(claimKey) {
      const r = await fetch(`/hub/api/notes?claim_key=${encodeURIComponent(claimKey)}`);
      const d = await r.json();
      const notes = d.notes || d || [];
      document.getElementById('notesList').innerHTML = notes.length
        ? notes.map(n => `
        <div class="note-item">
          <div class="note-meta">${esc(n.Author || 'Unknown')} ¬∑ ${(n.CreatedAt || '').slice(0, 16)}</div>
          <div class="note-text">${esc(n.Note)}</div>
        </div>`).join('')
        : '<p style="font-size:13px;color:var(--gray-400)">No notes yet</p>';
    }

    async function addNote() {
      const editId = document.getElementById('claimEditId').value;
      const claim = allClaims.find(c => c.id === parseInt(editId));
      const text = document.getElementById('newNoteText').value.trim();
      if (!text || !claim) return;
      await fetch('/hub/api/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ClaimKey: claim.ClaimKey, Note: text, Module: 'Claim' })
      });
      document.getElementById('newNoteText').value = '';
      loadClaimNotes(claim.ClaimKey);
      toast('Note added', 'success');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PAYMENTS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadClaimPayments(claimKey) {
      const r = await fetch(`/hub/api/claims/${encodeURIComponent(claimKey)}/payments`);
      const d = await r.json();
      const pays = d.payments || d || [];
      document.getElementById('paymentsList').innerHTML = pays.length
        ? pays.map(p => `
        <div class="pay-item">
          <div class="pay-left">
            <div class="pay-amount">$${fmt(p.PaymentAmount)}</div>
            <div class="pay-meta">${p.PostDate || '‚Äî'} ¬∑ ${esc(p.PayerType || '')}</div>
          </div>
          <div style="display:flex;gap:6px;align-items:center">
            ${p.AdjustmentAmount ? `<span style="font-size:12px;color:var(--gray-500)">Adj: -$${fmt(p.AdjustmentAmount)}</span>` : ''}
            <button class="btn-icon" onclick="deletePayment(${p.id})">üóë</button>
          </div>
        </div>`).join('')
        : '<p style="font-size:13px;color:var(--gray-400)">No payments recorded</p>';
    }

    async function addPayment() {
      const editId = document.getElementById('claimEditId').value;
      const claim = allClaims.find(c => c.id === parseInt(editId));
      if (!claim) return;
      const data = {
        ClaimKey: claim.ClaimKey,
        PostDate: document.getElementById('payDate').value,
        PaymentAmount: parseFloat(document.getElementById('payAmount').value) || 0,
        PayerType: document.getElementById('payType').value,
      };
      await fetch(`/hub/api/claims/${claim.ClaimKey}/payments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
      });
      document.getElementById('payAmount').value = '0';
      loadClaimPayments(claim.ClaimKey);
      toast('Payment recorded', 'success');
    }

    async function deletePayment(id) {
      if (!confirm('Remove this payment?')) return;
      const editId = document.getElementById('claimEditId').value;
      const claim = allClaims.find(c => c.id === parseInt(editId));
      await fetch(`/hub/api/payments/${id}`, { method: 'DELETE' });
      if (claim) loadClaimPayments(claim.ClaimKey);
      toast('Payment removed');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CREDENTIALING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let allCredItems = [];
    let activeCredFilter = '';
    async function loadCred() {
      // Always fetch ALL items for chart, then filter locally
      const params = new URLSearchParams();
      if (activeClientId) params.set('client_id', activeClientId);
      if (activeSubProfile) params.set('sub_profile', activeSubProfile);
      const r = await fetch('/hub/api/credentialing?' + params);
      const d = await r.json();
      allCredItems = d.credentialing || d || [];

      // Render chart strip
      const CRED_STATUSES = ['Not Started', 'In Progress', 'Submitted', 'Approved', 'Denied', 'Expired'];
      renderSectionChart('credStatusChart', allCredItems, 'Status', CRED_STATUSES, (status) => {
        activeCredFilter = status || '';
        document.getElementById('credFilter').value = activeCredFilter;
        renderCredTable();
      });

      // Sync dropdown with pill state
      activeCredFilter = document.getElementById('credFilter').value;
      syncPillHighlight('credStatusChart', activeCredFilter);
      renderCredTable();

      // Render visual charts for credentialing section
      renderCredSectionCharts(allCredItems);
    }

    function renderCredSectionCharts(items) {
      // Status distribution donut
      const statusCounts = {};
      items.forEach(c => { const s = c.Status || 'Unknown'; statusCounts[s] = (statusCounts[s] || 0) + 1; });
      const statusData = Object.entries(statusCounts).map(([label, value]) => ({ label, value })).sort((a, b) => b.value - a.value);
      renderDonutChart('credSectionDonut', statusData, 'value', 'label');

      // Payor breakdown bar chart
      const payorCounts = {};
      items.forEach(c => { const p = c.Payor || 'Unknown'; payorCounts[p] = (payorCounts[p] || 0) + 1; });
      const payorData = Object.entries(payorCounts).map(([label, value]) => ({ label, value })).sort((a, b) => b.value - a.value).slice(0, 10);
      renderBarChart('credSectionPayor', payorData, 'value', 'label');
    }

    function renderCredTable() {
      const items = activeCredFilter
        ? allCredItems.filter(i => (i.Status || '').toLowerCase() === activeCredFilter.toLowerCase())
        : allCredItems;
      const tbody = document.getElementById('credTbody');
      if (!items.length) {
        tbody.innerHTML = `<tr><td colspan="11"><div class="empty-state"><div class="es-icon">üéì</div><p>No credentialing items</p></div></td></tr>`;
        return;
      }
      tbody.innerHTML = items.map(i => `<tr>
    <td style="font-weight:600">${esc(i.ProviderName || '‚Äî')}</td>
    <td>${esc(i.Payor || '‚Äî')}</td>
    <td><span class="badge badge-indigo">${esc(i.CredType || '')}</span></td>
    <td>${statusBadge(i.Status)}</td>
    <td style="font-size:12px">${i.SubmittedDate || '‚Äî'}</td>
    <td style="font-size:12px;${i.FollowUpDate && new Date(i.FollowUpDate) < new Date() ? 'color:var(--danger);font-weight:600' : ''}">${i.FollowUpDate || '‚Äî'}</td>
    <td style="font-size:12px">${i.ApprovedDate || '‚Äî'}</td>
    <td style="font-size:12px;${i.ExpirationDate && new Date(i.ExpirationDate) < new Date() ? 'color:var(--danger);font-weight:600' : ''}">${i.ExpirationDate || '‚Äî'}</td>
    <td style="font-size:12px">${esc(i.Owner || '‚Äî')}</td>
    <td style="font-size:12px;max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(i.Notes || '')}</td>
    <td style="white-space:nowrap"><button class="btn btn-secondary btn-sm" onclick="editCredItem(${i.id})">Edit</button> <button class="btn btn-sm" style="color:var(--danger);background:var(--danger-light);border:1px solid #fca5a5" onclick="deleteCredRow(${i.id})">üóë</button></td>
  </tr>`).join('');
    }

    let credItems = [];
    async function editCredItem(id) {
      const r = await fetch('/hub/api/credentialing');
      const d = await r.json();
      credItems = d.credentialing || d || [];
      const item = credItems.find(x => x.id === id);
      if (item) openCredModal(item);
    }

    function openCredModal(item) {
      document.getElementById('credEditId').value = item?.id || '';
      document.getElementById('credModalTitle').textContent = item ? 'Edit Credentialing' : 'New Credentialing';
      document.getElementById('fCredProvider').value = item?.ProviderName || '';
      document.getElementById('fCredPayor').value = item?.Payor || '';
      document.getElementById('fCredType').value = item?.CredType || 'Initial';
      document.getElementById('fCredStatus').value = item?.Status || 'Not Started';
      document.getElementById('fCredSubmitted').value = item?.SubmittedDate || '';
      document.getElementById('fCredFollowUp').value = item?.FollowUpDate || '';
      document.getElementById('fCredApproved').value = item?.ApprovedDate || '';
      document.getElementById('fCredExpires').value = item?.ExpirationDate || '';
      document.getElementById('fCredOwner').value = item?.Owner || '';
      document.getElementById('fCredNotes').value = item?.Notes || '';
      if (currentUser.role === 'admin') {
        document.getElementById('credClientGroup').style.display = '';
        populateClientDrop('fCredClient', item?.client_id);
      }
      document.getElementById('credModal').classList.add('open');
    }

    async function saveCred() {
      const editId = document.getElementById('credEditId').value;
      const data = {
        ProviderName: document.getElementById('fCredProvider').value,
        Payor: document.getElementById('fCredPayor').value,
        CredType: document.getElementById('fCredType').value,
        Status: document.getElementById('fCredStatus').value,
        SubmittedDate: document.getElementById('fCredSubmitted').value,
        FollowUpDate: document.getElementById('fCredFollowUp').value,
        ApprovedDate: document.getElementById('fCredApproved').value,
        ExpirationDate: document.getElementById('fCredExpires').value,
        Owner: document.getElementById('fCredOwner').value,
        Notes: document.getElementById('fCredNotes').value,
      };
      try {
        if (editId) {
          await fetch(`/hub/api/credentialing/${editId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
          });
        } else {
          data.client_id = currentUser.role === 'admin'
            ? parseInt(document.getElementById('fCredClient').value) || activeClientId
            : activeClientId || currentUser.id;
          if (activeSubProfile) data.sub_profile = activeSubProfile;
          await fetch('/hub/api/credentialing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
          });
        }
        closeModal('credModal'); loadCred(); toast('Saved', 'success');
      } catch (e) { toast(e.message, 'error'); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EDI
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let allEdiItems = [];
    let activeEdiFilter = '';
    async function loadEdi() {
      const params = new URLSearchParams();
      if (activeClientId) params.set('client_id', activeClientId);
      if (activeSubProfile) params.set('sub_profile', activeSubProfile);
      const r = await fetch('/hub/api/edi' + (params.toString() ? '?' + params : ''));
      const d = await r.json();
      allEdiItems = (d.edi || d || []).map(i => {
        // Derive composite status from EDI/ERA/EFT fields and store on each item
        const statuses = [i.EDIStatus, i.ERAStatus, i.EFTStatus].map(s => (s || 'Not Started').trim().toLowerCase());
        let composite;
        if (statuses.some(s => s === 'failed')) composite = 'Failed';
        else if (statuses.every(s => s === 'live')) composite = 'Live';
        else if (statuses.some(s => s === 'in process' || s === 'live')) composite = 'In Process';
        else composite = 'Not Started';
        return { ...i, _composite: composite };
      });

      const EDI_STATUSES = ['Not Started', 'In Process', 'Live', 'Failed'];
      renderSectionChart('ediStatusChart', allEdiItems, '_composite', EDI_STATUSES, (status) => {
        activeEdiFilter = status || '';
        renderEdiTable();
      });

      renderEdiTable();
    }

    function renderEdiTable() {
      const items = activeEdiFilter
        ? allEdiItems.filter(i => (i._composite || '').toLowerCase() === activeEdiFilter.toLowerCase())
        : allEdiItems;
      const tbody = document.getElementById('ediTbody');
      if (!items.length) {
        tbody.innerHTML = `<tr><td colspan="11"><div class="empty-state"><div class="es-icon">üîó</div><p>No EDI setups</p></div></td></tr>`;
        return;
      }
      tbody.innerHTML = items.map(i => `<tr>
    <td style="font-weight:600">${esc(i.ProviderName || '‚Äî')}</td>
    <td>${esc(i.Payor || '‚Äî')}</td>
    <td style="font-family:monospace;font-size:12px">${esc(i.PayerID || '‚Äî')}</td>
    <td>${statusBadge(i.EDIStatus)}</td>
    <td>${statusBadge(i.ERAStatus)}</td>
    <td>${statusBadge(i.EFTStatus)}</td>
    <td style="font-size:12px">${i.SubmittedDate || '‚Äî'}</td>
    <td style="font-size:12px">${i.GoLiveDate || '‚Äî'}</td>
    <td style="font-size:12px">${esc(i.Owner || '‚Äî')}</td>
    <td style="font-size:12px;max-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(i.Notes || '')}</td>
    <td style="white-space:nowrap"><button class="btn btn-secondary btn-sm" onclick="editEdiItem(${i.id})">Edit</button> <button class="btn btn-sm" style="color:var(--danger);background:var(--danger-light);border:1px solid #fca5a5" onclick="deleteEdiRow(${i.id})">üóë</button></td>
  </tr>`).join('');
    }

    let ediItems = [];
    async function editEdiItem(id) {
      const r = await fetch('/hub/api/edi');
      const d = await r.json();
      ediItems = d.edi || d || [];
      const item = ediItems.find(x => x.id === id);
      if (item) openEdiModal(item);
    }

    function openEdiModal(item) {
      document.getElementById('ediEditId').value = item?.id || '';
      document.getElementById('ediModalTitle').textContent = item ? 'Edit EDI Setup' : 'New EDI Setup';
      document.getElementById('fEdiProvider').value = item?.ProviderName || '';
      document.getElementById('fEdiPayor').value = item?.Payor || '';
      document.getElementById('fEdiPayerID').value = item?.PayerID || '';
      document.getElementById('fEdiStatus').value = item?.EDIStatus || 'Not Started';
      document.getElementById('fEraStatus').value = item?.ERAStatus || 'Not Started';
      document.getElementById('fEftStatus').value = item?.EFTStatus || 'Not Started';
      document.getElementById('fEdiSubmitted').value = item?.SubmittedDate || '';
      document.getElementById('fEdiGoLive').value = item?.GoLiveDate || '';
      document.getElementById('fEdiOwner').value = item?.Owner || '';
      document.getElementById('fEdiNotes').value = item?.Notes || '';
      if (currentUser.role === 'admin') {
        document.getElementById('ediClientGroup').style.display = '';
        populateClientDrop('fEdiClient', item?.client_id);
      }
      document.getElementById('ediModal').classList.add('open');
    }

    async function saveEdi() {
      const editId = document.getElementById('ediEditId').value;
      const data = {
        ProviderName: document.getElementById('fEdiProvider').value,
        Payor: document.getElementById('fEdiPayor').value,
        PayerID: document.getElementById('fEdiPayerID').value,
        EDIStatus: document.getElementById('fEdiStatus').value,
        ERAStatus: document.getElementById('fEraStatus').value,
        EFTStatus: document.getElementById('fEftStatus').value,
        SubmittedDate: document.getElementById('fEdiSubmitted').value,
        GoLiveDate: document.getElementById('fEdiGoLive').value,
        Owner: document.getElementById('fEdiOwner').value,
        Notes: document.getElementById('fEdiNotes').value,
      };
      try {
        if (editId) {
          await fetch(`/hub/api/edi/${editId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
          });
        } else {
          data.client_id = currentUser.role === 'admin'
            ? parseInt(document.getElementById('fEdiClient').value) || activeClientId
            : activeClientId || currentUser.id;
          if (activeSubProfile) data.sub_profile = activeSubProfile;
          await fetch('/hub/api/edi', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
          });
        }
        closeModal('ediModal'); loadEdi(); toast('Saved', 'success');
      } catch (e) { toast(e.message, 'error'); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PROVIDERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadProviders() {
      const params = new URLSearchParams();
      if (activeClientId) params.set('client_id', activeClientId);
      if (activeSubProfile) params.set('sub_profile', activeSubProfile);
      const r = await fetch('/hub/api/providers' + (params.toString() ? '?' + params : ''));
      const d = await r.json();
      const items = d.providers || d || [];
      const tbody = document.getElementById('providerTbody');
      if (!items.length) {
        tbody.innerHTML = `<tr><td colspan="10"><div class="empty-state"><div class="es-icon">üë§</div><p>No providers</p></div></td></tr>`;
        return;
      }
      tbody.innerHTML = items.map(i => `<tr>
    <td style="font-weight:600">${esc(i.ProviderName || '‚Äî')}</td>
    <td style="font-family:monospace;font-size:12px">${esc(i.NPI || '‚Äî')}</td>
    <td>${esc(i.Specialty || '‚Äî')}</td>
    <td style="font-family:monospace;font-size:12px">${esc(i.TaxID || '‚Äî')}</td>
    <td style="font-size:12px">${esc(i.Email || '‚Äî')}</td>
    <td style="font-size:12px">${esc(i.Phone || '‚Äî')}</td>
    <td>${statusBadge(i.Status)}</td>
    <td style="font-size:12px">${i.StartDate || '‚Äî'}</td>
    <td style="font-size:12px;max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(i.Notes || '')}</td>
    <td><button class="btn btn-secondary btn-sm" onclick="editProviderItem(${i.id})">Edit</button></td>
  </tr>`).join('');
    }

    let providerItems = [];
    async function editProviderItem(id) {
      const r = await fetch('/hub/api/providers');
      const d = await r.json();
      providerItems = d.providers || d || [];
      const item = providerItems.find(x => x.id === id);
      if (item) openProviderModal(item);
    }

    function openProviderModal(item) {
      document.getElementById('providerEditId').value = item?.id || '';
      document.getElementById('providerModalTitle').textContent = item ? 'Edit Provider' : 'New Provider';
      document.getElementById('fProvName').value = item?.ProviderName || '';
      document.getElementById('fProvNPI').value = item?.NPI || '';
      document.getElementById('fProvSpecialty').value = item?.Specialty || '';
      document.getElementById('fProvTaxID').value = item?.TaxID || '';
      document.getElementById('fProvEmail').value = item?.Email || '';
      document.getElementById('fProvPhone').value = item?.Phone || '';
      document.getElementById('fProvStatus').value = item?.Status || 'Active';
      document.getElementById('fProvStart').value = item?.StartDate || '';
      document.getElementById('fProvNotes').value = item?.Notes || '';
      if (currentUser.role === 'admin') {
        document.getElementById('provClientGroup').style.display = '';
        populateClientDrop('fProvClient', item?.client_id);
      }
      document.getElementById('providerModal').classList.add('open');
    }

    async function saveProvider() {
      const editId = document.getElementById('providerEditId').value;
      const data = {
        ProviderName: document.getElementById('fProvName').value,
        NPI: document.getElementById('fProvNPI').value,
        Specialty: document.getElementById('fProvSpecialty').value,
        TaxID: document.getElementById('fProvTaxID').value,
        Email: document.getElementById('fProvEmail').value,
        Phone: document.getElementById('fProvPhone').value,
        Status: document.getElementById('fProvStatus').value,
        StartDate: document.getElementById('fProvStart').value,
        Notes: document.getElementById('fProvNotes').value,
      };
      try {
        if (editId) {
          await fetch(`/hub/api/providers/${editId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
          });
        } else {
          data.client_id = currentUser.role === 'admin'
            ? parseInt(document.getElementById('fProvClient').value) || activeClientId
            : activeClientId || currentUser.id;
          if (activeSubProfile) data.sub_profile = activeSubProfile;
          await fetch('/hub/api/providers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
          });
        }
        closeModal('providerModal'); loadProviders(); toast('Provider saved', 'success');
      } catch (e) { toast(e.message, 'error'); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CLIENTS (admin)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadClients() {
      const r = await fetch('/hub/api/clients');
      const d = await r.json();
      const items = d.clients || d || [];
      clientsList = items;
      const tbody = document.getElementById('clientTbody');
      tbody.innerHTML = items.map(c => `<tr>
    <td style="font-weight:600">${esc(c.username)}</td>
    <td>${esc(c.company)}</td>
    <td>${esc(c.contact_name || '‚Äî')}</td>
    <td style="font-size:12px">${esc(c.email || '‚Äî')}</td>
    <td style="font-size:12px">${esc(c.phone || '‚Äî')}</td>
    <td><span class="badge ${c.role === 'admin' ? 'badge-purple' : 'badge-blue'}">${c.role}</span></td>
    <td style="font-size:12px">${c.last_login || 'Never'}</td>
    <td>${c.is_active ? '‚úÖ' : '‚ùå'}</td>
  </tr>`).join('');
    }

    function openClientModal() { document.getElementById('clientModal').classList.add('open'); }

    async function saveClient() {
      const data = {
        username: document.getElementById('fCUsername').value,
        password: document.getElementById('fCPassword').value,
        company: document.getElementById('fCCompany').value,
        contact_name: document.getElementById('fCContact').value,
        email: document.getElementById('fCEmail').value,
        phone: document.getElementById('fCPhone').value,
      };
      if (!data.username || !data.password || !data.company) { toast('Username, password, and company required', 'error'); return; }
      try {
        const r = await fetch('/hub/api/clients', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
        });
        if (!r.ok) throw new Error((await r.json()).detail || 'Failed');
        closeModal('clientModal'); loadClients(); toast('Client created', 'success');
      } catch (e) { toast(e.message, 'error'); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // HELPERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function populateClientDrop(selectId, selectedId) {
      if (!clientsList.length) {
        try { const r = await fetch('/hub/api/clients'); const d = await r.json(); clientsList = d.clients || d || []; } catch (_) { }
      }
      const sel = document.getElementById(selectId);
      if (!sel) return;
      sel.innerHTML = clientsList.map(c =>
        `<option value="${c.id}" ${c.id == selectedId ? 'selected' : ''}>${esc(c.company)}</option>`
      ).join('');
    }

    function closeModal(id) { document.getElementById(id)?.classList.remove('open'); }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INTERACTIVE STATUS CHARTS (pills)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const PILL_COLORS = {
      // Claims
      'Intake': { bg: '#eef2ff', text: '#4338ca', bar: '#6366f1' },
      'Verification': { bg: '#eef2ff', text: '#4338ca', bar: '#6366f1' },
      'Coding': { bg: '#eef2ff', text: '#4338ca', bar: '#6366f1' },
      'Billed/Submitted': { bg: '#dbeafe', text: '#1e40af', bar: '#3b82f6' },
      'Rejected': { bg: '#fef2f2', text: '#991b1b', bar: '#ef4444' },
      'Denied': { bg: '#fef2f2', text: '#991b1b', bar: '#ef4444' },
      'A/R Follow-Up': { bg: '#eef2ff', text: '#4338ca', bar: '#6366f1' },
      'Appeals': { bg: '#faf5ff', text: '#7e22ce', bar: '#a855f7' },
      'Paid': { bg: '#ecfdf5', text: '#065f46', bar: '#10b981' },
      'Closed': { bg: '#f3f4f6', text: '#4b5563', bar: '#9ca3af' },
      // Credentialing / EDI shared
      'Not Started': { bg: '#fffbeb', text: '#92400e', bar: '#f59e0b' },
      'In Progress': { bg: '#fffbeb', text: '#92400e', bar: '#f59e0b' },
      'Submitted': { bg: '#dbeafe', text: '#1e40af', bar: '#3b82f6' },
      'Approved': { bg: '#ecfdf5', text: '#065f46', bar: '#10b981' },
      'Enrolled': { bg: '#ecfdf5', text: '#065f46', bar: '#10b981' },
      'Expired': { bg: '#fef2f2', text: '#991b1b', bar: '#ef4444' },
      'In Process': { bg: '#dbeafe', text: '#1e40af', bar: '#3b82f6' },
      'Live': { bg: '#ecfdf5', text: '#065f46', bar: '#10b981' },
      'Failed': { bg: '#fef2f2', text: '#991b1b', bar: '#ef4444' },
    };
    const PILL_DEFAULT = { bg: '#f3f4f6', text: '#4b5563', bar: '#9ca3af' };

    /**
     * Render interactive status pills into a container.
     * @param {string}   containerId  - DOM id of the chart strip div
     * @param {Array}    items        - all items (unfiltered)
     * @param {string}   statusField  - property name on each item (e.g. 'Status', 'ClaimStatus')
     * @param {string[]} statuses     - ordered list of status names to show
     * @param {Function} onFilter     - callback(statusName) when a pill is clicked; null=All
     */
    function renderSectionChart(containerId, items, statusField, statuses, onFilter) {
      const el = document.getElementById(containerId);
      if (!el) return;
      const total = items.length;
      // build counts
      const counts = {};
      statuses.forEach(s => { counts[s] = 0; });
      items.forEach(item => {
        const v = (item[statusField] || '').trim();
        // match case-insensitive
        const match = statuses.find(s => s.toLowerCase() === v.toLowerCase());
        if (match) counts[match]++;
        // else it falls into none of the pills ‚Äî that's ok
      });

      el.innerHTML = statuses.map(s => {
        const c = counts[s];
        const pct = total ? Math.round((c / total) * 100) : 0;
        const col = PILL_COLORS[s] || PILL_DEFAULT;
        return `
          <div class="status-pill" data-status="${esc(s)}" title="${esc(s)}: ${c}"
               style="background:${col.bg};color:${col.text}">
            <div>
              <div class="sp-count">${c}</div>
              <div class="sp-pct">${pct}%</div>
            </div>
            <div class="sp-label">${esc(s)}</div>
            <div class="sp-bar" style="width:${pct}%;background:${col.bar}"></div>
          </div>`;
      }).join('');

      // click handlers
      el.querySelectorAll('.status-pill').forEach(pill => {
        pill.addEventListener('click', () => {
          const isActive = pill.classList.contains('active-filter');
          el.querySelectorAll('.status-pill').forEach(p => p.classList.remove('active-filter'));
          if (isActive) {
            // deselect ‚Üí show all
            onFilter(null);
          } else {
            pill.classList.add('active-filter');
            onFilter(pill.dataset.status);
          }
        });
      });
    }

    /** Highlight the pill matching a status (or clear all if empty). */
    function syncPillHighlight(containerId, status) {
      const el = document.getElementById(containerId);
      if (!el) return;
      el.querySelectorAll('.status-pill').forEach(p => {
        p.classList.toggle('active-filter', !!status && p.dataset.status === status);
      });
    }

    function statusBadge(status) {
      if (!status) return '<span class="badge badge-gray">‚Äî</span>';
      const s = status.toLowerCase().replace(/[\s/]+/g, '-');
      const map = {
        'paid': 'badge-green', 'active': 'badge-green', 'approved': 'badge-green', 'completed': 'badge-green',
        'live': 'badge-green', 'enrolled': 'badge-green',
        'denied': 'badge-red', 'rejected': 'badge-red', 'overdue': 'badge-red', 'failed': 'badge-red', 'sla-breach': 'badge-red',
        'submitted': 'badge-blue', 'billed-submitted': 'badge-blue', 'billed': 'badge-blue', 'sent': 'badge-blue', 'in-process': 'badge-blue',
        'in-progress': 'badge-amber', 'pending': 'badge-amber', 'draft': 'badge-amber', 'in-review': 'badge-amber', 'not-started': 'badge-amber',
        'appeal': 'badge-purple', 'credentialing': 'badge-purple',
        'intake': 'badge-indigo', 'coding': 'badge-indigo', 'verification': 'badge-indigo', 'a-r-follow-up': 'badge-indigo', 'ar-follow-up': 'badge-indigo',
        'inactive': 'badge-gray', 'not-enrolled': 'badge-gray',
      };
      return `<span class="badge ${map[s] || 'badge-gray'}">${esc(status)}</span>`;
    }

    // ‚îÄ‚îÄ‚îÄ Delete functions ‚îÄ‚îÄ‚îÄ
    async function deleteClaimRow(id) {
      if (!confirm('Delete this claim? This cannot be undone.')) return;
      try {
        const r = await fetch(`/hub/api/claims/${id}`, { method: 'DELETE' });
        if (!r.ok) throw new Error('Delete failed');
        toast('Claim deleted', 'success'); loadClaims(); loadDashboard();
      } catch (e) { toast(e.message, 'error'); }
    }
    async function deleteCredRow(id) {
      if (!confirm('Delete this credentialing record?')) return;
      try {
        const r = await fetch(`/hub/api/credentialing/${id}`, { method: 'DELETE' });
        if (!r.ok) throw new Error('Delete failed');
        toast('Record deleted', 'success'); loadCred();
      } catch (e) { toast(e.message, 'error'); }
    }
    async function deleteEdiRow(id) {
      if (!confirm('Delete this EDI record?')) return;
      try {
        const r = await fetch(`/hub/api/edi/${id}`, { method: 'DELETE' });
        if (!r.ok) throw new Error('Delete failed');
        toast('Record deleted', 'success'); loadEdi();
      } catch (e) { toast(e.message, 'error'); }
    }

    function fmt(n) {
      return (parseFloat(n) || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function esc(str) {
      if (str === null || str === undefined) return '';
      const d = document.createElement('div');
      d.textContent = String(str);
      return d.innerHTML;
    }

    function toast(msg, type = '') {
      const t = document.createElement('div');
      t.className = `toast ${type}`; t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 3500);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SESSION CHECK HELPER ‚Äî verify auth before large operations
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function checkSession() {
      try {
        const r = await _nativeFetch('/hub/api/me', { credentials: 'same-origin' });
        if (!r.ok) { toast('Session expired ‚Äî please sign in again', 'error'); doLogout(); return false; }
        return true;
      } catch (_) { toast('Cannot reach server ‚Äî please try again', 'error'); return false; }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EXCEL IMPORT (per-section) ‚Äî imports data AND saves file as hard copy
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function importExcel(input, category) {
      if (!input.files || !input.files.length) return;
      const file = input.files[0];
      input.value = '';  // reset so same file can be re-selected
      if (!activeClientId) { toast('Select a client account first', 'error'); return; }
      // Verify session is still valid before uploading
      if (!(await checkSession())) return;
      const fd = new FormData();
      fd.append('file', file);
      fd.append('category', category);
      fd.append('description', `${category} import ‚Äî ${file.name}`);
      fd.append('client_id', activeClientId);
      toast(`Importing ${file.name} into ${category}‚Ä¶`, 'info');
      try {
        // Use /files/upload which both saves the file AND auto-imports data
        const r = await fetch('/hub/api/files/upload', { method: 'POST', body: fd });
        const d = await r.json();
        if (!r.ok) { toast(d.detail || 'Import failed', 'error'); return; }
        if (d.imported > 0) {
          toast(`‚úÖ Imported ${d.imported} rows into ${category} ‚Äî file saved as hard copy`, 'success');
        } else {
          toast(`‚ö†Ô∏è File saved but no rows imported ‚Äî check column headers`, 'warning');
        }
        if (d.import_errors && d.import_errors.length) {
          console.warn('Import errors:', d.import_errors);
          toast(`‚ö†Ô∏è ${d.import_errors.length} row(s) had errors`, 'warning');
        }
        // Refresh the active panel
        if (category === 'Claims') loadClaims();
        else if (category === 'Credentialing') loadCred();
        else if (category === 'EDI') loadEdi();
        // Also refresh dashboard summary + documents
        loadDashboard();
        loadDocuments();
      } catch (e) {
        console.error(e);
        toast('Import failed: ' + e.message, 'error');
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // REPORTING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let lastReportData = null;

    const SP_LABELS = { OMT: 'OMT (Osteopathic Manipulative Treatment)', MHP: 'MHP (Michigan Health Partners)' };
    const CHART_COLORS = ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#f97316', '#ec4899', '#14b8a6', '#64748b'];

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // REPORT TABS ‚Äî Custom tabs for Claims / Credentialing / EDI + user-defined
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const REQUIRED_REPORT_TABS = ['Claims', 'Credentialing', 'EDI', 'AR Legacy'];
    const DEFAULT_REPORT_TABS = [...REQUIRED_REPORT_TABS];
    const BUILT_IN_REPORT_TABS = ['Overview', ...REQUIRED_REPORT_TABS];
    let activeReportTab = 'Overview';
    let currentReportTabs = [...DEFAULT_REPORT_TABS];
    let reportNotesCache = {};
    let addReportTabOpen = false;
    let manageReportTabsOpen = false;

    function normalizeReportTabs(tabs) {
      const incoming = Array.isArray(tabs) ? tabs : [];
      const out = [];

      for (const t of REQUIRED_REPORT_TABS) {
        if (!out.some(x => x.toLowerCase() === t.toLowerCase())) out.push(t);
      }
      for (const t of incoming) {
        const name = (t || '').toString().trim();
        if (!name) continue;
        if (!out.some(x => x.toLowerCase() === name.toLowerCase())) out.push(name);
      }
      return out;
    }

    function renderReportTabBar() {
      const tabs = ['Overview', ...currentReportTabs];
      document.getElementById('reportTabBar').innerHTML = tabs.map(t => {
        const isActive = t === activeReportTab;
        const icon = t === 'Overview' ? 'üìã' : t === 'Claims' ? 'üí∞' : t === 'Credentialing' ? 'üìã' : t === 'EDI' ? 'üîó' : t === 'AR Legacy' ? 'üìö' : 'üìÑ';
        return `<button class="qtab ${isActive ? 'active' : ''}"
          onclick="setReportTab('${t.replace(/'/g, "\\'")}')"
          style="padding:6px 14px;font-size:12px;font-weight:600;border-radius:8px;border:1px solid ${isActive ? 'var(--info)' : 'var(--gray-200)'};background:${isActive ? 'var(--info)' : 'var(--gray-50)'};color:${isActive ? '#fff' : 'var(--gray-600)'};cursor:pointer;transition:all .2s">
          ${icon} ${esc(t)}
        </button>`;
      }).join('');
    }

    function setReportTab(tab) {
      activeReportTab = tab;
      renderReportTabBar();
      showReportTabContent(tab);
    }

    function showReportTabContent(tab) {
      // Hide all tab content
      const overview = document.getElementById('reportTabContent-overview');
      const claims = document.getElementById('reportTabContent-claims');
      const cred = document.getElementById('reportTabContent-credentialing');
      const edi = document.getElementById('reportTabContent-edi');
      const custom = document.getElementById('reportTabContent-custom');
      [overview, claims, cred, edi, custom].forEach(el => { if (el) el.style.display = 'none'; });

      const tabLower = tab.toLowerCase();
      if (tabLower === 'overview') {
        overview.style.display = '';
      } else if (tabLower === 'claims') {
        claims.style.display = '';
        renderClaimsTabContent();
      } else if (tabLower === 'credentialing') {
        cred.style.display = '';
        renderCredTabContent();
      } else if (tabLower === 'edi') {
        edi.style.display = '';
        renderEdiTabContent();
      } else {
        // Custom tab
        custom.style.display = '';
        renderCustomTabContent(tab);
      }
    }

    function renderClaimsTabContent() {
      if (!lastReportData) return;
      const cl = lastReportData.claims || {};
      const claimStatusData = (cl.by_status || []).map(s => ({ label: s.status, value: s.count }));
      renderBarChart('rptClaimsStatusChart', claimStatusData, 'value', 'label');

      const parts = [];
      if (cl.total_paid > 0) parts.push({ label: 'Paid', value: Math.round(cl.total_paid) });
      if (cl.total_balance > 0) parts.push({ label: 'Outstanding AR', value: Math.round(cl.total_balance) });
      const uncharged = (cl.total_charged || 0) - (cl.total_paid || 0) - (cl.total_balance || 0);
      if (uncharged > 0) parts.push({ label: 'Adjustments', value: Math.round(uncharged) });
      if (parts.length) renderDonutChart('rptClaimsFinChart', parts, 'value', 'label');
      else document.getElementById('rptClaimsFinChart').innerHTML = '<p style="color:var(--gray-400);font-size:12px">No data</p>';

      // Claims detail table
      const cbs = cl.by_status || [];
      document.getElementById('rptClaimsTable').innerHTML = cbs.length ? `
        <table style="width:100%;font-size:13px;border-collapse:collapse">
          <thead><tr style="background:var(--gray-50)">
            <th style="text-align:left;padding:8px 12px;font-size:11px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Status</th>
            <th style="text-align:right;padding:8px 12px;font-size:11px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Count</th>
            <th style="text-align:right;padding:8px 12px;font-size:11px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Charged</th>
            <th style="text-align:right;padding:8px 12px;font-size:11px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Paid</th>
            <th style="text-align:right;padding:8px 12px;font-size:11px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Balance</th>
          </tr></thead>
          <tbody>${cbs.map(s => `<tr>
            <td style="padding:8px 12px;border-top:1px solid var(--gray-100)">${statusBadge(s.status)}</td>
            <td style="padding:8px 12px;border-top:1px solid var(--gray-100);text-align:right;font-weight:600">${s.count}</td>
            <td style="padding:8px 12px;border-top:1px solid var(--gray-100);text-align:right">$${fmt(s.charged)}</td>
            <td style="padding:8px 12px;border-top:1px solid var(--gray-100);text-align:right;color:var(--success)">$${fmt(s.paid)}</td>
            <td style="padding:8px 12px;border-top:1px solid var(--gray-100);text-align:right;color:var(--danger)">$${fmt((s.charged || 0) - (s.paid || 0))}</td>
          </tr>`).join('')}
          <tr style="font-weight:700;background:var(--gray-50)">
            <td style="padding:8px 12px;border-top:2px solid var(--gray-300)">TOTAL</td>
            <td style="padding:8px 12px;border-top:2px solid var(--gray-300);text-align:right">${cl.total || 0}</td>
            <td style="padding:8px 12px;border-top:2px solid var(--gray-300);text-align:right">$${fmt(cl.total_charged)}</td>
            <td style="padding:8px 12px;border-top:2px solid var(--gray-300);text-align:right;color:var(--success)">$${fmt(cl.total_paid)}</td>
            <td style="padding:8px 12px;border-top:2px solid var(--gray-300);text-align:right;color:var(--danger)">$${fmt(cl.total_balance)}</td>
          </tr>
          </tbody>
        </table>` : '<p style="color:var(--gray-400);font-size:13px">No claims data</p>';

      // Load saved note
      loadReportTabNote('Claims');
    }

    function renderCredTabContent() {
      if (!lastReportData) return;
      const cred = lastReportData.credentialing || {};
      const credSummary = (cred.summary || []).map(s => ({ label: s.status, value: s.count }));
      renderDonutChart('rptCredStatusChart', credSummary, 'value', 'label');

      const credD = cred.detail || [];
      document.getElementById('rptCredTable').innerHTML = credD.length ? `
        <table style="width:100%;font-size:12px;border-collapse:collapse">
          <thead><tr style="background:var(--gray-50)">
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Provider</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Payor</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Type</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Status</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Submitted</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Approved</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Expires</th>
          </tr></thead>
          <tbody>${credD.map(r => `<tr>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100);font-weight:600">${esc(r.provider || '-')}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${esc(r.payor || '-')}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${esc(r.type || '-')}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${statusBadge(r.status)}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${r.submitted || '-'}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${r.approved || '-'}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${r.expires || '-'}</td>
          </tr>`).join('')}</tbody>
        </table>` : '<p style="color:var(--gray-400);font-size:13px">No credentialing data</p>';

      loadReportTabNote('Credentialing');
    }

    function renderEdiTabContent() {
      if (!lastReportData) return;
      const edi = lastReportData.edi || {};
      const ediSummary = (edi.summary || []).map(s => ({ label: s.status, value: s.count }));
      renderBarChart('rptEdiStatusChart', ediSummary, 'value', 'label');

      const ediD = edi.detail || [];
      document.getElementById('rptEdiTable').innerHTML = ediD.length ? `
        <table style="width:100%;font-size:12px;border-collapse:collapse">
          <thead><tr style="background:var(--gray-50)">
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Provider</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Payor</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Payer ID</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">EDI</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">ERA</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">EFT</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Go-Live</th>
          </tr></thead>
          <tbody>${ediD.map(r => `<tr>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100);font-weight:600">${esc(r.provider || '-')}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${esc(r.payor || '-')}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100);font-family:monospace">${esc(r.payer_id || '-')}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${statusBadge(r.edi)}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${statusBadge(r.era)}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${statusBadge(r.eft)}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${r.go_live || '-'}</td>
          </tr>`).join('')}</tbody>
        </table>` : '<p style="color:var(--gray-400);font-size:13px">No EDI data</p>';

      loadReportTabNote('EDI');
    }

    function renderCustomTabContent(tabName) {
      const el = document.getElementById('reportTabContent-custom');
      el.innerHTML = `
        <div class="card" style="margin-bottom:16px;border-left:4px solid #8b5cf6">
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
            <div class="card-title">üìÑ ${esc(tabName)}</div>
            <button class="btn btn-sm btn-primary" onclick="saveReportTabNote('${tabName.replace(/'/g, "\\'")}')">üíæ Save Notes</button>
          </div>
          <div style="padding:16px">
            <textarea id="reportNote-custom" class="form-control" rows="12"
              placeholder="Add notes, unique requirements, action items, or any specific details for '${esc(tabName)}'‚Ä¶"
              style="font-size:13px;line-height:1.6;resize:vertical"></textarea>
            <div id="reportNoteInfo-custom" style="font-size:11px;color:var(--gray-400);margin-top:4px"></div>
          </div>
        </div>`;
      loadReportTabNote(tabName);
    }

    // ‚îÄ‚îÄ Load / Save report tab notes ‚îÄ‚îÄ
    async function loadReportTabNote(tabName) {
      if (!activeClientId) return;
      // Check cache first
      if (reportNotesCache[tabName] !== undefined) {
        setNoteTextarea(tabName, reportNotesCache[tabName]);
        return;
      }
      try {
        const r = await fetch(`/hub/api/report-notes/${activeClientId}?tab_name=${encodeURIComponent(tabName)}`);
        const d = await r.json();
        const notes = d.notes || [];
        const note = notes.length ? notes[0] : null;
        reportNotesCache[tabName] = note ? note.content : '';
        setNoteTextarea(tabName, reportNotesCache[tabName]);
        if (note && note.updated_by) {
          setNoteInfo(tabName, `Last updated by ${note.updated_by} on ${(note.updated_at || '').slice(0, 16).replace('T', ' ')}`);
        }
      } catch (e) { console.error('Failed to load report note:', e); }
    }

    function setNoteTextarea(tabName, content) {
      const lower = tabName.toLowerCase();
      let ta;
      if (BUILT_IN_REPORT_TABS.map(t => t.toLowerCase()).includes(lower) && lower !== 'overview') {
        ta = document.getElementById('reportNote-' + tabName);
      } else {
        ta = document.getElementById('reportNote-custom');
      }
      if (ta) ta.value = content || '';
    }

    function setNoteInfo(tabName, info) {
      const lower = tabName.toLowerCase();
      let el;
      if (BUILT_IN_REPORT_TABS.map(t => t.toLowerCase()).includes(lower) && lower !== 'overview') {
        el = document.getElementById('reportNoteInfo-' + tabName);
      } else {
        el = document.getElementById('reportNoteInfo-custom');
      }
      if (el) el.textContent = info;
    }

    async function saveReportTabNote(tabName) {
      if (!activeClientId) { toast('Select a client first', 'error'); return; }
      const lower = tabName.toLowerCase();
      let ta;
      if (BUILT_IN_REPORT_TABS.map(t => t.toLowerCase()).includes(lower) && lower !== 'overview') {
        ta = document.getElementById('reportNote-' + tabName);
      } else {
        ta = document.getElementById('reportNote-custom');
      }
      if (!ta) return;
      const content = ta.value;
      try {
        const r = await fetch(`/hub/api/report-notes/${activeClientId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tab_name: tabName, content })
        });
        if (!r.ok) throw new Error('Save failed');
        reportNotesCache[tabName] = content;
        toast('Notes saved for "' + tabName + '"', 'success');
      } catch (e) { toast(e.message, 'error'); }
    }

    // ‚îÄ‚îÄ Add / Manage report tabs ‚îÄ‚îÄ
    function toggleAddReportTab() {
      addReportTabOpen = !addReportTabOpen;
      document.getElementById('addReportTabForm').style.display = addReportTabOpen ? '' : 'none';
      if (addReportTabOpen) { document.getElementById('newReportTabName').value = ''; document.getElementById('newReportTabName').focus(); }
    }

    async function addNewReportTab() {
      const name = (document.getElementById('newReportTabName').value || '').trim();
      if (!name) { toast('Enter a tab name', 'error'); return; }
      const allTabs = ['Overview', ...currentReportTabs];
      if (allTabs.some(t => t.toLowerCase() === name.toLowerCase())) { toast('Tab "' + name + '" already exists', 'error'); return; }
      currentReportTabs.push(name);
      await saveReportTabsToServer();
      toggleAddReportTab();
      renderReportTabBar();
      setReportTab(name);
      toast('Tab "' + name + '" created!', 'success');
    }

    function toggleManageReportTabs() {
      manageReportTabsOpen = !manageReportTabsOpen;
      const form = document.getElementById('manageReportTabsForm');
      form.style.display = manageReportTabsOpen ? '' : 'none';
      if (manageReportTabsOpen) buildManageReportTabsList();
    }

    function buildManageReportTabsList() {
      const container = document.getElementById('manageReportTabsList');
      container.innerHTML = currentReportTabs.map((t, i) => {
        const isBuiltin = DEFAULT_REPORT_TABS.includes(t);
        return `<div style="display:flex;gap:8px;align-items:center" data-rtab-idx="${i}">
          <input class="form-control" id="rtabRename_${i}" value="${esc(t)}" style="flex:1;max-width:280px"
            ${isBuiltin ? 'disabled title="Built-in tabs cannot be renamed"' : ''}>
          <span style="font-size:11px;color:var(--gray-400);min-width:80px">${isBuiltin ? 'üîí Built-in' : '‚úèÔ∏è Custom'}</span>
          ${isBuiltin ? '' : `<button class="btn btn-sm" style="color:var(--danger);background:var(--danger-light);border:none;font-size:12px" onclick="removeReportTabAt(${i})" title="Remove tab">‚úï Remove</button>`}
        </div>`;
      }).join('');
    }

    function removeReportTabAt(idx) {
      const tabName = currentReportTabs[idx];
      if (!confirm('Remove report tab "' + tabName + '"? Any saved notes for this tab will be deleted.')) return;
      currentReportTabs.splice(idx, 1);
      // Also delete notes on server
      if (activeClientId) {
        fetch(`/hub/api/report-notes/${activeClientId}/${encodeURIComponent(tabName)}`, { method: 'DELETE' }).catch(() => { });
      }
      delete reportNotesCache[tabName];
      buildManageReportTabsList();
    }

    async function saveReportTabNames() {
      const newTabs = [];
      for (let i = 0; ; i++) {
        const el = document.getElementById('rtabRename_' + i);
        if (!el) break;
        const val = el.value.trim();
        if (val) {
          // If renamed, also rename notes
          const oldName = currentReportTabs[i];
          if (oldName && val !== oldName && activeClientId) {
            await fetch(`/hub/api/report-notes/${activeClientId}/rename`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ old_name: oldName, new_name: val })
            }).catch(() => { });
            if (reportNotesCache[oldName] !== undefined) {
              reportNotesCache[val] = reportNotesCache[oldName];
              delete reportNotesCache[oldName];
            }
          }
          newTabs.push(val);
        }
      }
      if (newTabs.length === 0) { toast('You must have at least one tab', 'error'); return; }
      currentReportTabs = normalizeReportTabs(newTabs);
      await saveReportTabsToServer();
      manageReportTabsOpen = false;
      document.getElementById('manageReportTabsForm').style.display = 'none';
      if (activeReportTab !== 'Overview' && !currentReportTabs.includes(activeReportTab)) activeReportTab = 'Overview';
      renderReportTabBar();
      showReportTabContent(activeReportTab);
      toast('Report tabs updated!', 'success');
    }

    async function saveReportTabsToServer() {
      try {
        const url = activeClientId ? `/hub/api/profile/${activeClientId}` : '/hub/api/profile';
        currentReportTabs = normalizeReportTabs(currentReportTabs);
        const r = await fetch(url, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ report_tabs: currentReportTabs }) });
        if (!r.ok) throw new Error('Failed to save report tabs');
      } catch (e) { toast(e.message, 'error'); }
    }

    async function loadReport() {
      if (!activeClientId) {
        document.getElementById('reportAINarrative').innerHTML = '<p style="color:var(--gray-400);font-size:13px">Select a client account first.</p>';
        return;
      }
      // Load report tabs from profile
      try {
        const profUrl = `/hub/api/profile/${activeClientId}`;
        const pr = await fetch(profUrl).catch(() => null);
        if (pr && pr.ok) {
          const pd = await pr.json();
          if (pd.report_tabs && pd.report_tabs.length > 0) currentReportTabs = normalizeReportTabs(pd.report_tabs);
          else currentReportTabs = [...DEFAULT_REPORT_TABS];
        }
      } catch (_) { }
      reportNotesCache = {};
      renderReportTabBar();

      const period = document.getElementById('reportPeriod')?.value || 'all';
      const sp = activeSubProfile ? `&sub_profile=${encodeURIComponent(activeSubProfile)}` : '';
      try {
        const r = await fetch(`/hub/api/report/${activeClientId}?period=${period}${sp}`);
        const d = await r.json();
        lastReportData = d;
        renderReport(d);
        // If on a non-overview tab, re-render that tab's content with fresh data
        if (activeReportTab !== 'Overview') showReportTabContent(activeReportTab);
      } catch (e) { console.error(e); }
    }

    /* ‚îÄ‚îÄ CSS bar chart builder ‚îÄ‚îÄ */
    function renderBarChart(containerId, items, valueKey, labelKey, colorArr) {
      const el = document.getElementById(containerId);
      if (!items || !items.length) { el.innerHTML = '<p style="color:var(--gray-400);font-size:12px;text-align:center">No data available</p>'; return; }
      const maxVal = Math.max(...items.map(i => i[valueKey] || 0), 1);
      el.innerHTML = items.map((item, idx) => {
        const pct = Math.round(((item[valueKey] || 0) / maxVal) * 100);
        const color = (colorArr || CHART_COLORS)[idx % (colorArr || CHART_COLORS).length];
        return `<div style="margin-bottom:10px">
          <div style="display:flex;justify-content:space-between;font-size:12px;font-weight:600;margin-bottom:3px;color:var(--gray-700)">
            <span>${esc(item[labelKey] || 'Unknown')}</span>
            <span>${typeof item[valueKey] === 'number' && valueKey.toLowerCase().includes('amount') ? '$' + fmt(item[valueKey]) : item[valueKey]}</span>
          </div>
          <div style="background:var(--gray-100);border-radius:6px;height:22px;overflow:hidden">
            <div style="width:${pct}%;height:100%;background:${color};border-radius:6px;transition:width .5s ease"></div>
          </div>
        </div>`;
      }).join('');
    }

    /* ‚îÄ‚îÄ Donut / ring chart with SVG ‚îÄ‚îÄ */
    function renderDonutChart(containerId, items, valueKey, labelKey) {
      const el = document.getElementById(containerId);
      if (!items || !items.length) { el.innerHTML = '<p style="color:var(--gray-400);font-size:12px;text-align:center">No data available</p>'; return; }
      const total = items.reduce((s, i) => s + (i[valueKey] || 0), 0);
      if (!total) { el.innerHTML = '<p style="color:var(--gray-400);font-size:12px;text-align:center">No data</p>'; return; }
      const R = 60, cx = 80, cy = 80, sw = 18;
      let acc = 0;
      const paths = items.map((item, idx) => {
        const val = item[valueKey] || 0;
        const frac = val / total;
        const startAngle = acc * 2 * Math.PI - Math.PI / 2;
        acc += frac;
        const endAngle = acc * 2 * Math.PI - Math.PI / 2;
        const large = frac > 0.5 ? 1 : 0;
        const x1 = cx + R * Math.cos(startAngle), y1 = cy + R * Math.sin(startAngle);
        const x2 = cx + R * Math.cos(endAngle), y2 = cy + R * Math.sin(endAngle);
        const color = CHART_COLORS[idx % CHART_COLORS.length];
        if (frac >= 0.999) return `<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="${color}" stroke-width="${sw}"/>`;
        return `<path d="M${x1},${y1} A${R},${R} 0 ${large} 1 ${x2},${y2}" fill="none" stroke="${color}" stroke-width="${sw}"/>`;
      });
      const legend = items.map((item, idx) => {
        const pct = Math.round(((item[valueKey] || 0) / total) * 100);
        return `<div style="display:flex;align-items:center;gap:6px;font-size:11px;margin-bottom:4px">
          <div style="width:10px;height:10px;border-radius:50%;background:${CHART_COLORS[idx % CHART_COLORS.length]};flex-shrink:0"></div>
          <span style="color:var(--gray-700)">${esc(item[labelKey] || 'Unknown')} ‚Äî ${item[valueKey]} (${pct}%)</span>
        </div>`;
      }).join('');
      el.innerHTML = `<div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap">
        <svg width="160" height="160" viewBox="0 0 160 160">
          ${paths.join('')}
          <text x="${cx}" y="${cy}" text-anchor="middle" dominant-baseline="central" style="font-size:18px;font-weight:700;fill:var(--gray-700)">${total}</text>
        </svg>
        <div>${legend}</div>
      </div>`;
    }

    /* ‚îÄ‚îÄ AI Narrative Summary Generator ‚îÄ‚îÄ */
    function generateAINarrative(d) {
      const company = d.client?.company || 'Client';
      const period = { all: 'All Time', mtd: 'Month to Date', ytd: 'Year to Date' }[d.period] || d.period;
      const cl = d.claims || {};
      const pay = d.payments || {};
      const cred = d.credentialing || {};
      const edi = d.edi || {};
      const subs = d.sub_profiles || {};

      let narrative = [];

      // Header
      narrative.push(`<strong style="font-size:15px;color:var(--gray-800)">üìã Account Intelligence Report ‚Äî ${esc(company)}</strong>`);
      narrative.push(`<span style="font-size:12px;color:var(--gray-400)">Period: ${period} | Generated: ${d.generated_at}</span>`);
      narrative.push('');

      // Overall Summary
      narrative.push(`<strong>Overall Account Summary:</strong>`);
      if (cl.total) {
        const collectionRate = cl.total_charged > 0 ? Math.round((cl.total_paid / cl.total_charged) * 100) : 0;
        narrative.push(`The account currently has <strong>${cl.total} claims</strong> with <strong>$${fmt(cl.total_charged)}</strong> in total charges. Collections of <strong>$${fmt(cl.total_paid)}</strong> represent a <strong>${collectionRate}% collection rate</strong>. Outstanding accounts receivable sits at <strong>$${fmt(cl.total_balance)}</strong>.`);

        // Status breakdown insights
        const byStatus = cl.by_status || [];
        const denied = byStatus.find(s => (s.status || '').toLowerCase().includes('denied') || (s.status || '').toLowerCase().includes('denial'));
        const pending = byStatus.find(s => (s.status || '').toLowerCase().includes('pending') || (s.status || '').toLowerCase().includes('submitted'));
        const paid = byStatus.find(s => (s.status || '').toLowerCase().includes('paid') || (s.status || '').toLowerCase().includes('approved'));
        if (denied && denied.count > 0) {
          const denialRate = Math.round((denied.count / cl.total) * 100);
          narrative.push(`‚ö†Ô∏è <strong>${denied.count} claims (${denialRate}%)</strong> are in denial status totaling <strong>$${fmt(denied.charged)}</strong> in charges ‚Äî this requires attention for appeals and follow-up.`);
        }
        if (pending && pending.count > 0) {
          narrative.push(`üîÑ <strong>${pending.count} claims</strong> are currently pending/submitted, representing <strong>$${fmt(pending.charged)}</strong> in outstanding charges.`);
        }
        // Top denials
        if (cl.top_denials && cl.top_denials.length > 0) {
          const topDen = cl.top_denials[0];
          narrative.push(`üìå Top denial category: <strong>${esc(topDen.category)}</strong> with ${topDen.count} occurrence(s).`);
        }
      } else {
        narrative.push('No claims data is currently on file for this account.');
      }
      narrative.push('');

      // Credentialing
      const credTotal = (cred.detail || []).length;
      if (credTotal) {
        const credApproved = (cred.summary || []).filter(s => (s.status || '').toLowerCase().includes('approved') || (s.status || '').toLowerCase().includes('active'));
        const credPending = (cred.summary || []).filter(s => (s.status || '').toLowerCase().includes('pending') || (s.status || '').toLowerCase().includes('in progress'));
        const approvedCount = credApproved.reduce((s, i) => s + i.count, 0);
        const pendingCount = credPending.reduce((s, i) => s + i.count, 0);
        narrative.push(`<strong>Credentialing:</strong> ${credTotal} total credentialing records tracked. <strong>${approvedCount}</strong> approved/active, <strong>${pendingCount}</strong> pending.${pendingCount > 0 ? ' Follow-up recommended on pending applications.' : ''}`);
      }

      // EDI
      const ediTotal = (edi.detail || []).length;
      if (ediTotal) {
        const ediActive = (edi.summary || []).filter(s => (s.status || '').toLowerCase().includes('active') || (s.status || '').toLowerCase().includes('live'));
        const activeEdi = ediActive.reduce((s, i) => s + i.count, 0);
        narrative.push(`<strong>EDI Setup:</strong> ${ediTotal} EDI connections configured. <strong>${activeEdi}</strong> live/active.`);
      }

      // Payments
      if (pay.count > 0) {
        narrative.push(`<strong>Payments:</strong> ${pay.count} payment(s) received totaling <strong>$${fmt(pay.total)}</strong>.`);
      }
      narrative.push('');

      // Sub-profile breakdowns
      if (Object.keys(subs).length > 0) {
        narrative.push(`<strong style="font-size:14px">Sub-Profile Breakdown:</strong>`);
        for (const [spName, spData] of Object.entries(subs)) {
          const label = SP_LABELS[spName] || spName;
          const sc = spData.claims || {};
          const scRate = sc.total_charged > 0 ? Math.round((sc.total_paid / sc.total_charged) * 100) : 0;
          narrative.push('');
          narrative.push(`<strong style="color:${spName === 'OMT' ? '#6366f1' : '#0ea5e9'}">${label}:</strong>`);
          if (sc.total) {
            narrative.push(`‚Ä¢ <strong>${sc.total} claims</strong> ‚Äî Charged: <strong>$${fmt(sc.total_charged)}</strong>, Paid: <strong>$${fmt(sc.total_paid)}</strong> (${scRate}% collection rate), AR: <strong>$${fmt(sc.total_balance)}</strong>`);
          } else {
            narrative.push(`‚Ä¢ No claims data recorded.`);
          }
          const spCredTotal = (spData.credentialing?.detail || []).length;
          const spEdiTotal = (spData.edi?.detail || []).length;
          if (spCredTotal) narrative.push(`‚Ä¢ ${spCredTotal} credentialing record(s)`);
          if (spEdiTotal) narrative.push(`‚Ä¢ ${spEdiTotal} EDI setup record(s)`);
        }
        narrative.push('');

        // Comparison insight
        const omtCl = subs.OMT?.claims || {};
        const mhpCl = subs.MHP?.claims || {};
        if (omtCl.total && mhpCl.total) {
          const biggerLabel = omtCl.total >= mhpCl.total ? 'OMT' : 'MHP (Michigan Health Partners)';
          const biggerCount = Math.max(omtCl.total, mhpCl.total);
          const smallerCount = Math.min(omtCl.total, mhpCl.total);
          narrative.push(`üí° <strong>Insight:</strong> ${biggerLabel} represents the larger volume with ${biggerCount} claims vs ${smallerCount}. `);
          const omtRate = omtCl.total_charged > 0 ? Math.round((omtCl.total_paid / omtCl.total_charged) * 100) : 0;
          const mhpRate = mhpCl.total_charged > 0 ? Math.round((mhpCl.total_paid / mhpCl.total_charged) * 100) : 0;
          if (omtRate !== mhpRate) {
            const betterLabel = omtRate >= mhpRate ? 'OMT' : 'MHP';
            narrative.push(`Collection rate comparison: OMT ${omtRate}% vs MHP ${mhpRate}% ‚Äî ${betterLabel} is performing better on collections.`);
          }
        }
      }

      // Action items
      narrative.push('');
      narrative.push(`<strong>üéØ Recommended Actions:</strong>`);
      const actions = [];
      const byStatus = cl.by_status || [];
      const deniedItems = byStatus.filter(s => (s.status || '').toLowerCase().includes('denied') || (s.status || '').toLowerCase().includes('denial'));
      if (deniedItems.length) actions.push('Review and appeal denied claims to recover outstanding revenue.');
      const credPendingCount = (cred.summary || []).filter(s => (s.status || '').toLowerCase().includes('pending')).reduce((s, i) => s + i.count, 0);
      if (credPendingCount) actions.push(`Follow up on ${credPendingCount} pending credentialing application(s).`);
      if (cl.total_balance > 0) actions.push(`Work outstanding AR of $${fmt(cl.total_balance)} through systematic follow-up.`);
      if (!actions.length) actions.push('Account is in good standing. Continue monitoring KPIs.');
      actions.forEach(a => narrative.push(`‚Ä¢ ${a}`));

      return narrative.join('<br>');
    }

    /* ‚îÄ‚îÄ Sub-profile card renderer ‚îÄ‚îÄ */
    function renderSubProfileCard(containerId, spData, spName) {
      const el = document.getElementById(containerId);
      const cl = spData.claims || {};
      const cred = spData.credentialing || {};
      const edi = spData.edi || {};
      const collRate = cl.total_charged > 0 ? Math.round((cl.total_paid / cl.total_charged) * 100) : 0;
      const color = spName === 'OMT' ? '#6366f1' : '#0ea5e9';

      let html = `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px">
        <div style="background:${color}10;border-radius:8px;padding:10px;text-align:center">
          <div style="font-size:20px;font-weight:700;color:${color}">${cl.total || 0}</div>
          <div style="font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Claims</div>
        </div>
        <div style="background:${color}10;border-radius:8px;padding:10px;text-align:center">
          <div style="font-size:20px;font-weight:700;color:${color}">$${fmt(cl.total_charged)}</div>
          <div style="font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Charged</div>
        </div>
        <div style="background:${color}10;border-radius:8px;padding:10px;text-align:center">
          <div style="font-size:20px;font-weight:700;color:${color}">${collRate}%</div>
          <div style="font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Collection Rate</div>
        </div>
      </div>`;

      // Mini bar chart for claims by status
      const byStatus = cl.by_status || [];
      if (byStatus.length) {
        const maxV = Math.max(...byStatus.map(s => s.count), 1);
        html += `<div style="font-size:11px;font-weight:600;color:var(--gray-500);text-transform:uppercase;margin-bottom:6px">Claims by Status</div>`;
        byStatus.forEach((s, i) => {
          const pct = Math.round((s.count / maxV) * 100);
          html += `<div style="margin-bottom:6px">
            <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--gray-600);margin-bottom:2px">
              <span>${esc(s.status)}</span><span style="font-weight:600">${s.count}</span>
            </div>
            <div style="background:var(--gray-100);border-radius:4px;height:14px;overflow:hidden">
              <div style="width:${pct}%;height:100%;background:${color};border-radius:4px;opacity:${0.5 + (i * 0.15)}"></div>
            </div>
          </div>`;
        });
      }

      // Summary counts
      html += `<div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">`;
      html += `<span style="font-size:11px;background:var(--gray-50);border:1px solid var(--gray-200);border-radius:20px;padding:3px 10px">üìã ${(cred.detail || []).length} Cred</span>`;
      html += `<span style="font-size:11px;background:var(--gray-50);border:1px solid var(--gray-200);border-radius:20px;padding:3px 10px"> ${(edi.detail || []).length} EDI</span>`;
      html += `</div>`;

      el.innerHTML = html;
    }

    function renderReport(d) {
      const periodLabel = { all: 'All Time', mtd: 'Month to Date', ytd: 'Year to Date' }[d.period] || d.period;
      const company = d.client?.company || 'Client';
      const genDate = d.generated_at || new Date().toISOString().slice(0, 10);

      // AI Narrative
      document.getElementById('reportAINarrative').innerHTML = generateAINarrative(d);
      document.getElementById('aiNarrativeSource').textContent = 'Template-based ‚Äî Click "Generate AI Report" for GPT analysis';

      // Summary KPIs
      const cl = d.claims || {};
      const collRate = cl.total_charged > 0 ? Math.round((cl.total_paid / cl.total_charged) * 100) : 0;
      document.getElementById('reportSummary').innerHTML = `
        <div style="margin-bottom:14px;padding:12px 16px;background:var(--gray-50);border-radius:10px;border:1px solid var(--gray-200)">
          <div style="font-size:16px;font-weight:700;color:var(--gray-800);margin-bottom:4px">${esc(company)} ‚Äî ${periodLabel} Report</div>
          <div style="font-size:12px;color:var(--gray-400)">Generated: ${genDate}${activeSubProfile ? ' | Sub-Profile: ' + activeSubProfile : ''}${d.practice_type ? ' | Practice: ' + d.practice_type : ''}</div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(135px,1fr));gap:12px">
          <div style="background:var(--info-light);border-radius:10px;padding:14px;text-align:center">
            <div style="font-size:24px;font-weight:700;color:var(--info)">${cl.total || 0}</div>
            <div style="font-size:11px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Total Claims</div>
          </div>
          <div style="background:var(--purple-light);border-radius:10px;padding:14px;text-align:center">
            <div style="font-size:24px;font-weight:700;color:var(--purple)">$${fmt(cl.total_charged)}</div>
            <div style="font-size:11px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Total Charged</div>
          </div>
          <div style="background:var(--success-light);border-radius:10px;padding:14px;text-align:center">
            <div style="font-size:24px;font-weight:700;color:var(--success)">$${fmt(cl.total_paid)}</div>
            <div style="font-size:11px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Total Paid</div>
          </div>
          <div style="background:var(--danger-light);border-radius:10px;padding:14px;text-align:center">
            <div style="font-size:24px;font-weight:700;color:var(--danger)">$${fmt(cl.total_balance)}</div>
            <div style="font-size:11px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Outstanding AR</div>
          </div>
          <div style="background:var(--warning-light);border-radius:10px;padding:14px;text-align:center">
            <div style="font-size:24px;font-weight:700;color:var(--warning)">${collRate}%</div>
            <div style="font-size:11px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Collection Rate</div>
          </div>
          <div style="background:var(--warning-light);border-radius:10px;padding:14px;text-align:center">
            <div style="font-size:24px;font-weight:700;color:var(--warning)">${d.payments?.count || 0}</div>
            <div style="font-size:11px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Payments</div>
          </div>
          <div style="background:var(--success-light);border-radius:10px;padding:14px;text-align:center">
            <div style="font-size:24px;font-weight:700;color:var(--success)">$${fmt(d.payments?.total)}</div>
            <div style="font-size:11px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Payments Total</div>
          </div>
        </div>`;

      // Charts
      // Claims status bar chart
      const claimStatusData = (cl.by_status || []).map(s => ({ label: s.status, value: s.count }));
      renderBarChart('chartClaimsStatus', claimStatusData, 'value', 'label');

      // Financials donut
      const parts = [];
      if (cl.total_paid > 0) parts.push({ label: 'Paid', value: Math.round(cl.total_paid) });
      if (cl.total_balance > 0) parts.push({ label: 'Outstanding AR', value: Math.round(cl.total_balance) });
      const uncharged = (cl.total_charged || 0) - (cl.total_paid || 0) - (cl.total_balance || 0);
      if (uncharged > 0) parts.push({ label: 'Adjustments', value: Math.round(uncharged) });
      if (parts.length) {
        renderDonutChart('chartFinancials', parts, 'value', 'label');
      } else {
        document.getElementById('chartFinancials').innerHTML = '<p style="color:var(--gray-400);font-size:12px;text-align:center">No financial data</p>';
      }

      // Credentialing status donut
      const credSummary = (d.credentialing?.summary || []).map(s => ({ label: s.status, value: s.count }));
      renderDonutChart('chartCredStatus', credSummary, 'value', 'label');

      // Sub-profile breakdowns
      const spSection = document.getElementById('reportSubProfiles');
      if (d.sub_profiles && Object.keys(d.sub_profiles).length > 0) {
        spSection.style.display = '';
        if (d.sub_profiles.OMT) renderSubProfileCard('reportOMT', d.sub_profiles.OMT, 'OMT');
        if (d.sub_profiles.MHP) renderSubProfileCard('reportMHP', d.sub_profiles.MHP, 'MHP');
      } else {
        spSection.style.display = 'none';
      }

      // Claims by status table
      const cbs = cl.by_status || [];
      document.getElementById('reportClaims').innerHTML = cbs.length ? `
        <table style="width:100%;font-size:13px;border-collapse:collapse">
          <thead><tr style="background:var(--gray-50)">
            <th style="text-align:left;padding:8px 12px;font-size:11px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Status</th>
            <th style="text-align:right;padding:8px 12px;font-size:11px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Count</th>
            <th style="text-align:right;padding:8px 12px;font-size:11px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Charged</th>
            <th style="text-align:right;padding:8px 12px;font-size:11px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Paid</th>
          </tr></thead>
          <tbody>${cbs.map(s => `<tr>
            <td style="padding:8px 12px;border-top:1px solid var(--gray-100)">${statusBadge(s.status)}</td>
            <td style="padding:8px 12px;border-top:1px solid var(--gray-100);text-align:right;font-weight:600">${s.count}</td>
            <td style="padding:8px 12px;border-top:1px solid var(--gray-100);text-align:right">$${fmt(s.charged)}</td>
            <td style="padding:8px 12px;border-top:1px solid var(--gray-100);text-align:right;color:var(--success)">$${fmt(s.paid)}</td>
          </tr>`).join('')}</tbody>
        </table>` : '<p style="color:var(--gray-400);font-size:13px">No claims data</p>';

      // Credentialing
      const credD = d.credentialing?.detail || [];
      document.getElementById('reportCred').innerHTML = credD.length ? `
        <table style="width:100%;font-size:12px;border-collapse:collapse">
          <thead><tr style="background:var(--gray-50)">
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Provider</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Payor</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Type</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Status</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Submitted</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Approved</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Expires</th>
          </tr></thead>
          <tbody>${credD.map(r => `<tr>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100);font-weight:600">${esc(r.provider || '-')}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${esc(r.payor || '-')}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${esc(r.type || '-')}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${statusBadge(r.status)}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${r.submitted || '-'}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${r.approved || '-'}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${r.expires || '-'}</td>
          </tr>`).join('')}</tbody>
        </table>` : '<p style="color:var(--gray-400);font-size:13px">No credentialing data</p>';

      // EDI
      const ediD = d.edi?.detail || [];
      document.getElementById('reportEdi').innerHTML = ediD.length ? `
        <table style="width:100%;font-size:12px;border-collapse:collapse">
          <thead><tr style="background:var(--gray-50)">
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Provider</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Payor</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Payer ID</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">EDI</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">ERA</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">EFT</th>
            <th style="text-align:left;padding:6px 10px;font-size:10px;font-weight:600;color:var(--gray-500);text-transform:uppercase">Go-Live</th>
          </tr></thead>
          <tbody>${ediD.map(r => `<tr>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100);font-weight:600">${esc(r.provider || '-')}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${esc(r.payor || '-')}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100);font-family:monospace">${esc(r.payer_id || '-')}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${statusBadge(r.edi)}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${statusBadge(r.era)}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${statusBadge(r.eft)}</td>
            <td style="padding:6px 10px;border-top:1px solid var(--gray-100)">${r.go_live || '-'}</td>
          </tr>`).join('')}</tbody>
        </table>` : '<p style="color:var(--gray-400);font-size:13px">No EDI data</p>';

      // Payments
      document.getElementById('reportPayments').innerHTML = `
        <div style="display:flex;gap:24px;align-items:center;padding:8px 0">
          <div><span style="font-size:13px;color:var(--gray-500)">Total Payments:</span>
            <span style="font-size:18px;font-weight:700;color:var(--success);margin-left:8px">$${fmt(d.payments?.total)}</span></div>
          <div><span style="font-size:13px;color:var(--gray-500)">Payment Count:</span>
            <span style="font-size:18px;font-weight:700;color:var(--gray-800);margin-left:8px">${d.payments?.count || 0}</span></div>
        </div>`;
    }

    function downloadReportCSV() {
      if (!lastReportData) { toast('No report data. Load a report first.', 'error'); return; }
      const d = lastReportData;
      const company = d.client?.company || 'Client';
      const lines = [];
      lines.push(`${company} Report - Generated ${d.generated_at}`);
      lines.push('');

      // AI Narrative (plain text version)
      lines.push('OVERALL ACCOUNT SUMMARY');
      const cl = d.claims || {};
      const collRate = cl.total_charged > 0 ? Math.round((cl.total_paid / cl.total_charged) * 100) : 0;
      lines.push(`Total Claims: ${cl.total || 0} | Charged: $${cl.total_charged || 0} | Paid: $${cl.total_paid || 0} | Collection Rate: ${collRate}% | AR: $${cl.total_balance || 0}`);
      lines.push('');

      // Sub-profile summary
      if (d.sub_profiles) {
        for (const [spName, spData] of Object.entries(d.sub_profiles)) {
          const label = SP_LABELS[spName] || spName;
          const sc = spData.claims || {};
          const sr = sc.total_charged > 0 ? Math.round((sc.total_paid / sc.total_charged) * 100) : 0;
          lines.push(`${label}`);
          lines.push(`Claims: ${sc.total || 0} | Charged: $${sc.total_charged || 0} | Paid: $${sc.total_paid || 0} | Collection Rate: ${sr}% | AR: $${sc.total_balance || 0}`);
          lines.push(`Credentialing: ${(spData.credentialing?.detail || []).length} | EDI: ${(spData.edi?.detail || []).length}`);
          lines.push('');
        }
      }

      lines.push('CLAIMS SUMMARY');
      lines.push('Status,Count,Charged,Paid');
      (d.claims?.by_status || []).forEach(s => {
        lines.push(`${s.status},${s.count},${s.charged},${s.paid}`);
      });
      lines.push(`TOTAL,${d.claims?.total || 0},${d.claims?.total_charged || 0},${d.claims?.total_paid || 0}`);
      lines.push('');
      lines.push('CREDENTIALING');
      lines.push('Provider,Payor,Type,Status,Submitted,Approved,Expires');
      (d.credentialing?.detail || []).forEach(r => {
        lines.push([r.provider, r.payor, r.type, r.status, r.submitted, r.approved, r.expires].map(v => `"${(v || '').replace(/"/g, '""')}"`).join(','));
      });
      lines.push('');
      lines.push('EDI SETUP');
      lines.push('Provider,Payor,Payer ID,EDI,ERA,EFT,Go-Live');
      (d.edi?.detail || []).forEach(r => {
        lines.push([r.provider, r.payor, r.payer_id, r.edi, r.era, r.eft, r.go_live].map(v => `"${(v || '').replace(/"/g, '""')}"`).join(','));
      });
      lines.push('');
      lines.push('PAYMENTS');
      lines.push(`Total,$${d.payments?.total || 0}`);
      lines.push(`Count,${d.payments?.count || 0}`);
      const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url;
      a.download = `${company.replace(/[^a-zA-Z0-9]/g, '_')}_Report_${d.generated_at}.csv`;
      a.click(); URL.revokeObjectURL(url);
      toast('Report downloaded!', 'success');
    }

    function printReport() {
      if (!lastReportData) { toast('No report data. Load a report first.', 'error'); return; }
      const d = lastReportData;
      const company = d.client?.company || 'Client';
      const periodLabel = { all: 'All Time', mtd: 'Month to Date', ytd: 'Year to Date' }[d.period] || d.period;
      const cl = d.claims || {};
      const collRate = cl.total_charged > 0 ? Math.round((cl.total_paid / cl.total_charged) * 100) : 0;

      let html = `<html><head><title>${company} Report</title><style>
        body{font-family:'Segoe UI',Arial,sans-serif;font-size:12px;color:#333;padding:24px;max-width:1000px;margin:0 auto}
        h1{font-size:20px;font-weight:700;margin-bottom:4px;color:#1e40af} h2{font-size:14px;font-weight:700;margin:24px 0 10px;padding-bottom:4px;border-bottom:2px solid #3b82f6;text-transform:uppercase;letter-spacing:.5px;color:#1e40af}
        .meta{font-size:11px;color:#888;margin-bottom:16px}
        table{width:100%;border-collapse:collapse;margin-bottom:12px;font-size:11px}
        th{background:#eff6ff;padding:6px 8px;text-align:left;font-size:10px;text-transform:uppercase;font-weight:600;color:#3b82f6;border-bottom:2px solid #bfdbfe}
        td{padding:6px 8px;border-bottom:1px solid #f0f0f0}
        .sg{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
        .sb{background:#f0f9ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px;text-align:center}
        .sb .v{font-size:20px;font-weight:700;color:#1e40af} .sb .l{font-size:9px;text-transform:uppercase;color:#6b7280;margin-top:2px}
        .narrative{background:#f0f9ff;border:1px solid #bfdbfe;border-left:4px solid #3b82f6;border-radius:8px;padding:16px;margin-bottom:20px;line-height:1.7;font-size:12px}
        .sp-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
        .sp-card{border:1px solid #e5e7eb;border-radius:8px;padding:14px;border-top:4px solid}
        .sp-card h3{font-size:13px;font-weight:700;margin:0 0 10px}
        .sp-kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px}
        .sp-kpi div{text-align:center;background:#f9fafb;border-radius:6px;padding:8px}
        .sp-kpi .kv{font-size:16px;font-weight:700} .sp-kpi .kl{font-size:9px;color:#888;text-transform:uppercase}
        .bar-row{margin-bottom:6px} .bar-label{display:flex;justify-content:space-between;font-size:10px;margin-bottom:2px}
        .bar-bg{background:#e5e7eb;border-radius:4px;height:12px;overflow:hidden} .bar-fill{height:100%;border-radius:4px}
        @media print{body{padding:0}@page{margin:14mm}}
      </style></head><body>`;

      html += `<h1>${esc(company)} ‚Äî ${periodLabel} Report</h1>`;
      html += `<div class="meta">Report Date: ${d.generated_at}${d.practice_type ? ' | Practice Type: ' + d.practice_type : ''}</div>`;

      // AI Narrative section
      html += `<div class="narrative"><strong>üìã Overall Account Summary</strong><br><br>`;
      html += generateAINarrative(d).replace(/<strong[^>]*>/g, '<b>').replace(/<\/strong>/g, '</b>');
      html += `</div>`;

      // KPIs
      html += `<div class="sg">
        <div class="sb"><div class="v">${cl.total || 0}</div><div class="l">Total Claims</div></div>
        <div class="sb"><div class="v">$${fmt(cl.total_charged)}</div><div class="l">Total Charged</div></div>
        <div class="sb"><div class="v">$${fmt(cl.total_paid)}</div><div class="l">Total Paid</div></div>
        <div class="sb"><div class="v">$${fmt(cl.total_balance)}</div><div class="l">Outstanding AR</div></div>
      </div>`;
      html += `<div class="sg">
        <div class="sb"><div class="v">${collRate}%</div><div class="l">Collection Rate</div></div>
        <div class="sb"><div class="v">${d.payments?.count || 0}</div><div class="l">Payments</div></div>
        <div class="sb"><div class="v">$${fmt(d.payments?.total)}</div><div class="l">Payment Total</div></div>
        <div class="sb"><div class="v">${(d.credentialing?.detail || []).length}</div><div class="l">Cred Records</div></div>
      </div>`;

      // Sub-profile section
      if (d.sub_profiles && Object.keys(d.sub_profiles).length > 0) {
        html += `<h2>Sub-Profile Breakdown</h2><div class="sp-grid">`;
        for (const [spName, spData] of Object.entries(d.sub_profiles)) {
          const label = SP_LABELS[spName] || spName;
          const sc = spData.claims || {};
          const sr = sc.total_charged > 0 ? Math.round((sc.total_paid / sc.total_charged) * 100) : 0;
          const bdrColor = spName === 'OMT' ? '#6366f1' : '#0ea5e9';
          html += `<div class="sp-card" style="border-top-color:${bdrColor}"><h3 style="color:${bdrColor}">${label}</h3>`;
          html += `<div class="sp-kpi">
            <div><div class="kv">${sc.total || 0}</div><div class="kl">Claims</div></div>
            <div><div class="kv">$${fmt(sc.total_charged)}</div><div class="kl">Charged</div></div>
            <div><div class="kv">${sr}%</div><div class="kl">Coll. Rate</div></div>
          </div>`;
          // Mini bars for status
          const bySt = sc.by_status || [];
          if (bySt.length) {
            const mx = Math.max(...bySt.map(s => s.count), 1);
            bySt.forEach(s => {
              const pct = Math.round((s.count / mx) * 100);
              html += `<div class="bar-row"><div class="bar-label"><span>${s.status}</span><span>${s.count}</span></div><div class="bar-bg"><div class="bar-fill" style="width:${pct}%;background:${bdrColor}"></div></div></div>`;
            });
          }
          html += `<div style="font-size:10px;color:#888;margin-top:8px">Cred: ${(spData.credentialing?.detail || []).length} | EDI: ${(spData.edi?.detail || []).length}</div>`;
          html += `</div>`;
        }
        html += `</div>`;
      }

      // Detail tables
      html += `<h2>Claims by Status</h2><table><tr><th>Status</th><th>Count</th><th>Charged</th><th>Paid</th></tr>`;
      (cl.by_status || []).forEach(s => { html += `<tr><td>${s.status}</td><td>${s.count}</td><td>$${fmt(s.charged)}</td><td>$${fmt(s.paid)}</td></tr>`; });
      html += `</table>`;
      if ((d.credentialing?.detail || []).length) {
        html += `<h2>Credentialing</h2><table><tr><th>Provider</th><th>Payor</th><th>Type</th><th>Status</th><th>Submitted</th><th>Approved</th><th>Expires</th></tr>`;
        d.credentialing.detail.forEach(r => { html += `<tr><td>${r.provider || '-'}</td><td>${r.payor || '-'}</td><td>${r.type || '-'}</td><td>${r.status || '-'}</td><td>${r.submitted || '-'}</td><td>${r.approved || '-'}</td><td>${r.expires || '-'}</td></tr>`; });
        html += `</table>`;
      }
      if ((d.edi?.detail || []).length) {
        html += `<h2>EDI Setup</h2><table><tr><th>Provider</th><th>Payor</th><th>Payer ID</th><th>EDI</th><th>ERA</th><th>EFT</th><th>Go-Live</th></tr>`;
        d.edi.detail.forEach(r => { html += `<tr><td>${r.provider || '-'}</td><td>${r.payor || '-'}</td><td>${r.payer_id || '-'}</td><td>${r.edi || '-'}</td><td>${r.era || '-'}</td><td>${r.eft || '-'}</td><td>${r.go_live || '-'}</td></tr>`; });
        html += `</table>`;
      }
      html += `<h2>Payments</h2><p>Total: <strong>$${fmt(d.payments?.total)}</strong> | Count: <strong>${d.payments?.count || 0}</strong></p>`;
      html += `</body></html>`;
      const w = window.open('', '_blank', 'width=1000,height=800');
      w.document.write(html); w.document.close(); w.focus();
      setTimeout(() => w.print(), 400);
    }

    /* ‚îÄ‚îÄ GPT AI Narrative Generation ‚îÄ‚îÄ */
    let lastGPTNarrative = null;

    async function generateGPTNarrative() {
      if (!activeClientId) { toast('Select a client account first', 'error'); return; }
      const btn = document.getElementById('btnAINarrative');
      const origText = btn.innerHTML;
      btn.innerHTML = '‚è≥ Generating...';
      btn.disabled = true;
      const srcEl = document.getElementById('aiNarrativeSource');
      const narEl = document.getElementById('reportAINarrative');
      narEl.innerHTML = '<div style="text-align:center;padding:24px"><div style="font-size:32px;margin-bottom:8px">ü§ñ</div><div style="color:var(--gray-500);font-size:13px">AI is analyzing your data and writing a professional report...<br><span style="font-size:11px;color:var(--gray-400)">This may take 10-20 seconds</span></div></div>';

      try {
        const r = await fetch(`/hub/api/report/${activeClientId}/ai-narrative`, { method: 'POST' });
        if (!r.ok) {
          const err = await r.json().catch(() => ({}));
          throw new Error(err.detail || 'AI generation failed');
        }
        const data = await r.json();
        lastGPTNarrative = data.narrative;
        // Render the narrative with nice formatting
        const formatted = data.narrative
          .replace(/\n\n/g, '</p><p style="margin:10px 0">')
          .replace(/\n/g, '<br>');
        narEl.innerHTML = `<p style="margin:10px 0">${formatted}</p>`;
        srcEl.textContent = `Powered by GPT (${data.model}) ‚Äî ${new Date().toLocaleString()}`;
        toast('AI report generated!', 'success');
      } catch (e) {
        // Fallback to template narrative
        narEl.innerHTML = `<div style="background:#fef3c7;border:1px solid #fcd34d;border-radius:8px;padding:12px;margin-bottom:12px;font-size:12px;color:#92400e">
          ‚ö†Ô∏è AI generation unavailable: ${esc(e.message)}<br>Showing template-based summary instead.</div>` +
          (lastReportData ? generateAINarrative(lastReportData) : '<p style="color:var(--gray-400)">Load report data first</p>');
        srcEl.textContent = 'Template-based (AI unavailable)';
      }
      btn.innerHTML = origText;
      btn.disabled = false;
    }

    /* ‚îÄ‚îÄ PDF Download ‚îÄ‚îÄ */
    async function downloadPDF() {
      if (!activeClientId) { toast('Select a client account first', 'error'); return; }
      toast('Generating PDF...', 'info');
      try {
        const period = document.getElementById('reportPeriod')?.value || 'all';
        const sp = activeSubProfile ? `&sub_profile=${encodeURIComponent(activeSubProfile)}` : '';
        const url = `/hub/api/report/${activeClientId}/pdf?period=${period}${sp}`;
        let r;
        if (lastGPTNarrative) {
          r = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ narrative: lastGPTNarrative })
          });
        } else {
          r = await fetch(url);
        }
        if (!r.ok) throw new Error('PDF generation failed');
        const blob = await r.blob();
        const blobUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = blobUrl;
        const cd = r.headers.get('content-disposition') || '';
        const fnMatch = cd.match(/filename=([^;]+)/);
        a.download = fnMatch ? fnMatch[1] : `Report_${new Date().toISOString().slice(0, 10)}.pdf`;
        a.click();
        URL.revokeObjectURL(blobUrl);
        toast('PDF downloaded!', 'success');
      } catch (e) { toast(e.message, 'error'); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FILES & REPORTS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DOCUMENTS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const DEFAULT_DOC_TABS = ['Payor Letters', 'Company Documents', 'Credentialing Docs', 'Reports', 'General'];
    let activeDocTab = 'All';
    let allDocFiles = [];
    let currentDocTabs = [...DEFAULT_DOC_TABS];

    async function loadDocuments() {
      try {
        const url = activeClientId ? `/hub/api/files?client_id=${activeClientId}` : '/hub/api/files';
        const profUrl = activeClientId ? `/hub/api/profile/${activeClientId}` : '/hub/api/profile';
        const [fr, pr] = await Promise.all([fetch(url), fetch(profUrl).catch(() => null)]);
        allDocFiles = (await fr.json()).files || [];
        if (pr && pr.ok) {
          const pd = await pr.json();
          if (pd.doc_tabs && pd.doc_tabs.length > 0) currentDocTabs = pd.doc_tabs;
          else currentDocTabs = [...DEFAULT_DOC_TABS];
        }
        renderDocTabs();
        renderDocFiles();
        loadCompletionTracker();
      } catch (e) { console.error(e); }
    }

    // alias so old code that calls loadFiles() still works
    function loadFiles() { loadDocuments(); }

    function renderDocTabs() {
      const tabs = ['All', ...currentDocTabs];
      document.getElementById('docCategoryTabs').innerHTML = tabs.map(t => {
        const cnt = t === 'All' ? allDocFiles.length : allDocFiles.filter(f => f.category === t).length;
        return `<button class="qtab ${t === activeDocTab ? 'active' : ''}" onclick="setDocTab('${t.replace(/'/g, "\\'")}')">
          ${esc(t)} <span class="cnt">${cnt}</span>
        </button>`;
      }).join('');
    }

    function setDocTab(tab) {
      activeDocTab = tab;
      renderDocTabs();
      renderDocFiles();
    }

    function renderDocFiles() {
      const filtered = activeDocTab === 'All' ? allDocFiles : allDocFiles.filter(f => f.category === activeDocTab);
      const title = activeDocTab === 'All' ? 'All Documents' : activeDocTab;
      const titleEl = document.getElementById('docFilesTitle');
      const countEl = document.getElementById('docFilesCount');
      if (titleEl) titleEl.textContent = title;
      if (countEl) countEl.textContent = filtered.length + ' file' + (filtered.length !== 1 ? 's' : '');
      renderFiles(filtered);
    }

    function renderFiles(files) {
      const tb = document.getElementById('filesTbody');
      if (!files.length) {
        tb.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:32px;color:var(--gray-400)">No files in this category yet</td></tr>';
        return;
      }
      tb.innerHTML = files.map(f => {
        const kb = f.file_size > 0 ? (f.file_size < 1024 ? f.file_size + 'B' : f.file_size < 1048576 ? Math.round(f.file_size / 1024) + 'KB' : Math.round(f.file_size / 1048576 * 10) / 10 + 'MB') : '-';
        const stColor = f.status === 'Processed' ? 'badge-green' : f.status === 'Replaced' ? 'badge-purple' : f.status === 'Error' ? 'badge-red' : 'badge-blue';
        const ext = (f.original_name || '').split('.').pop().toLowerCase();
        const icon = ext === 'pdf' ? 'üìï' : (ext === 'doc' || ext === 'docx') ? 'üìò' : 'üìó';
        return `<tr>
          <td><strong>${icon} ${esc(f.original_name)}</strong></td>
          <td><span class="badge badge-purple">${esc(f.category)}</span></td>
          <td style="color:var(--gray-500);font-size:12px">${esc(f.description) || '-'}</td>
          <td>${kb}</td>
          <td>${esc(f.uploaded_by) || '-'}</td>
          <td style="font-size:12px">${(f.created_at || '').slice(0, 10)}</td>
          <td><span class="badge ${stColor}">${esc(f.status)}</span></td>
          <td style="white-space:nowrap;display:flex;gap:4px;align-items:center">
            <a href="/hub/api/files/${f.id}/download" class="btn btn-sm" style="color:var(--info);background:var(--info-light);border:none;text-decoration:none;font-size:12px" title="Download">‚¨á Download</a>
            <button class="btn btn-sm" style="color:#7c3aed;background:#f5f3ff;border:none;font-size:12px" onclick="replaceFile(${f.id})" title="Replace with new version">üîÑ Replace</button>
            <button class="btn btn-sm" style="color:var(--danger);background:var(--danger-light);border:none;font-size:12px" onclick="deleteFile(${f.id})" title="Delete">üóë Delete</button>
          </td>
        </tr>`;
      }).join('');
    }

    /* ‚îÄ‚îÄ Add Folder toggle ‚îÄ‚îÄ */
    let addFolderOpen = false;
    function toggleAddFolder() {
      addFolderOpen = !addFolderOpen;
      document.getElementById('addFolderForm').style.display = addFolderOpen ? '' : 'none';
      if (addFolderOpen) { document.getElementById('newFolderName').value = ''; document.getElementById('newFolderName').focus(); }
    }

    async function addNewFolder() {
      const name = (document.getElementById('newFolderName').value || '').trim();
      if (!name) { toast('Enter a folder name', 'error'); return; }
      if (currentDocTabs.some(t => t.toLowerCase() === name.toLowerCase())) { toast('Folder "' + name + '" already exists', 'error'); return; }
      currentDocTabs.push(name);
      await saveFoldersToServer();
      toggleAddFolder();
      renderDocTabs();
      renderDocFiles();
      toast('Folder "' + name + '" created!', 'success');
    }

    /* ‚îÄ‚îÄ Manage Folders toggle ‚îÄ‚îÄ */
    let renameTabsOpen = false;
    function toggleRenameDocTabs() {
      renameTabsOpen = !renameTabsOpen;
      const form = document.getElementById('renameDocTabsForm');
      form.style.display = renameTabsOpen ? '' : 'none';
      if (renameTabsOpen) buildManageFoldersList();
    }

    function buildManageFoldersList() {
      const container = document.getElementById('manageFoldersList');
      container.innerHTML = currentDocTabs.map((t, i) => {
        const fileCount = allDocFiles.filter(f => f.category === t).length;
        return `<div style="display:flex;gap:8px;align-items:center" data-folder-idx="${i}">
          <input class="form-control" id="folderRename_${i}" value="${esc(t)}" style="flex:1;max-width:280px">
          <span style="font-size:11px;color:var(--gray-400);min-width:60px">${fileCount} file${fileCount !== 1 ? 's' : ''}</span>
          <button class="btn btn-sm" style="color:var(--danger);background:var(--danger-light);border:none;font-size:12px" onclick="removeFolderAt(${i})" title="Remove folder">‚úï Remove</button>
        </div>`;
      }).join('');
    }

    function removeFolderAt(idx) {
      const folderName = currentDocTabs[idx];
      const fileCount = allDocFiles.filter(f => f.category === folderName).length;
      if (fileCount > 0) {
        if (!confirm('Folder "' + folderName + '" has ' + fileCount + ' file(s). Files will remain but be uncategorized. Continue?')) return;
      }
      currentDocTabs.splice(idx, 1);
      buildManageFoldersList();
    }

    async function saveFolderNames() {
      // Collect renamed values from inputs
      const newTabs = [];
      for (let i = 0; ; i++) {
        const el = document.getElementById('folderRename_' + i);
        if (!el) break;
        const val = el.value.trim();
        if (val) newTabs.push(val);
      }
      if (newTabs.length === 0) { toast('You must have at least one folder', 'error'); return; }
      currentDocTabs = newTabs;
      await saveFoldersToServer();
      renameTabsOpen = false;
      document.getElementById('renameDocTabsForm').style.display = 'none';
      if (activeDocTab !== 'All' && !currentDocTabs.includes(activeDocTab)) activeDocTab = 'All';
      renderDocTabs();
      renderDocFiles();
      toast('Folders updated!', 'success');
    }

    async function saveFoldersToServer() {
      try {
        const url = activeClientId ? `/hub/api/profile/${activeClientId}` : '/hub/api/profile';
        const r = await fetch(url, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ doc_tabs: currentDocTabs }) });
        if (!r.ok) throw new Error('Failed to save folders');
      } catch (e) { toast(e.message, 'error'); }
    }

    async function saveDocTabNames() { await saveFolderNames(); }

    async function loadCompletionTracker() {
      try {
        let url = activeClientId ? `/hub/api/dashboard/client/${activeClientId}` : '/hub/api/dashboard';
        if (activeSubProfile && activeClientId) url += '?sub_profile=' + encodeURIComponent(activeSubProfile);
        const r = await fetch(url);
        const d = await r.json();
        const tracker = document.getElementById('completionTracker');
        const sd = d.status_distribution || {};
        const cs = d.credentialing_stats || {};

        const totalClaims = Object.values(sd).reduce((a, b) => a + b, 0);
        const paidClaims = sd['Paid'] || 0;
        const claimPct = totalClaims ? Math.round(paidClaims / totalClaims * 100) : 0;

        const totalCred = Object.values(cs).reduce((a, b) => a + b, 0);
        const approvedCred = cs['Approved'] || 0;
        const credPct = totalCred ? Math.round(approvedCred / totalCred * 100) : 0;

        const items = [
          { label: 'Claims Billed', pct: claimPct, color: '#1e88e5', sub: paidClaims + ' of ' + totalClaims + ' paid' },
          { label: 'Credentialing', pct: credPct, color: '#10b981', sub: approvedCred + ' of ' + totalCred + ' approved' },
          { label: 'Total A/R', pct: null, value: '$' + (d.total_ar || 0).toLocaleString(), color: '#ef4444', sub: d.active_claims + ' active claims' },
        ];

        tracker.innerHTML = items.map(item => `
          <div style="background:#fff;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.08)">
            <div style="font-size:12px;font-weight:700;color:var(--gray-500);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">${item.label}</div>
            ${item.pct !== null ? `
              <div style="font-size:28px;font-weight:700;color:${item.color};margin-bottom:8px">${item.pct}%</div>
              <div style="background:var(--gray-200);border-radius:20px;height:6px;overflow:hidden">
                <div style="background:${item.color};height:100%;width:${item.pct}%;transition:width .5s"></div>
              </div>` :
            `<div style="font-size:28px;font-weight:700;color:${item.color};margin-bottom:8px">${item.value}</div>`
          }
            <div style="font-size:12px;color:var(--gray-400);margin-top:6px">${item.sub}</div>
          </div>`).join('');
      } catch (e) { console.error(e); }
    }

    function handleFileSelect(input) {
      if (input.files) Array.from(input.files).forEach(f => uploadFile(f));
      input.value = '';
    }
    function handleFileDrop(e) {
      e.preventDefault();
      Array.from(e.dataTransfer.files).forEach(f => uploadFile(f));
    }

    async function uploadFile(file) {
      // Verify session is still valid before uploading
      if (!(await checkSession())) return;
      const ext = (file.name || '').split('.').pop().toLowerCase();
      const isExcel = ['xlsx', 'xls', 'csv'].includes(ext);

      // Determine the category ‚Äî for Excel files, ask the user where data should go
      let category = (activeDocTab && activeDocTab !== 'All') ? activeDocTab : (currentDocTabs[0] || 'General');

      if (isExcel && activeClientId) {
        const choice = await showImportChoice(file.name);
        if (choice === 'cancel') return;
        // Use chosen category ‚Äî data sections auto-import AND save file as hard copy
        if (choice !== 'document') category = choice;
      }

      if (!activeClientId) { toast('Select a client account first', 'error'); return; }

      const description = document.getElementById('fileDesc')?.value || '';
      const fd = new FormData();
      fd.append('file', file);
      fd.append('category', category);
      fd.append('description', description);
      fd.append('client_id', activeClientId);

      const isDataImport = isExcel && ['Claims', 'Credentialing', 'EDI'].includes(category);
      toast(isDataImport ? `Importing ${file.name} into ${category}‚Ä¶` : `Uploading ${file.name}‚Ä¶`, 'info');

      try {
        const r = await fetch('/hub/api/files/upload', { method: 'POST', body: fd });
        const d = await r.json();
        if (!r.ok) throw new Error(d.detail || 'Upload failed');

        if (d.imported > 0) {
          toast(`‚úÖ Imported ${d.imported} rows into ${d.import_category} ‚Äî file saved as hard copy`, 'success');
          if (d.import_errors && d.import_errors.length) toast(`‚ö†Ô∏è ${d.import_errors.length} row(s) had errors`, 'warning');
        } else if (d.import_category) {
          toast(`‚ö†Ô∏è File saved but no rows imported ‚Äî check column headers match expected format`, 'warning');
          if (d.import_errors && d.import_errors.length) {
            console.warn('Import errors:', d.import_errors);
            d.import_errors.forEach(e => toast(e, 'warning'));
          }
        } else {
          toast(`${file.name} uploaded!`, 'success');
        }
        // Always refresh the relevant data section after upload
        if (d.import_category === 'Claims') loadClaims();
        else if (d.import_category === 'Credentialing') loadCred();
        else if (d.import_category === 'EDI') loadEdi();
        loadDashboard();
        loadDocuments();
      } catch (e) { toast(e.message, 'error'); }
    }

    function showImportChoice(filename) {
      return new Promise(resolve => {
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:600;display:flex;align-items:center;justify-content:center';
        const box = document.createElement('div');
        box.style.cssText = 'background:#fff;border-radius:16px;padding:28px;max-width:420px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3)';
        box.innerHTML = `
          <div style="font-size:18px;font-weight:700;color:var(--gray-800);margin-bottom:6px">üìä Import Data from Excel?</div>
          <div style="font-size:13px;color:var(--gray-500);margin-bottom:18px"><strong>${esc(filename)}</strong> ‚Äî Where should this data go?</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
            <button onclick="this.closest('.import-choice').resolve('Claims')" class="btn btn-sm" style="padding:12px;background:var(--info-light);color:var(--info);border:2px solid var(--info);border-radius:10px;font-weight:700;font-size:13px">üí∞ Claims</button>
            <button onclick="this.closest('.import-choice').resolve('Credentialing')" class="btn btn-sm" style="padding:12px;background:#f0fdf4;color:#059669;border:2px solid #059669;border-radius:10px;font-weight:700;font-size:13px">üìã Credentialing</button>
            <button onclick="this.closest('.import-choice').resolve('EDI')" class="btn btn-sm" style="padding:12px;background:#faf5ff;color:#7c3aed;border:2px solid #7c3aed;border-radius:10px;font-weight:700;font-size:13px">üîå EDI Setup</button>
          </div>
          <div style="display:flex;gap:8px">
            <button onclick="this.closest('.import-choice').resolve('document')" class="btn btn-secondary btn-sm" style="flex:1">üìÇ Just Save as Document</button>
            <button onclick="this.closest('.import-choice').resolve('cancel')" class="btn btn-sm" style="flex:1;background:var(--gray-100);color:var(--gray-500);border:none">Cancel</button>
          </div>`;
        overlay.className = 'import-choice';
        overlay.resolve = (val) => { document.body.removeChild(overlay); resolve(val); };
        overlay.appendChild(box);
        // Wire up button clicks via event delegation
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) { document.body.removeChild(overlay); resolve('cancel'); }
        });
        box.querySelectorAll('button').forEach(btn => {
          const origOnclick = btn.getAttribute('onclick');
          if (origOnclick) {
            btn.removeAttribute('onclick');
            const match = origOnclick.match(/resolve\('(\w+)'\)/);
            if (match) btn.addEventListener('click', () => overlay.resolve(match[1]));
          }
        });
        document.body.appendChild(overlay);
      });
    }

    async function deleteFile(id) {
      if (!confirm('Delete this file? This cannot be undone.')) return;
      try {
        const r = await fetch(`/hub/api/files/${id}`, { method: 'DELETE' });
        if (!r.ok) throw new Error('Failed');
        toast('File deleted', 'success'); loadDocuments();
      } catch (e) { toast(e.message, 'error'); }
    }

    function replaceFile(fileId) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.xlsx,.xls,.csv,.pdf,.doc,.docx';
      input.style.display = 'none';
      input.onchange = async () => {
        if (!input.files || !input.files.length) return;
        const file = input.files[0];
        if (!confirm(`Replace this file with "${file.name}"?\n\nIf this is an Excel in a data category (Claims, Credentialing, etc.), the data will be re-imported from the new file.`)) return;
        const fd = new FormData();
        fd.append('file', file);
        toast(`Replacing with ${file.name}‚Ä¶`, 'info');
        try {
          const r = await fetch(`/hub/api/files/${fileId}/replace`, { method: 'POST', body: fd });
          const d = await r.json();
          if (!r.ok) throw new Error(d.detail || 'Replace failed');
          if (d.imported > 0) {
            toast(`‚úÖ File replaced & re-imported ${d.imported} rows`, 'success');
          } else {
            toast(`‚úÖ File replaced successfully`, 'success');
          }
          if (d.import_errors && d.import_errors.length) {
            toast(`‚ö†Ô∏è ${d.import_errors.length} import error(s)`, 'warning');
          }
          loadDocuments();
          loadDashboard();
          // Refresh relevant section
          loadClaims(); loadCred(); loadEdi();
        } catch (e) { toast(e.message, 'error'); }
        input.remove();
      };
      document.body.appendChild(input);
      input.click();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PROFILE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadProfile() {
      try {
        const url = activeClientId ? `/hub/api/profile/${activeClientId}` : '/hub/api/profile';
        const r = await fetch(url);
        if (!r.ok) throw new Error('Failed to load profile');
        const d = await r.json();
        const isCombined = (d.practice_type === 'MHP+OMT');
        const fields = ['company', 'contact_name', 'email', 'phone', 'tax_id', 'group_npi',
          'individual_npi', 'ptan_group', 'ptan_individual', 'address', 'specialty', 'notes'];
        fields.forEach(f => {
          const el = document.getElementById('pf-' + f);
          if (el) el.value = d[f] || '';
        });
        const titleEl = document.getElementById('profilePanelTitle');
        if (titleEl && d.company) titleEl.textContent = 'üè∑Ô∏è ' + d.company + (isCombined ? ' ‚Äî Sub-Profiles' : ' ‚Äî Profile');
        // For MHP+OMT (e.g. Luminary): hide main profile form, only show sub-profiles
        const mainProfileCards = document.querySelectorAll('#panel-profile > .card');
        mainProfileCards.forEach(c => c.style.display = isCombined ? 'none' : '');
        const saveBtn = document.querySelector('#panel-profile .page-actions .btn-primary');
        if (saveBtn) saveBtn.style.display = isCombined ? 'none' : '';
        // Sub-profiles for MHP+OMT practices
        const sect = document.getElementById('subProfilesSection');
        if (sect) sect.style.display = isCombined ? '' : 'none';
        if (isCombined) loadPracticeProfiles();
      } catch (e) { console.error(e); toast('Could not load profile', 'error'); }
    }

    async function loadPracticeProfiles() {
      try {
        const cid = activeClientId;
        const url = cid ? `/hub/api/practice-profiles/${cid}` : '/hub/api/practice-profiles';
        const r = await fetch(url);
        if (!r.ok) return;
        const d = await r.json();
        renderPracticeProfiles(d.profiles || []);
      } catch (e) { console.error(e); }
    }

    function renderPracticeProfiles(profiles) {
      const grid = document.getElementById('subProfilesGrid');
      if (!grid) return;
      const profFields = [
        { key: 'practice_type', label: 'Practice Type', placeholder: 'e.g. Ancillary' },
        { key: 'specialty', label: 'Specialty', placeholder: 'e.g. Mental Health' },
        { key: 'tax_id', label: 'Tax ID', placeholder: 'XX-XXXXXXX', mono: true },
        { key: 'group_npi', label: 'Group NPI', placeholder: '10-digit NPI', mono: true },
        { key: 'individual_npi', label: 'Individual NPI', placeholder: '10-digit NPI', mono: true },
        { key: 'ptan_group', label: 'Medicare PTAN (Group)', placeholder: 'e.g. MI120440', mono: true },
        { key: 'ptan_individual', label: 'Medicare PTAN (Individual)', placeholder: '', mono: true },
        { key: 'address', label: 'Address', placeholder: 'Street, City, State ZIP', span: true },
        { key: 'contact_name', label: 'Contact Name', placeholder: 'Full name' },
        { key: 'email', label: 'Email', placeholder: 'billing@example.com' },
        { key: 'phone', label: 'Phone', placeholder: '(555) 000-0000' },
        { key: 'notes', label: 'Notes', placeholder: 'Additional notes...', textarea: true, span: true },
      ];
      const typeColors = { MHP: '#4f46e5', OMT: '#0891b2' };
      grid.innerHTML = profiles.map(p => {
        const color = typeColors[p.profile_name] || '#6b7280';
        return `<div class="card" style="position:relative;overflow:hidden">
          <div style="position:absolute;top:0;left:0;right:0;height:4px;background:${color}"></div>
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;padding-top:12px">
            <div style="display:flex;align-items:center;gap:10px">
              <div style="background:${color};color:#fff;border-radius:8px;padding:4px 12px;font-weight:700;font-size:13px">${esc(p.profile_name)}</div>
              <div class="card-title" style="margin:0">${esc(p.practice_type || 'Ancillary Practice')}</div>
            </div>
            <button class="btn btn-sm" style="color:var(--danger);background:var(--danger-light);border:none"
              onclick="deleteSubProfile(${p.id},'${esc(p.profile_name)}')">Remove</button>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px">
            ${profFields.map(f => `
              <div class="form-group" style="${f.span ? 'grid-column:span 2' : ''}">
                <label style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--gray-400)">${f.label}</label>
                ${f.textarea
            ? `<textarea class="form-control" id="sp-${p.id}-${f.key}" rows="2" placeholder="${f.placeholder}" style="font-size:13px">${esc(p[f.key] || '')}</textarea>`
            : `<input class="form-control" id="sp-${p.id}-${f.key}" value="${esc(p[f.key] || '')}" placeholder="${f.placeholder}" style="font-size:13px${f.mono ? ';font-family:monospace' : ''}">`
          }
              </div>`).join('')}
          </div>
          <div style="margin-top:12px;text-align:right">
            <button class="btn btn-primary btn-sm" onclick="saveSubProfile(${p.id},'${esc(p.profile_name)}')">&#128190; Save ${esc(p.profile_name)}</button>
          </div>
        </div>`;
      }).join('') || '<p style="color:var(--gray-400);font-size:14px;padding:8px">No sub-profiles yet. Click + Add Sub-Profile.</p>';
    }

    async function saveSubProfile(id, profileName) {
      const profFields = ['practice_type', 'specialty', 'tax_id', 'group_npi', 'individual_npi',
        'ptan_group', 'ptan_individual', 'address', 'contact_name', 'email', 'phone', 'notes'];
      const data = {};
      profFields.forEach(f => {
        const el = document.getElementById(`sp-${id}-${f}`);
        if (el) data[f] = el.value;
      });
      try {
        const cid = activeClientId;
        const url = cid ? `/hub/api/practice-profiles/${cid}/${profileName}` : `/hub/api/practice-profiles/${profileName}`;
        const r = await fetch(url, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        if (!r.ok) throw new Error('Save failed');
        toast(`${profileName} sub-profile saved!`, 'success');
      } catch (e) { toast(e.message, 'error'); }
    }

    async function deleteSubProfile(id, profileName) {
      if (!confirm(`Remove the ${profileName} sub-profile?`)) return;
      try {
        const r = await fetch(`/hub/api/practice-profiles/${id}`, { method: 'DELETE' });
        if (!r.ok) throw new Error('Failed');
        toast(`${profileName} removed`, 'success');
        loadPracticeProfiles();
      } catch (e) { toast(e.message, 'error'); }
    }

    function showAddSubProfilePrompt() {
      const name = prompt('Enter sub-profile name (e.g. MHP, OMT, Ancillary):');
      if (!name || !name.trim()) return;
      const cid = activeClientId;
      const url = cid ? `/hub/api/practice-profiles/${cid}/${name.trim()}` : `/hub/api/practice-profiles/${name.trim()}`;
      fetch(url, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ practice_type: 'Ancillary' }) })
        .then(r => { if (!r.ok) throw new Error('Failed'); toast(name.trim() + ' sub-profile added!', 'success'); loadPracticeProfiles(); })
        .catch(e => toast(e.message, 'error'));
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TEAM PRODUCTION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let prodViewMode = 'log'; // 'log' or 'report'

    function toggleProductionView(mode) {
      prodViewMode = mode;
      document.getElementById('prodLogView').style.display = mode === 'log' ? '' : 'none';
      document.getElementById('prodReportView').style.display = mode === 'report' ? '' : 'none';
      document.getElementById('btnProdLog').className = mode === 'log' ? 'btn btn-primary btn-sm' : 'btn btn-secondary btn-sm';
      document.getElementById('btnProdReport').className = mode === 'report' ? 'btn btn-primary btn-sm' : 'btn btn-secondary btn-sm';
      if (mode === 'log') loadProduction();
    }

    async function loadProduction() {
      if (!activeClientId) return;
      // Set today's date as default
      const dateEl = document.getElementById('prodDate');
      if (dateEl && !dateEl.value) dateEl.value = new Date().toISOString().split('T')[0];

      // Set default report dates (last 7 days)
      const rptStart = document.getElementById('prodRptStart');
      const rptEnd = document.getElementById('prodRptEnd');
      if (rptStart && !rptStart.value) {
        const d = new Date(); d.setDate(d.getDate() - 7);
        rptStart.value = d.toISOString().split('T')[0];
      }
      if (rptEnd && !rptEnd.value) rptEnd.value = new Date().toISOString().split('T')[0];

      const filterDate = document.getElementById('prodFilterDate')?.value || '';
      let url = `/hub/api/production?client_id=${activeClientId}`;
      if (filterDate) url += `&start_date=${filterDate}&end_date=${filterDate}`;

      try {
        const r = await fetch(url);
        const d = await r.json();
        const logs = d.logs || [];
        const tbody = document.getElementById('prodTbody');
        if (!logs.length) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--gray-400);padding:24px">No production entries yet. Log your first task above!</td></tr>';
          return;
        }
        tbody.innerHTML = logs.map(l => `<tr>
          <td style="font-weight:600;white-space:nowrap">${esc(l.work_date)}</td>
          <td><span class="badge badge-blue">${esc(l.username)}</span></td>
          <td><span class="badge badge-purple">${esc(l.category)}</span></td>
          <td>${esc(l.task_description)}</td>
          <td style="text-align:center;font-weight:600">${l.quantity}</td>
          <td style="text-align:center;font-weight:600">${l.time_spent}h</td>
          <td style="font-size:12px;color:var(--gray-500)">${esc(l.notes || '')}</td>
          <td><button class="btn btn-sm" style="color:var(--danger);background:var(--danger-light);border:none;font-size:11px" onclick="deleteProductionLog(${l.id})">üóëÔ∏è</button></td>
        </tr>`).join('');
      } catch (e) { console.error(e); }
    }

    async function saveProductionLog() {
      if (!activeClientId) { toast('Select a client account first', 'error'); return; }
      const data = {
        client_id: activeClientId,
        work_date: document.getElementById('prodDate').value,
        category: document.getElementById('prodCategory').value,
        task_description: document.getElementById('prodTask').value,
        quantity: parseInt(document.getElementById('prodQty').value) || 0,
        time_spent: parseFloat(document.getElementById('prodHours').value) || 0,
        notes: document.getElementById('prodNotes').value,
      };
      if (!data.work_date) { toast('Please select a date', 'error'); return; }
      if (!data.task_description) { toast('Please describe the task', 'error'); return; }
      if (data.time_spent <= 0) { toast('Please enter time spent', 'error'); return; }
      try {
        const r = await fetch('/hub/api/production', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
        });
        if (!r.ok) throw new Error((await r.json()).detail || 'Failed');
        toast('Production entry logged!', 'success');
        document.getElementById('prodTask').value = '';
        document.getElementById('prodQty').value = '0';
        document.getElementById('prodHours').value = '0';
        document.getElementById('prodNotes').value = '';
        loadProduction();
      } catch (e) { toast(e.message, 'error'); }
    }

    async function deleteProductionLog(id) {
      if (!confirm('Delete this production entry?')) return;
      try {
        const r = await fetch(`/hub/api/production/${id}`, { method: 'DELETE' });
        if (!r.ok) throw new Error('Failed');
        toast('Entry deleted', 'success');
        loadProduction();
      } catch (e) { toast(e.message, 'error'); }
    }

    async function loadProductionReport() {
      const start = document.getElementById('prodRptStart').value;
      const end = document.getElementById('prodRptEnd').value;
      if (!start || !end) { toast('Please select start and end dates', 'error'); return; }

      let url = `/hub/api/production/report?start_date=${start}&end_date=${end}`;
      if (activeClientId) url += `&client_id=${activeClientId}`;

      try {
        const r = await fetch(url);
        const d = await r.json();
        renderProductionReport(d, start, end);
      } catch (e) { toast('Failed to load report', 'error'); console.error(e); }
    }

    function renderProductionReport(data, start, end) {
      const el = document.getElementById('prodReportContent');
      const byUser = data.by_user || [];
      const byCat = data.by_category || [];
      const details = data.details || [];
      const flags = data.time_management_flags || [];

      let html = '';

      // Time management flags
      if (flags.length) {
        html += `<div class="card" style="margin-bottom:18px;border-left:4px solid var(--danger)">
          <div class="card-header"><div class="card-title" style="color:var(--danger)">‚ö†Ô∏è Time Management Alerts</div></div>
          <div style="margin-top:8px">
            ${flags.map(f => `<div style="padding:8px 0;border-bottom:1px solid var(--gray-100);display:flex;justify-content:space-between;align-items:center">
              <div><strong>${esc(f.username)}</strong> ‚Äî averaging <strong>${f.avg_hours_per_day}h/day</strong> over ${f.days_worked} day(s)</div>
              <span class="badge badge-red">${f.recommendation}</span>
            </div>`).join('')}
          </div>
        </div>`;
      }

      // Summary by user
      html += `<div class="card" style="margin-bottom:18px">
        <div class="card-header"><div class="card-title">üë• Team Summary (${esc(start)} to ${esc(end)})</div></div>
        <div class="table-wrap" style="margin-top:8px"><table>
          <thead><tr><th>Team Member</th><th>Days Worked</th><th>Total Entries</th><th>Total Items</th><th>Total Hours</th><th>Avg Hrs/Day</th></tr></thead>
          <tbody>${byUser.map(u => `<tr>
            <td style="font-weight:600">${esc(u.username)}</td>
            <td style="text-align:center">${u.days_worked}</td>
            <td style="text-align:center">${u.total_entries}</td>
            <td style="text-align:center;font-weight:600">${u.total_quantity || 0}</td>
            <td style="text-align:center;font-weight:600">${u.total_hours || 0}h</td>
            <td style="text-align:center"><span class="badge ${(u.avg_hours_per_day || 0) < 6 ? 'badge-red' : 'badge-green'}">${u.avg_hours_per_day || 0}h</span></td>
          </tr>`).join('') || '<tr><td colspan="6" style="text-align:center;color:var(--gray-400)">No data</td></tr>'}</tbody>
        </table></div>
      </div>`;

      // Summary by category
      html += `<div class="card" style="margin-bottom:18px">
        <div class="card-header"><div class="card-title">üìä Work by Category</div></div>
        <div class="table-wrap" style="margin-top:8px"><table>
          <thead><tr><th>Category</th><th>Entries</th><th>Items</th><th>Hours</th></tr></thead>
          <tbody>${byCat.map(c => `<tr>
            <td><span class="badge badge-purple">${esc(c.category || 'Uncategorized')}</span></td>
            <td style="text-align:center">${c.total_entries}</td>
            <td style="text-align:center">${c.total_quantity || 0}</td>
            <td style="text-align:center;font-weight:600">${c.total_hours || 0}h</td>
          </tr>`).join('') || '<tr><td colspan="4" style="text-align:center;color:var(--gray-400)">No data</td></tr>'}</tbody>
        </table></div>
      </div>`;

      // Detailed daily log
      html += `<div class="card">
        <div class="card-header"><div class="card-title">üìã Detailed Daily Log</div></div>
        <div class="table-wrap" style="margin-top:8px"><table>
          <thead><tr><th>Date</th><th>User</th><th>Category</th><th>Task</th><th>Qty</th><th>Hours</th><th>Notes</th></tr></thead>
          <tbody>${details.map(d => `<tr>
            <td style="white-space:nowrap;font-weight:600">${esc(d.work_date)}</td>
            <td><span class="badge badge-blue">${esc(d.username)}</span></td>
            <td><span class="badge badge-purple">${esc(d.category)}</span></td>
            <td>${esc(d.task_description)}</td>
            <td style="text-align:center">${d.quantity}</td>
            <td style="text-align:center">${d.time_spent}h</td>
            <td style="font-size:12px;color:var(--gray-500)">${esc(d.notes || '')}</td>
          </tr>`).join('') || '<tr><td colspan="7" style="text-align:center;color:var(--gray-400)">No entries in this period</td></tr>'}</tbody>
        </table></div>
      </div>`;

      el.innerHTML = html;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NEW CLIENT FROM ACCOUNT SELECTOR
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showNewClientFromSelector() {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:600;display:flex;align-items:center;justify-content:center';
      const box = document.createElement('div');
      box.style.cssText = 'background:#fff;border-radius:16px;padding:28px;max-width:480px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3)';
      box.innerHTML = `
        <div style="font-size:18px;font-weight:700;color:var(--gray-800);margin-bottom:16px">üè¢ Create New Client</div>
        <div class="form-grid">
          <div class="form-group"><label>Username *</label><input class="form-control" id="ncUsername" placeholder="login username"></div>
          <div class="form-group"><label>Password *</label><input class="form-control" type="password" id="ncPassword" placeholder="password"></div>
        </div>
        <div class="form-grid">
          <div class="form-group"><label>Company Name *</label><input class="form-control" id="ncCompany" placeholder="e.g. ABC Medical"></div>
          <div class="form-group"><label>Contact Name</label><input class="form-control" id="ncContact" placeholder="Full name"></div>
        </div>
        <div class="form-grid">
          <div class="form-group"><label>Email</label><input class="form-control" type="email" id="ncEmail" placeholder="email@example.com"></div>
          <div class="form-group"><label>Phone</label><input class="form-control" id="ncPhone" placeholder="(555) 000-0000"></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:16px">
          <button class="btn btn-primary" id="ncSubmitBtn" style="flex:1">Create Client</button>
          <button class="btn btn-secondary" id="ncCancelBtn" style="flex:1">Cancel</button>
        </div>`;
      overlay.appendChild(box);
      overlay.addEventListener('click', e => { if (e.target === overlay) { document.body.removeChild(overlay); } });
      box.querySelector('#ncCancelBtn').addEventListener('click', () => document.body.removeChild(overlay));
      box.querySelector('#ncSubmitBtn').addEventListener('click', async () => {
        const data = {
          username: document.getElementById('ncUsername').value.trim(),
          password: document.getElementById('ncPassword').value,
          company: document.getElementById('ncCompany').value.trim(),
          contact_name: document.getElementById('ncContact').value.trim(),
          email: document.getElementById('ncEmail').value.trim(),
          phone: document.getElementById('ncPhone').value.trim(),
        };
        if (!data.username || !data.password || !data.company) { toast('Username, password, and company are required', 'error'); return; }
        try {
          const r = await fetch('/hub/api/clients', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
          });
          if (!r.ok) throw new Error((await r.json()).detail || 'Failed to create');
          document.body.removeChild(overlay);
          toast('Client created!', 'success');
          showAccountSelector();  // Refresh the account list
        } catch (e) { toast(e.message, 'error'); }
      });
      document.body.appendChild(overlay);
    }

    async function saveProfile() {
      const fields = ['company', 'contact_name', 'email', 'phone', 'tax_id', 'group_npi',
        'individual_npi', 'ptan_group', 'ptan_individual', 'address', 'specialty', 'notes'];
      const data = {};
      fields.forEach(f => {
        const el = document.getElementById('pf-' + f);
        if (el) data[f] = el.value;
      });
      try {
        const url = activeClientId ? `/hub/api/profile/${activeClientId}` : '/hub/api/profile';
        const r = await fetch(url, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        if (!r.ok) {
          const e = await r.json().catch(() => ({}));
          throw new Error(e.detail || `Save failed (${r.status})`);
        }
        toast('Profile saved!', 'success');
        // Refresh dashboard profile card if visible
        const dashPanel = document.getElementById('panel-dashboard');
        if (dashPanel && dashPanel.classList.contains('active')) loadDashboard();
        // Also update the account selector's company display
        const topEl = document.getElementById('topAccount');
        if (topEl && data.company) topEl.textContent = data.company;
      } catch (e) { toast(e.message, 'error'); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GLOBAL SEARCH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let searchTimer = null;
    function debounceGlobalSearch() {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(runGlobalSearch, 350);
    }

    async function runGlobalSearch() {
      const q = document.getElementById('globalSearchInput')?.value?.trim();
      const dd = document.getElementById('searchDropdown');
      if (!q || q.length < 2) { dd.style.display = 'none'; return; }
      try {
        const params = new URLSearchParams({ q });
        if (activeClientId) params.set('client_id', activeClientId);
        const r = await fetch('/hub/api/search?' + params);
        const d = await r.json();
        if (!d.results?.length) {
          dd.innerHTML = '<div style="padding:16px;text-align:center;color:var(--gray-400);font-size:13px">No results found</div>';
        } else {
          dd.innerHTML = d.results.map(item => `
            <div class="search-result-item" onclick="navigateToSearchResult('${item.type}', ${item.id})">
              <span class="sr-type ${item.type}">${item.type}</span>
              <div>
                <div class="sr-title">${esc(item.title || '')}</div>
                <div class="sr-subtitle">${esc(item.subtitle || '')}</div>
              </div>
              ${item.status ? `<span class="badge" style="margin-left:auto">${esc(item.status)}</span>` : ''}
            </div>
          `).join('');
        }
        dd.style.display = 'block';
      } catch (e) { console.error(e); }
    }

    function navigateToSearchResult(type, id) {
      document.getElementById('searchDropdown').style.display = 'none';
      document.getElementById('globalSearchInput').value = '';
      const panelMap = { claim: 'claims', provider: 'providers', credentialing: 'credentialing', edi: 'edi' };
      navTo(panelMap[type] || 'dashboard');
    }

    // Close search dropdown on click outside
    document.addEventListener('click', (e) => {
      const dd = document.getElementById('searchDropdown');
      const input = document.getElementById('globalSearchInput');
      if (dd && !dd.contains(e.target) && e.target !== input) dd.style.display = 'none';
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ALERTS & NOTIFICATIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadAlerts() {
      const params = new URLSearchParams();
      if (activeClientId) params.set('client_id', activeClientId);
      try {
        const testBtn = document.getElementById('btnTestNotice');
        const healthBanner = document.getElementById('notificationHealthBanner');
        if (testBtn) {
          const isAdmin = currentUser && currentUser.role === 'admin';
          testBtn.style.display = isAdmin ? '' : 'none';
        }

        if (healthBanner) healthBanner.style.display = 'none';
        if (currentUser && currentUser.role === 'admin') {
          try {
            const sr = await fetch('/hub/api/notifications/status');
            if (sr.ok) {
              const s = await sr.json();
              const emailOn = !!s.email_configured;
              const smsOn = !!s.twilio_configured;
              if (healthBanner) {
                if (!emailOn || !smsOn) {
                  const issues = [];
                  if (!emailOn) issues.push('Email OFF');
                  if (!smsOn) issues.push('SMS OFF');
                  const details = [];
                  if (!emailOn && Array.isArray(s.missing_email_fields) && s.missing_email_fields.length) {
                    details.push(`Email missing: ${s.missing_email_fields.join(', ')}`);
                  }
                  if (!smsOn && Array.isArray(s.missing_twilio_fields) && s.missing_twilio_fields.length) {
                    details.push(`SMS missing: ${s.missing_twilio_fields.join(', ')}`);
                  }
                  healthBanner.style.display = '';
                  healthBanner.style.background = 'var(--danger-light)';
                  healthBanner.style.border = '1px solid var(--danger)';
                  healthBanner.style.color = '#b91c1c';
                  healthBanner.textContent = `‚ö†Ô∏è Notification Health: ${issues.join(' | ')} ‚Äî ${details.join(' | ') || 'configure providers in environment variables.'}`;
                } else {
                  healthBanner.style.display = '';
                  healthBanner.style.background = 'var(--success-light)';
                  healthBanner.style.border = '1px solid var(--success)';
                  healthBanner.style.color = '#065f46';
                  healthBanner.textContent = '‚úÖ Notification Health: Email and SMS are configured.';
                }
              }
            }
          } catch (_) { }
        }

        const r = await fetch('/hub/api/alerts?' + params);
        const d = await r.json();
        const alerts = d.alerts || [];

        // Update badges
        const bellBadge = document.getElementById('alertsBadge');
        const navBadge = document.getElementById('navAlertsBadge');
        if (alerts.length > 0) {
          bellBadge.textContent = alerts.length; bellBadge.style.display = '';
          navBadge.textContent = alerts.length; navBadge.style.display = '';
        } else {
          bellBadge.style.display = 'none';
          navBadge.style.display = 'none';
        }

        // Render alerts panel
        const el = document.getElementById('alertsContent');
        if (!el) return;
        if (!alerts.length) {
          el.innerHTML = `<div class="card" style="text-align:center;padding:40px">
            <div style="font-size:48px;margin-bottom:12px">‚úÖ</div>
            <p style="color:var(--gray-500);font-size:15px;font-weight:600">No active alerts</p>
            <p style="color:var(--gray-400);font-size:13px;margin-top:4px">Everything looks good! All metrics are within normal ranges.</p>
          </div>`;
          return;
        }
        el.innerHTML = alerts.map(a => `
          <div class="alert-card ${a.type}">
            <div class="alert-icon">${a.icon || '‚ö†Ô∏è'}</div>
            <div class="alert-body">
              <div class="alert-title">${esc(a.title)}</div>
              <div class="alert-detail">${esc(a.detail)}</div>
            </div>
          </div>
        `).join('');
      } catch (e) { console.error(e); }
    }

    async function sendTestNotice() {
      const btn = document.getElementById('btnTestNotice');
      const statusEl = document.getElementById('testNoticeStatus');
      const oldText = btn ? btn.innerHTML : '';
      try {
        if (btn) { btn.disabled = true; btn.innerHTML = '‚è≥ Sending...'; }
        if (statusEl) {
          statusEl.style.display = '';
          statusEl.style.color = 'var(--gray-500)';
          statusEl.textContent = 'Sending test notice...';
        }
        const r = await fetch('/hub/api/notifications/test', { method: 'POST' });
        const d = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(d.detail || 'Test notification failed');

        const channels = [];
        if (d.sendgrid_configured || d.smtp_configured) channels.push('email');
        if (d.twilio_configured) channels.push('sms');
        const smsReason = (!d.twilio_configured && Array.isArray(d.missing_twilio_fields) && d.missing_twilio_fields.length)
          ? `SMS missing: ${d.missing_twilio_fields.join(', ')}`
          : '';
        const msg = channels.length
          ? `Test notice queued via ${channels.join(' + ')}`
          : `Test endpoint worked, but no email/SMS provider is configured${smsReason ? ` (${smsReason})` : ''}`;
        toast(msg, channels.length ? 'success' : 'warning');

        if (statusEl) {
          const ts = new Date().toLocaleString();
          statusEl.style.display = '';
          statusEl.style.color = channels.length ? 'var(--success)' : 'var(--warning)';
          statusEl.textContent = `Last test: ${ts} ‚Äî ${msg}`;
        }
      } catch (e) {
        toast(e.message || 'Failed to send test notice', 'error');
        if (statusEl) {
          const ts = new Date().toLocaleString();
          statusEl.style.display = '';
          statusEl.style.color = 'var(--danger)';
          statusEl.textContent = `Last test: ${ts} ‚Äî ${e.message || 'Failed to send test notice'}`;
        }
      } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = oldText || 'üì® Send Test Notice'; }
      }
    }

    // Load alerts on dashboard too ‚Äî update badge count
    const _origLoadDash = loadDashboard;
    loadDashboard = async function () {
      await _origLoadDash();
      loadAlerts();
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // AUDIT LOG
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadAuditLog() {
      const params = new URLSearchParams({ limit: '200' });
      if (activeClientId) params.set('client_id', activeClientId);
      try {
        const r = await fetch('/hub/api/audit-log?' + params);
        const d = await r.json();
        const entries = d.entries || [];
        const tbody = document.getElementById('auditTbody');
        if (!entries.length) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--gray-400);padding:24px">No audit entries</td></tr>';
          return;
        }
        tbody.innerHTML = entries.map(e => `<tr>
          <td style="font-size:12px;white-space:nowrap">${esc(e.created_at || '')}</td>
          <td><span class="badge badge-blue">${esc(e.username || '')}</span></td>
          <td><span class="badge badge-purple">${esc(e.action || '')}</span></td>
          <td style="font-size:12px">${esc(e.entity_type || '')}${e.entity_id ? ' #' + e.entity_id : ''}</td>
          <td style="font-size:12px;max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(e.details || '')}</td>
        </tr>`).join('');
      } catch (e) { console.error(e); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BULK CLAIM STATUS UPDATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let selectedClaimIds = new Set();

    function toggleAllClaims(masterCb) {
      document.querySelectorAll('.claim-cb').forEach(cb => {
        cb.checked = masterCb.checked;
        if (masterCb.checked) selectedClaimIds.add(parseInt(cb.value));
        else selectedClaimIds.delete(parseInt(cb.value));
      });
      updateBulkBar();
    }

    function updateBulkBar() {
      selectedClaimIds = new Set();
      document.querySelectorAll('.claim-cb:checked').forEach(cb => selectedClaimIds.add(parseInt(cb.value)));
      const bar = document.getElementById('bulkActionBar');
      if (selectedClaimIds.size > 0) {
        bar.style.display = 'flex';
        document.getElementById('bulkCount').textContent = selectedClaimIds.size;
        // Populate status dropdown
        const sel = document.getElementById('bulkStatusSelect');
        if (sel.options.length <= 1) {
          QUEUE_STATUSES.filter(s => s !== 'All').forEach(s => {
            sel.add(new Option(s, s));
          });
        }
      } else {
        bar.style.display = 'none';
      }
    }

    function clearBulkSelection() {
      selectedClaimIds.clear();
      document.querySelectorAll('.claim-cb').forEach(cb => cb.checked = false);
      document.getElementById('claimSelectAll').checked = false;
      document.getElementById('bulkActionBar').style.display = 'none';
    }

    async function applyBulkUpdate() {
      if (!selectedClaimIds.size) return toast('No claims selected', 'error');
      const data = { claim_ids: Array.from(selectedClaimIds) };
      const status = document.getElementById('bulkStatusSelect').value;
      const owner = document.getElementById('bulkOwner').value.trim();
      if (status) data.ClaimStatus = status;
      if (owner) data.Owner = owner;
      if (!status && !owner) return toast('Select a status or enter an owner', 'error');
      try {
        const r = await fetch('/hub/api/claims/bulk-status', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
        });
        const result = await r.json();
        toast(`Updated ${result.updated} claims`, 'success');
        clearBulkSelection();
        loadClaims();
      } catch (e) { toast(e.message, 'error'); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EXPORT TO CSV
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function exportSection(section) {
      const params = new URLSearchParams();
      if (activeClientId) params.set('client_id', activeClientId);
      if (activeSubProfile) params.set('sub_profile', activeSubProfile);
      window.location.href = `/hub/api/export/${section}?${params}`;
    }
  </script>
</body>

</html>